{
  "name": "Blog-to-Video Autopilot (Google TTS + Drive)",
  "nodes": [
    {"parameters":{"httpMethod":"POST","path":"blog2video-gcloud","responseMode":"lastNode","options":{"responseData":"json"}},"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[160,240]},
    {"parameters":{"functionCode":"// Normalize input\nconst b = $json;\nconst source = b.url || b.docId || b.sheetRowId || '';\nreturn [{ json: { url: b.url || '', docId: b.docId || '', sheetRowId: b.sheetRowId || '', overrideTitle: b.overrideTitle || '', source_value: source } }];"},"id":"Normalize","name":"Normalize Input","type":"n8n-nodes-base.function","typeVersion":2,"position":[380,240]},
    {"parameters":{"dataType":"string","value1":"={{$json.url}}"},"id":"If URL","name":"Has URL?","type":"n8n-nodes-base.if","typeVersion":2,"position":[600,240]},
    {"parameters":{"dataType":"string","value1":"={{$items('Normalize Input')[0].json.docId}}"},"id":"If Doc","name":"Has Doc?","type":"n8n-nodes-base.if","typeVersion":2,"position":[600,420]},
    {"parameters":{"dataType":"string","value1":"={{$items('Normalize Input')[0].json.sheetRowId}}"},"id":"If Sheet","name":"Has Sheet Row?","type":"n8n-nodes-base.if","typeVersion":2,"position":[600,600]},
    {"parameters":{"url":"={{$json.url}}","responseFormat":"string","options":{"timeout":120000}},"id":"Fetch HTML","name":"Fetch HTML","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[820,160]},
    {"parameters":{"functionCode":"// crude readability-like strip\nconst html = $json.body || $json || '';\nconst cleaned = String(html).replace(/<script[\\s\\S]*?<\\/script>/gi,'').replace(/<style[\\s\\S]*?<\\/style>/gi,'').replace(/<[^>]+>/g,' ').replace(/\\s+/g,' ').trim();\nreturn [{ json: { source_text: cleaned.slice(0,18000) } }];"},"id":"HTML→Text","name":"Extract Main Text","type":"n8n-nodes-base.function","typeVersion":2,"position":[1040,160]},
    {"parameters":{"method":"GET","url":"=https://www.googleapis.com/drive/v3/files/{{$items('Normalize Input')[0].json.docId}}/export?mimeType=text/plain","responseFormat":"string","options":{"sendHeaders":true}},"id":"Doc Export","name":"Drive Export Doc (txt)","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[820,420],"credentials":{"googleOAuth2Api":{"id":"google_oauth_placeholder","name":"Google OAuth2"}}},
    {"parameters":{"functionCode":"return [{ json: { source_text: String($json.body||$json||'').slice(0,18000) } }];"},"id":"Doc→Text","name":"Doc → Text","type":"n8n-nodes-base.function","typeVersion":2,"position":[1040,420]},
    {"parameters":{"operation":"read","sheetId":"={{$env.GSHEET_ID}}","range":"={{($env.GSHEET_INPUT_TAB || 'Input') + '!A' + $items('Normalize Input')[0].json.sheetRowId + ':Z' + $items('Normalize Input')[0].json.sheetRowId}}","options":{"valueRenderMode":"UNFORMATTED_VALUE"}},"id":"Read Row","name":"Read Sheet Row","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[820,600],"credentials":{"googleApi":{"id":"google_sheets_credential_placeholder","name":"Google Sheets"}}},
    {"parameters":{"functionCode":"// flatten row cells to text\nconst row = $json || {};\nconst cells = Object.values(row);\nconst text = cells.filter(v=>v!=null && String(v).trim()).join('. ');\nreturn [{ json: { source_text: String(text).slice(0,18000) } }];"},"id":"Row→Text","name":"Sheet Row → Text","type":"n8n-nodes-base.function","typeVersion":2,"position":[1040,600]},
    {"parameters":{"mode":"wait","output":"input1"},"id":"Merge Source","name":"Merge Source Text","type":"n8n-nodes-base.merge","typeVersion":2,"position":[1260,360]},
    {"parameters":{"operation":"chat","options":{"responseFormat":"jsonObject","systemMessage":"You write tight, factual narration for 90–150 seconds. Return JSON only.","temperature":0.5},"messages":{"message":[{"text":"Produce JSON with: {narration, overlays: [6–10 short lines], yt_title, yt_description, yt_tags[] }.\n\nSource text: {{$json.source_text}}","type":"user"}]}},"id":"OpenAI","name":"OpenAI Draft","type":"n8n-nodes-base.openAi","typeVersion":4,"position":[1480,360],"credentials":{"openAiApi":{"id":"openai_credential_placeholder","name":"OpenAI API"}}},
    {"parameters":{"functionCode":"// Estimate duration from words (~2.5 w/s)\nconst draft = $json;\nconst words = String(draft.narration||'').split(/\\s+/).filter(Boolean).length;\nconst seconds = Math.max(90, Math.min(150, Math.round(words/2.5)));\nreturn [{ json: { draft, durationSec: seconds } }];"},"id":"Estimate","name":"Estimate Duration","type":"n8n-nodes-base.function","typeVersion":2,"position":[1700,360]},
    {"parameters":{"text":"={{$json.draft.narration}}","audioEncoding":"MP3","voiceName":"en-US-Neural2-C","speakingRate":1.03},"id":"TTS","name":"Google TTS → MP3","type":"n8n-nodes-base.googleCloudTextToSpeech","typeVersion":1,"position":[1920,360],"credentials":{"googleCloudApi":{"id":"google_tts_credential_placeholder","name":"Google Cloud"}}},
    {"parameters":{"functionCode":"const b64 = $json.audioContent || $json.data || ''; if(!b64) throw new Error('No audioContent from TTS'); const buf = Buffer.from(b64,'base64'); return [{ json: { durationSec: $items('Estimate Duration')[0].json.durationSec, draft: $items('Estimate Duration')[0].json.draft }, binary: { audio: { data: buf, fileName: 'voice.mp3', mimeType: 'audio/mpeg' } } }];"},"id":"B64→Bin","name":"Base64 → Binary","type":"n8n-nodes-base.function","typeVersion":2,"position":[2140,360]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{($items('Estimate Duration')[0].json.draft.yt_title || 'voice') + '.mp3'}}","propertyName":"audio","options":{"parents":"={{$env.DRIVE_AUDIO_FOLDER || '/autopilot/audio/'}}"}},"id":"Upload Audio","name":"Drive Upload (audio)","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2360,360],"credentials":{"googleApi":{"id":"google_drive_credential_placeholder","name":"Google Drive"}}},
    {"parameters":{"functionCode":"const fid = $json.id;\nconst audioUrl = `https://drive.google.com/uc?export=download&id=${fid}`;\nconst draft = $items('Estimate Duration')[0].json.draft;\nconst total = $items('Estimate Duration')[0].json.durationSec;\nconst lines = (draft.overlays||[]).slice(0,10);\nconst n = Math.max(6, Math.min(10, lines.length||6));\nconst slot = Math.max(8, Math.round(total/n));\nlet t = Math.max(0.5, Math.round(slot*0.5));\nconst overlays = [];\nfor(let i=0;i<n;i++){ const remaining = total - t; const len = Math.max(2, Math.min(slot, remaining-0.5)); overlays.push({ text: String(lines[i]||'').slice(0,80), start: t, len }); t += slot; }\nreturn [{ json: { audioUrl, overlays, total, yt_title: draft.yt_title, yt_description: draft.yt_description, yt_tags: draft.yt_tags, source_value: $items('Normalize Input')[0].json.source_value } }];"},"id":"Timings","name":"Build Audio URL + Timings","type":"n8n-nodes-base.function","typeVersion":2,"position":[2580,360]},
    {"parameters":{"functionCode":"const overlays = $json.overlays; const total = $json.total; const audioUrl = $json.audioUrl;\nfunction clipHtml(t,s,l){ return { asset:{ type:'html', html:`<div style=\\\"font-family:Inter,Arial,sans-serif;font-size:48px;line-height:1.15;color:#E8EBFF;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:0 108px;text-align:center;max-width:70%;margin:0 auto;\\\">${String(t).replace(/\"/g,'&quot;')}</div>` }, start:s, length:l, transition:{ in:'fade', out:'fade' } }; }\nconst trackBg=[{ asset:{ type:'html', html:"<div style='width:100%;height:100%;background: radial-gradient(80% 80% at 50% 50%, #182032 0%, #0B0F19 100%);'></div>" }, start:0, length: total, fit:'cover', transition:{ in:'fade', out:'fade' } }];\nconst trackText = overlays.map(o=>clipHtml(o.text,o.start,o.len));\nconst trackAudio=[{ asset:{ type:'audio', src: audioUrl }, start:0, length: total, volume:1.0 }];\nreturn [{ json: { timeline:{ background:'#0B0F19', tracks:[ { clips: trackBg }, { clips: trackText }, { clips: trackAudio } ] }, output:{ format:'mp4', resolution:'1080x1920', fps:30, repeat:false } } }];"},"id":"Build Payload","name":"Build Shotstack JSON","type":"n8n-nodes-base.function","typeVersion":2,"position":[2800,360]},
    {"parameters":{"method":"POST","url":"https://api.shotstack.io/v1/render","jsonParameters":true,"options":{"headers":{"x-api-key":"={{$env.SHOTSTACK_API_KEY}}","content-type":"application/json"},"timeout":180000},"bodyParametersJson":"={{$json}}"},"id":"Render","name":"Shotstack Render","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[3020,360]},
    {"parameters":{"functionCode":"const id = $json.response?.id || $json.id; return [{ json: { render_id: id } }];"},"id":"Render ID","name":"Get Render ID","type":"n8n-nodes-base.function","typeVersion":2,"position":[3240,360]},
    {"parameters":{"functionCode":"const http = this.helpers.request; const id = $json.render_id; const apiKey = $env.SHOTSTACK_API_KEY; const wait = ms=>new Promise(r=>setTimeout(r,ms)); async function poll(){ for(let i=0;i<90;i++){ const res = await http({ method:'GET', url:`https://api.shotstack.io/v1/render/${id}`, headers:{ 'x-api-key': apiKey }}); const status = res.response?.status || res.status; if(status==='done') return res; if(status==='failed') throw new Error('Render failed'); await wait(10000);} throw new Error('Timeout after 15 minutes'); } return poll().then(d=>[{ json: d }]);"},"id":"Poll","name":"Poll Render (≤15m)","type":"n8n-nodes-base.function","typeVersion":2,"position":[3460,360]},
    {"parameters":{"url":"={{$json.response?.url || $json.url}}","responseFormat":"file","options":{"timeout":240000}},"id":"Download","name":"Download MP4","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[3680,360]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{$items('Build Audio URL + Timings')[0].json.yt_title || 'video'}}.mp4","propertyName":"data","options":{"parents":"={{$env.DRIVE_RENDERS_FOLDER || '/autopilot/renders/'}}"}},"id":"Upload Video","name":"Drive Upload (video)","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[3900,360],"credentials":{"googleApi":{"id":"google_drive_credential_placeholder","name":"Google Drive"}}},
    {"parameters":{"operation":"lookup","sheetId":"={{$env.GSHEET_ID}}","range":"Log!A:F","keyRow":1,"lookupColumn":"source","lookupValue":"={{$items('Normalize Input')[0].json.source_value}}","returnAllMatches":false},"id":"Lookup","name":"Lookup Existing (Log)","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[1480,560],"credentials":{"googleApi":{"id":"google_sheets_credential_placeholder","name":"Google Sheets"}}},
    {"parameters":{"functionCode":"const exists = $items('Lookup Existing (Log)').length > 0;\nconst existing = exists ? $items('Lookup Existing (Log)')[0].json : null;\nreturn [{ json: { exists, existing } }];"},"id":"Check","name":"Check Existing","type":"n8n-nodes-base.function","typeVersion":2,"position":[4120,240]},
    {"parameters":{"conditions":{"boolean":[{"value1":"={{$json.exists}}"}]}},"id":"If Exists","name":"If Existing","type":"n8n-nodes-base.if","typeVersion":2,"position":[4340,240]},
    {"parameters":{"operation":"update","sheetId":"={{$env.GSHEET_ID}}","range":"Log!A:F","keyRow":1,"options":{"useHeaderRow":true},"value":"={{ { timestamp: new Date().toISOString(), source: $items('Normalize Input')[0].json.source_value, render_id: $items('Get Render ID')[0].json.render_id, mp4_url: $items('Poll Render (≤15m)')[0].json.response.url, youtube_url: $items('Lookup Existing (Log)')[0].json.youtube_url || '', duration_sec: $items('Estimate Duration')[0].json.durationSec } }}","key":"={{$items('Normalize Input')[0].json.source_value}}","keyColumn":"source"},"id":"Update Row","name":"Update Sheet Row","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[4560,180],"credentials":{"googleApi":{"id":"google_sheets_credential_placeholder","name":"Google Sheets"}}},
    {"parameters":{"operation":"upload","binaryData":true,"videoOperation":"upload","binaryProperty":"data","additionalFields":{"title":"={{$items('Build Audio URL + Timings')[0].json.yt_title}}","description":"={{$items('Build Audio URL + Timings')[0].json.yt_description}}","privacyStatus":"={{$env.YOUTUBE_PRIVACY_STATUS || 'unlisted'}}","categoryId":"27","tags":"={{($items('Build Audio URL + Timings')[0].json.yt_tags || []).join(',')}}"}},"id":"YouTube","name":"YouTube Upload","type":"n8n-nodes-base.youtube","typeVersion":2,"position":[4560,320],"credentials":{"youTubeOAuth2Api":{"id":"youtube_oauth_placeholder","name":"YouTube OAuth"}}},
    {"parameters":{"operation":"append","sheetId":"={{$env.GSHEET_ID}}","range":"Log!A:F","options":{"useHeaderRow":true,"valueInputMode":"RAW"},"keyRow":1,"value":"={{ { timestamp: new Date().toISOString(), source: $items('Normalize Input')[0].json.source_value, render_id: $items('Get Render ID')[0].json.render_id, mp4_url: $items('Poll Render (≤15m)')[0].json.response.url, youtube_url: $items('YouTube Upload')[0].json.id ? ('https://youtu.be/' + $items('YouTube Upload')[0].json.id) : '', duration_sec: $items('Estimate Duration')[0].json.durationSec } }}"},"id":"Append","name":"Append Google Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[4780,320],"credentials":{"googleApi":{"id":"google_sheets_credential_placeholder","name":"Google Sheets"}}}
  ],
  "connections": {
    "Webhook": {"main":[[{"node":"Normalize Input","type":"main","index":0}]]},
    "Normalize Input": {"main":[[{"node":"Has URL?","type":"main","index":0},{"node":"Has Doc?","type":"main","index":0},{"node":"Has Sheet Row?","type":"main","index":0},{"node":"Lookup Existing (Log)","type":"main","index":0}]]},
    "Has URL?": {"main":[[{"node":"Fetch HTML","type":"main","index":0}],[]]},
    "Fetch HTML": {"main":[[{"node":"Extract Main Text","type":"main","index":0}]]},
    "Extract Main Text": {"main":[[{"node":"Merge Source Text","type":"main","index":0}]]},
    "Has Doc?": {"main":[[],[{"node":"Drive Export Doc (txt)","type":"main","index":0}]]},
    "Drive Export Doc (txt)": {"main":[[{"node":"Doc → Text","type":"main","index":0}]]},
    "Doc → Text": {"main":[[{"node":"Merge Source Text","type":"main","index":0}]]},
    "Has Sheet Row?": {"main":[[],[{"node":"Read Sheet Row","type":"main","index":0}]]},
    "Read Sheet Row": {"main":[[{"node":"Sheet Row → Text","type":"main","index":0}]]},
    "Sheet Row → Text": {"main":[[{"node":"Merge Source Text","type":"main","index":0}]]},
    "Merge Source Text": {"main":[[{"node":"OpenAI Draft","type":"main","index":0}]]},
    "OpenAI Draft": {"main":[[{"node":"Estimate Duration","type":"main","index":0}]]},
    "Estimate Duration": {"main":[[{"node":"Google TTS → MP3","type":"main","index":0}]]},
    "Google TTS → MP3": {"main":[[{"node":"Base64 → Binary","type":"main","index":0}]]},
    "Base64 → Binary": {"main":[[{"node":"Drive Upload (audio)","type":"main","index":0}]]},
    "Drive Upload (audio)": {"main":[[{"node":"Build Audio URL + Timings","type":"main","index":0}]]},
    "Build Audio URL + Timings": {"main":[[{"node":"Build Shotstack JSON","type":"main","index":0}]]},
    "Build Shotstack JSON": {"main":[[{"node":"Shotstack Render","type":"main","index":0}]]},
    "Shotstack Render": {"main":[[{"node":"Get Render ID","type":"main","index":0}]]},
    "Get Render ID": {"main":[[{"node":"Poll Render (≤15m)","type":"main","index":0}]]},
    "Poll Render (≤15m)": {"main":[[{"node":"Download MP4","type":"main","index":0}]]},
    "Download MP4": {"main":[[{"node":"Drive Upload (video)","type":"main","index":0},{"node":"Check Existing","type":"main","index":0}]]},
    "Check Existing": {"main":[[{"node":"If Existing","type":"main","index":0}]]},
    "If Existing": {"main":[[{"node":"Update Sheet Row","type":"main","index":0}],[{"node":"YouTube Upload","type":"main","index":0}]]},
    "YouTube Upload": {"main":[[{"node":"Append Google Sheet","type":"main","index":0}]]}
  }
}
