{
  "name": "Topic Select → Dual Render + Thumbnail (Google TTS + Drive)",
  "nodes": [
    {"parameters":{"httpMethod":"POST","path":"topic-select-dual","responseMode":"responseNode"},"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[120,220]},
    {"parameters":{"functionCode":"const t=$json.topic||$json||{}; const title=t.yt_title||t.title||'topic'; const trackingId=(Date.now().toString(36)+Math.random().toString(36).slice(2,8)); return [{ json: { ok:true, trackingId, workflow:'topic-select-dual', received:{ title } } }];"},"id":"ACK","name":"Build ACK","type":"n8n-nodes-base.function","typeVersion":2,"position":[200,100]},
    {"parameters":{"responseCode":202},"id":"Respond","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[420,100]},
    {"parameters":{"functionCode":"// Normalize/validate topic object\nconst t=$json||{};\nif(!Array.isArray(t.yt_tags)) t.yt_tags=[];\nif(!Array.isArray(t.keywords)) t.keywords=[];\nif(!Array.isArray(t.outline)) t.outline=[];\nif(!t.yt_title && t.title) t.yt_title=t.title;\nreturn [{json:{topic:t}}];"},"id":"Normalize","name":"Validate Topic","type":"n8n-nodes-base.function","typeVersion":2,"position":[340,220]},
    {"parameters":{"operation":"chat","options":{"responseFormat":"jsonObject","systemMessage":"You write tight, factual narration for 90–150 seconds. Return JSON only.","temperature":0.5},"messages":{"message":[{"text":"Create a concise script from this topic. Return JSON with keys: narration (90-150s), overlays (6-10 short lines), yt_title, yt_description, yt_tags.\n\nTopic JSON: {{$json.topic}}","type":"user"}]}},"id":"OpenAI","name":"Draft From Topic","type":"n8n-nodes-base.openAi","typeVersion":4,"position":[560,220]},
    {"parameters":{"functionCode":"const d=$json;const words=String(d.narration||'').split(/\\s+/).filter(Boolean).length;const seconds=Math.max(90,Math.min(150,Math.round(words/2.5)));return [{json:{draft:d, durationSec:seconds}}];"},"id":"Estimate","name":"Estimate Duration","type":"n8n-nodes-base.function","typeVersion":2,"position":[780,220]},
    {"parameters":{"text":"={{$json.draft.narration}}","audioEncoding":"MP3","voiceName":"en-US-Neural2-C","speakingRate":1.03},"id":"TTS","name":"Google TTS -> MP3","type":"n8n-nodes-base.googleCloudTextToSpeech","typeVersion":1,"position":[1000,220]},
    {"parameters":{"functionCode":"const b64=$json.audioContent||$json.data||'';if(!b64) throw new Error('No audioContent');const buf=Buffer.from(b64,'base64');return [{json:{draft:$items('Estimate Duration')[0].json.draft,durationSec:$items('Estimate Duration')[0].json.durationSec},binary:{audio:{data:buf,fileName:'voice.mp3',mimeType:'audio/mpeg'}}}];"},"id":"B64->Bin","name":"Base64 -> Binary","type":"n8n-nodes-base.function","typeVersion":2,"position":[1220,220]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{($items('Draft From Topic')[0].json.yt_title || 'voice') + '.mp3'}}","propertyName":"audio","options":{"parents":"={{$env.DRIVE_AUDIO_FOLDER || '/autopilot/audio/'}}"}},"id":"Upload Audio","name":"Drive Upload (audio)","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[1440,220]},
    {"parameters":{"functionCode":"const fid=$json.id;const audioUrl=`https://drive.google.com/uc?export=download&id=${fid}`;const d=$items('Estimate Duration')[0].json.draft;const total=$items('Estimate Duration')[0].json.durationSec;const lines=(d.overlays||[]).slice(0,10);const n=Math.max(6,Math.min(10,lines.length||6));const slot=Math.max(8,Math.round(total/n));let t=Math.max(0.5,Math.round(slot*0.5));const overlays=[];for(let i=0;i<n;i++){const remaining=total-t;const len=Math.max(2,Math.min(slot,remaining-0.5));overlays.push({text:String(lines[i]||'').slice(0,80),start:t,len});t+=slot;}return [{json:{audioUrl,overlays,total,yt_title:d.yt_title,yt_description:d.yt_description,yt_tags:d.yt_tags}}];"},"id":"Timings","name":"Build Audio URL + Timings","type":"n8n-nodes-base.function","typeVersion":2,"position":[1660,220]},
    {"parameters":{"functionCode":"const o=$json.overlays;const total=$json.total;const audioUrl=$json.audioUrl;function clip(t,s,l){return {asset:{type:'html',html:`<div style=\\\"font-family:Inter,Arial,sans-serif;font-size:48px;line-height:1.15;color:#E8EBFF;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:0 108px;text-align:center;max-width:70%;margin:0 auto;\\\">${String(t).replace(/\"/g,'&quot;')}</div>`},start:s,length:l,transition:{in:'fade',out:'fade'}};}const bg=[{asset:{type:'html',html:"<div style='width:100%;height:100%;background: radial-gradient(80% 80% at 50% 50%, #182032 0%, #0B0F19 100%);'></div>"},start:0,length:total,fit:'cover',transition:{in:'fade',out:'fade'}}];const text=o.map(x=>clip(x.text,x.start,x.len));const aud=[{asset:{type:'audio',src:audioUrl},start:0,length:total,volume:1.0}];return [{json:{timeline:{background:'#0B0F19',tracks:[{clips:bg},{clips:text},{clips:aud}]},output:{format:'mp4',resolution:'1080x1920',fps:30,repeat:false}}}];"},"id":"Build V","name":"Build Payload (Vertical)","type":"n8n-nodes-base.function","typeVersion":2,"position":[1880,140]},
    {"parameters":{"functionCode":"const o=$json.overlays;const total=$json.total;const audioUrl=$json.audioUrl;function clip(t,s,l){return {asset:{type:'html',html:`<div style=\\\"font-family:Inter,Arial,sans-serif;font-size:38px;line-height:1.15;color:#E8EBFF;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:0 160px;text-align:center;max-width:80%;margin:0 auto;\\\">${String(t).replace(/\"/g,'&quot;')}</div>`},start:s,length:l,transition:{in:'fade',out:'fade'}};}const bg=[{asset:{type:'html',html:"<div style='width:100%;height:100%;background: radial-gradient(80% 80% at 50% 50%, #182032 0%, #0B0F19 100%);'></div>"},start:0,length:total,fit:'cover',transition:{in:'fade',out:'fade'}}];const text=o.map(x=>clip(x.text,x.start,x.len));const aud=[{asset:{type:'audio',src:audioUrl},start:0,length:total,volume:1.0}];return [{json:{timeline:{background:'#0B0F19',tracks:[{clips:bg},{clips:text},{clips:aud}]},output:{format:'mp4',resolution:'1920x1080',fps:30,repeat:false}}}];"},"id":"Build W","name":"Build Payload (Wide)","type":"n8n-nodes-base.function","typeVersion":2,"position":[1880,300]},
    {"parameters":{"method":"POST","url":"https://api.shotstack.io/v1/render","jsonParameters":true,"options":{"headers":{"x-api-key":"={{$env.SHOTSTACK_API_KEY}}","content-type":"application/json"}},"bodyParametersJson":"={{$json}}"},"id":"Render V","name":"Render Vertical","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2100,140]},
    {"parameters":{"method":"POST","url":"https://api.shotstack.io/v1/render","jsonParameters":true,"options":{"headers":{"x-api-key":"={{$env.SHOTSTACK_API_KEY}}","content-type":"application/json"}},"bodyParametersJson":"={{$json}}"},"id":"Render W","name":"Render Wide","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2100,300]},
    {"parameters":{"functionCode":"const id=$json.response?.id || $json.id;return [{json:{render_id:id}}];"},"id":"RID V","name":"Get RID V","type":"n8n-nodes-base.function","typeVersion":2,"position":[2320,140]},
    {"parameters":{"functionCode":"const id=$json.response?.id || $json.id;return [{json:{render_id:id}}];"},"id":"RID W","name":"Get RID W","type":"n8n-nodes-base.function","typeVersion":2,"position":[2320,300]},
    {"parameters":{"functionCode":"const http=this.helpers.request;const id=$json.render_id;const key=$env.SHOTSTACK_API_KEY;const wait=ms=>new Promise(r=>setTimeout(r,ms));async function poll(){for(let i=0;i<90;i++){const res=await http({method:'GET',url:`https://api.shotstack.io/v1/render/${id}`,headers:{'x-api-key':key}});const st=res.response?.status||res.status;if(st==='done')return res;if(st==='failed')throw new Error('Render failed');await wait(10000);}throw new Error('Timeout 15m');}return poll().then(d=>[{json:d}]);"},"id":"Poll V","name":"Poll V","type":"n8n-nodes-base.function","typeVersion":2,"position":[2540,140]},
    {"parameters":{"functionCode":"const http=this.helpers.request;const id=$json.render_id;const key=$env.SHOTSTACK_API_KEY;const wait=ms=>new Promise(r=>setTimeout(r,ms));async function poll(){for(let i=0;i<90;i++){const res=await http({method:'GET',url:`https://api.shotstack.io/v1/render/${id}`,headers:{'x-api-key':key}});const st=res.response?.status||res.status;if(st==='done')return res;if(st==='failed')throw new Error('Render failed');await wait(10000);}throw new Error('Timeout 15m');}return poll().then(d=>[{json:d}]);"},"id":"Poll W","name":"Poll W","type":"n8n-nodes-base.function","typeVersion":2,"position":[2540,300]},
    {"parameters":{"url":"={{$json.response?.url || $json.url}}","responseFormat":"file"},"id":"DL V","name":"Download V","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2760,140]},
    {"parameters":{"url":"={{$json.response?.url || $json.url}}","responseFormat":"file"},"id":"DL W","name":"Download W","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2760,300]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{$items('Build Payload (Vertical)')[0].json.yt_title || 'shorts'}}.mp4","propertyName":"data","options":{"parents":"={{$env.DRIVE_RENDERS_FOLDER || '/autopilot/renders/'}}"}},"id":"Upload V","name":"Drive Upload V","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2980,140]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{$items('Build Payload (Wide)')[0].json.yt_title || 'wide'}}.mp4","propertyName":"data","options":{"parents":"={{$env.DRIVE_RENDERS_FOLDER || '/autopilot/renders/'}}"}},"id":"Upload W","name":"Drive Upload W","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2980,300]},
    {"parameters":{"functionCode":"const t=$items('Draft From Topic')[0].json.yt_title||'Video';const html=`<div style='width:1280px;height:720px;background: radial-gradient(65% 65% at 50% 40%, #182032 0%, #0B0F19 100%);position:relative;display:flex;align-items:center;justify-content:center;'><div style=\"font:800 74px Inter,Arial;color:#E8EBFF;max-width:1000px;text-align:center;line-height:1.08;text-shadow:0 3px 12px rgba(0,0,0,.45)\">${t.replace(/"/g,'&quot;')}</div></div>`;return [{json:{html}}];"},"id":"Thumb HTML","name":"Build Thumb HTML","type":"n8n-nodes-base.function","typeVersion":2,"position":[1880,460]},
    {"parameters":{"method":"POST","url":"https://api.shotstack.io/v1/render","jsonParameters":true,"options":{"headers":{"x-api-key":"={{$env.SHOTSTACK_API_KEY}}","content-type":"application/json"}},"bodyParametersJson":"={\"timeline\":{\"tracks\":[{\"clips\":[{\"asset\":{\"type\":\"html\",\"html\":\"{{$json.html}}\"},\"start\":0,\"length\":2}] } ]},\"output\":{\"format\":\"jpg\",\"resolution\":\"1280x720\",\"fps\":1,\"repeat\":false}}"},"id":"Render Thumb","name":"Render Thumbnail","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2100,460]},
    {"parameters":{"functionCode":"const id=$json.response?.id || $json.id;return [{json:{render_id:id}}];"},"id":"RID T","name":"Get RID Thumb","type":"n8n-nodes-base.function","typeVersion":2,"position":[2320,460]},
    {"parameters":{"functionCode":"const http=this.helpers.request;const id=$json.render_id;const key=$env.SHOTSTACK_API_KEY;const wait=ms=>new Promise(r=>setTimeout(r,ms));async function poll(){for(let i=0;i<45;i++){const res=await http({method:'GET',url:`https://api.shotstack.io/v1/render/${id}`,headers:{'x-api-key':key}});const st=res.response?.status||res.status;if(st==='done')return res;if(st==='failed')throw new Error('Render failed');await wait(10000);}throw new Error('Timeout 7.5m');}return poll().then(d=>[{json:d}]);"},"id":"Poll T","name":"Poll Thumb","type":"n8n-nodes-base.function","typeVersion":2,"position":[2540,460]},
    {"parameters":{"url":"={{$json.response?.url || $json.url}}","responseFormat":"file"},"id":"DL T","name":"Download Thumb","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2760,460]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{($items('Draft From Topic')[0].json.yt_title || 'thumb') + '.jpg'}}","propertyName":"data","options":{"parents":"={{$env.DRIVE_RENDERS_FOLDER || '/autopilot/renders/'}}"}},"id":"Upload T","name":"Drive Upload Thumb","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2980,460]},
    {"parameters":{"operation":"upload","binaryData":true,"videoOperation":"upload","binaryProperty":"data","additionalFields":{"title":"={{$items('Build Audio URL + Timings')[0].json.yt_title}}","description":"={{$items('Build Audio URL + Timings')[0].json.yt_description}}","privacyStatus":"={{$env.YOUTUBE_PRIVACY_STATUS || 'unlisted'}}","categoryId":"27","tags":"={{($items('Build Audio URL + Timings')[0].json.yt_tags || []).join(',')}}"}},"id":"YouTube","name":"YouTube Upload (Vertical)","type":"n8n-nodes-base.youtube","typeVersion":2,"position":[3200,140]},
    {"parameters":{"method":"POST","url":"=https://www.googleapis.com/upload/youtube/v3/thumbnails/set?videoId={{$json.id}}","options":{"bodyContentType":"form-data"}},"id":"YT Thumb","name":"YouTube Set Thumbnail (HTTP)","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[3420,220]},
    {"parameters":{"functionCode":"return [{json:{vertical:$items('Drive Upload V')[0].json, wide:$items('Drive Upload W')[0].json, thumb:$items('Drive Upload Thumb')[0].json, youtube:$items('YouTube Upload (Vertical)')[0].json}}];"},"id":"Pack","name":"Pack Result","type":"n8n-nodes-base.function","typeVersion":2,"position":[3640,220]}
  ],
  "connections": {
    "Webhook": {"main":[[{"node":"Normalize","type":"main","index":0},{"node":"Build ACK","type":"main","index":0}]]},
    "Build ACK": {"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},
    "Normalize": {"main":[[{"node":"Draft From Topic","type":"main","index":0}]]},
    "Draft From Topic": {"main":[[{"node":"Estimate Duration","type":"main","index":0}]]},
    "Estimate Duration": {"main":[[{"node":"Google TTS -> MP3","type":"main","index":0}]]},
    "Google TTS -> MP3": {"main":[[{"node":"Base64 -> Binary","type":"main","index":0}]]},
    "Base64 -> Binary": {"main":[[{"node":"Drive Upload (audio)","type":"main","index":0}]]},
    "Drive Upload (audio)": {"main":[[{"node":"Build Audio URL + Timings","type":"main","index":0}]]},
    "Build Audio URL + Timings": {"main":[[{"node":"Build Payload (Vertical)","type":"main","index":0},{"node":"Build Payload (Wide)","type":"main","index":0},{"node":"Build Thumb HTML","type":"main","index":0}]]},
    "Build Payload (Vertical)": {"main":[[{"node":"Render Vertical","type":"main","index":0}]]},
    "Build Payload (Wide)": {"main":[[{"node":"Render Wide","type":"main","index":0}]]},
    "Render Vertical": {"main":[[{"node":"Get RID V","type":"main","index":0}]]},
    "Render Wide": {"main":[[{"node":"Get RID W","type":"main","index":0}]]},
    "Get RID V": {"main":[[{"node":"Poll V","type":"main","index":0}]]},
    "Get RID W": {"main":[[{"node":"Poll W","type":"main","index":0}]]},
    "Poll V": {"main":[[{"node":"Download V","type":"main","index":0}]]},
    "Poll W": {"main":[[{"node":"Download W","type":"main","index":0}]]},
    "Download V": {"main":[[{"node":"Drive Upload V","type":"main","index":0},{"node":"YouTube Upload (Vertical)","type":"main","index":0}]]},
    "Download W": {"main":[[{"node":"Drive Upload W","type":"main","index":0}]]},
    "Build Thumb HTML": {"main":[[{"node":"Render Thumbnail","type":"main","index":0}]]},
    "Render Thumbnail": {"main":[[{"node":"Get RID Thumb","type":"main","index":0}]]},
    "Get RID Thumb": {"main":[[{"node":"Poll Thumb","type":"main","index":0}]]},
    "Poll Thumb": {"main":[[{"node":"Download Thumb","type":"main","index":0}]]},
    "Download Thumb": {"main":[[{"node":"Drive Upload Thumb","type":"main","index":0},{"node":"YouTube Set Thumbnail (HTTP)","type":"main","index":0}]]},
    "YouTube Upload (Vertical)": {"main":[[{"node":"YouTube Set Thumbnail (HTTP)","type":"main","index":0},{"node":"Pack Result","type":"main","index":0}]]}
  }
}
