{
  "name": "Topic Select → Video (Google TTS + Drive)",
  "nodes": [
    {"parameters":{"httpMethod":"POST","path":"topic-select","responseMode":"lastNode","options":{"responseData":"json"}},"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[160,200]},
    {"parameters":{"functionCode":"// Normalize/validate topic\nconst t=$json||{};\nif(!Array.isArray(t.yt_tags)) t.yt_tags=[];\nif(!Array.isArray(t.keywords)) t.keywords=[];\nif(!Array.isArray(t.outline)) t.outline=[];\nif(!t.yt_title && t.title) t.yt_title=t.title;\nreturn [{json:{topic:t}}];"},"id":"Normalize","name":"Validate Topic","type":"n8n-nodes-base.function","typeVersion":2,"position":[380,200]},
    {"parameters":{"operation":"chat","options":{"responseFormat":"jsonObject","systemMessage":"You write tight, factual narration for 90–150 seconds. Return JSON only.","temperature":0.5},"messages":{"message":[{"text":"Create a concise script from this topic. Return JSON with keys: narration (90-150s), overlays (6-10 lines), yt_title, yt_description, yt_tags.\n\nTopic JSON: {{$json.topic}}","type":"user"}]}},"id":"OpenAI","name":"Draft From Topic","type":"n8n-nodes-base.openAi","typeVersion":4,"position":[600,200],"credentials":{"openAiApi":{"id":"openai_credential_placeholder","name":"OpenAI"}}},
    {"parameters":{"functionCode":"const d=$json; const words=String(d.narration||'').split(/\\s+/).filter(Boolean).length; const seconds=Math.max(90, Math.min(150, Math.round(words/2.5))); return [{json:{draft:d, durationSec: seconds}}];"},"id":"Estimate","name":"Estimate Duration","type":"n8n-nodes-base.function","typeVersion":2,"position":[820,200]},
    {"parameters":{"text":"={{$json.draft.narration}}","audioEncoding":"MP3","voiceName":"en-US-Neural2-C","speakingRate":1.03},"id":"TTS","name":"Google TTS -> MP3","type":"n8n-nodes-base.googleCloudTextToSpeech","typeVersion":1,"position":[1040,200]},
    {"parameters":{"functionCode":"const b64=$json.audioContent||$json.data||''; if(!b64) throw new Error('No audioContent'); const buf=Buffer.from(b64,'base64'); return [{ json: { draft: $items('Estimate Duration')[0].json.draft, durationSec: $items('Estimate Duration')[0].json.durationSec }, binary: { audio: { data: buf, fileName: 'voice.mp3', mimeType: 'audio/mpeg' } } }];"},"id":"B64->Bin","name":"Base64 -> Binary","type":"n8n-nodes-base.function","typeVersion":2,"position":[1260,200]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{($items('Draft From Topic')[0].json.yt_title || 'voice') + '.mp3'}}","propertyName":"audio","options":{"parents":"={{$env.DRIVE_AUDIO_FOLDER || '/autopilot/audio/'}}"}},"id":"Upload Audio","name":"Drive Upload (audio)","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[1480,200],"credentials":{"googleApi":{"id":"google_drive_credential_placeholder","name":"Google Drive"}}},
    {"parameters":{"functionCode":"const fid=$json.id;const audioUrl=`https://drive.google.com/uc?export=download&id=${fid}`;const d=$items('Estimate Duration')[0].json.draft;const total=$items('Estimate Duration')[0].json.durationSec;const lines=(d.overlays||[]).slice(0,10);const n=Math.max(6,Math.min(10,lines.length||6));const slot=Math.max(8,Math.round(total/n));let t=Math.max(0.5,Math.round(slot*0.5));const overlays=[];for(let i=0;i<n;i++){const remaining=total-t;const len=Math.max(2,Math.min(slot,remaining-0.5));overlays.push({text:String(lines[i]||'').slice(0,80),start:t,len});t+=slot;}return [{json:{audioUrl,overlays,total,yt_title:d.yt_title,yt_description:d.yt_description,yt_tags:d.yt_tags}}];"},"id":"Timings","name":"Build Audio URL + Timings","type":"n8n-nodes-base.function","typeVersion":2,"position":[1700,200]},
    {"parameters":{"functionCode":"const o=$json.overlays;const total=$json.total;const audioUrl=$json.audioUrl;function clip(t,s,l){return {asset:{type:'html',html:`<div style=\\\"font-family:Inter,Arial,sans-serif;font-size:48px;line-height:1.15;color:#E8EBFF;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:0 108px;text-align:center;max-width:70%;margin:0 auto;\\\">${String(t).replace(/\"/g,'&quot;')}</div>`},start:s,length:l,transition:{in:'fade',out:'fade'}};}const bg=[{asset:{type:'html',html:"<div style='width:100%;height:100%;background: radial-gradient(80% 80% at 50% 50%, #182032 0%, #0B0F19 100%);'></div>"},start:0,length:total,fit:'cover',transition:{in:'fade',out:'fade'}}];const text=o.map(x=>clip(x.text,x.start,x.len));const aud=[{asset:{type:'audio',src:audioUrl},start:0,length:total,volume:1.0}];return [{json:{timeline:{background:'#0B0F19',tracks:[{clips:bg},{clips:text},{clips:aud}]},output:{format:'mp4',resolution:'1080x1920',fps:30,repeat:false}}}];"},"id":"Build Payload","name":"Build Shotstack JSON","type":"n8n-nodes-base.function","typeVersion":2,"position":[1920,200]},
    {"parameters":{"method":"POST","url":"https://api.shotstack.io/v1/render","jsonParameters":true,"options":{"headers":{"x-api-key":"={{$env.SHOTSTACK_API_KEY}}","content-type":"application/json"}},"bodyParametersJson":"={{$json}}"},"id":"Render","name":"Shotstack Render","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2140,200]},
    {"parameters":{"functionCode":"const id=$json.response?.id || $json.id;return [{json:{render_id:id}}];"},"id":"RID","name":"Get Render ID","type":"n8n-nodes-base.function","typeVersion":2,"position":[2360,200]},
    {"parameters":{"functionCode":"const http=this.helpers.request;const id=$json.render_id;const key=$env.SHOTSTACK_API_KEY;const wait=ms=>new Promise(r=>setTimeout(r,ms));async function poll(){for(let i=0;i<90;i++){const res=await http({method:'GET',url:`https://api.shotstack.io/v1/render/${id}`,headers:{'x-api-key':key}});const st=res.response?.status||res.status;if(st==='done')return res;if(st==='failed')throw new Error('Render failed');await wait(10000);}throw new Error('Timeout 15m');}return poll().then(d=>[{json:d}]);"},"id":"Poll","name":"Poll Render","type":"n8n-nodes-base.function","typeVersion":2,"position":[2580,200]},
    {"parameters":{"url":"={{$json.response?.url || $json.url}}","responseFormat":"file"},"id":"Download","name":"Download MP4","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2800,200]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{$items('Build Audio URL + Timings')[0].json.yt_title || 'video'}}.mp4","propertyName":"data","options":{"parents":"={{$env.DRIVE_RENDERS_FOLDER || '/autopilot/renders/'}}"}},"id":"Upload Video","name":"Drive Upload (video)","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[3020,200]},
    {"parameters":{"operation":"upload","binaryData":true,"videoOperation":"upload","binaryProperty":"data","additionalFields":{"title":"={{$items('Build Audio URL + Timings')[0].json.yt_title}}","description":"={{$items('Build Audio URL + Timings')[0].json.yt_description}}","privacyStatus":"={{$env.YOUTUBE_PRIVACY_STATUS || 'unlisted'}}","categoryId":"27","tags":"={{($items('Build Audio URL + Timings')[0].json.yt_tags || []).join(',')}}"}},"id":"YouTube","name":"YouTube Upload","type":"n8n-nodes-base.youtube","typeVersion":2,"position":[3240,200]}
  ],
  "connections": {
    "Webhook": {"main":[[{"node":"Normalize","type":"main","index":0}]]},
    "Normalize": {"main":[[{"node":"Draft From Topic","type":"main","index":0}]]},
    "Draft From Topic": {"main":[[{"node":"Estimate Duration","type":"main","index":0}]]},
    "Estimate Duration": {"main":[[{"node":"Google TTS -> MP3","type":"main","index":0}]]},
    "Google TTS -> MP3": {"main":[[{"node":"Base64 -> Binary","type":"main","index":0}]]},
    "Base64 -> Binary": {"main":[[{"node":"Drive Upload (audio)","type":"main","index":0}]]},
    "Drive Upload (audio)": {"main":[[{"node":"Build Audio URL + Timings","type":"main","index":0}]]},
    "Build Audio URL + Timings": {"main":[[{"node":"Build Shotstack JSON","type":"main","index":0}]]},
    "Build Shotstack JSON": {"main":[[{"node":"Shotstack Render","type":"main","index":0}]]},
    "Shotstack Render": {"main":[[{"node":"Get Render ID","type":"main","index":0}]]},
    "Get Render ID": {"main":[[{"node":"Poll Render","type":"main","index":0}]]},
    "Poll Render": {"main":[[{"node":"Download MP4","type":"main","index":0}]]},
    "Download MP4": {"main":[[{"node":"Drive Upload (video)","type":"main","index":0},{"node":"YouTube Upload","type":"main","index":0}]]}
  }
}
