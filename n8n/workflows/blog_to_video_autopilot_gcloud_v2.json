{
  "name": "Blog-to-Video Autopilot (Google TTS + Drive + Probe + Captions)",
  "nodes": [
    {"parameters":{"httpMethod":"POST","path":"blog2video-gcloud-v2","responseMode":"lastNode","options":{"responseData":"json"}},"id":"Webhook","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[120,240]},
    {"parameters":{"functionCode":"const b=$json;const src=b.url||b.docId||b.sheetRowId||'';return [{json:{url:b.url||'',docId:b.docId||'',sheetRowId:b.sheetRowId||'',overrideTitle:b.overrideTitle||'',source_value:src}}];"},"id":"Normalize","name":"Normalize Input","type":"n8n-nodes-base.function","typeVersion":2,"position":[320,240]},
    {"parameters":{"dataType":"string","value1":"={{$json.url}}"},"id":"If URL","name":"Has URL?","type":"n8n-nodes-base.if","typeVersion":2,"position":[520,180]},
    {"parameters":{"dataType":"string","value1":"={{$items('Normalize Input')[0].json.docId}}"},"id":"If Doc","name":"Has Doc?","type":"n8n-nodes-base.if","typeVersion":2,"position":[520,300]},
    {"parameters":{"dataType":"string","value1":"={{$items('Normalize Input')[0].json.sheetRowId}}"},"id":"If Sheet","name":"Has Sheet Row?","type":"n8n-nodes-base.if","typeVersion":2,"position":[520,420]},
    {"parameters":{"url":"={{$json.url}}","responseFormat":"string","options":{"timeout":120000}},"id":"Fetch HTML","name":"Fetch HTML","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[720,120]},
    {"parameters":{"functionCode":"const html=$json.body||$json||'';const cleaned=String(html).replace(/<script[\\s\\S]*?<\\/script>/gi,'').replace(/<style[\\s\\S]*?<\\/style>/gi,'').replace(/<[^>]+>/g,' ').replace(/\\s+/g,' ').trim();return [{json:{source_text:cleaned.slice(0,18000)}}];"},"id":"HTML->Text","name":"Extract Main Text","type":"n8n-nodes-base.function","typeVersion":2,"position":[920,120]},
    {"parameters":{"method":"GET","url":"=https://www.googleapis.com/drive/v3/files/{{$items('Normalize Input')[0].json.docId}}/export?mimeType=text/plain","responseFormat":"string","options":{"sendHeaders":true}},"id":"Doc Export","name":"Drive Export Doc (txt)","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[720,300]},
    {"parameters":{"functionCode":"return [{json:{source_text:String($json.body||$json||'').slice(0,18000)}}];"},"id":"Doc->Text","name":"Doc -> Text","type":"n8n-nodes-base.function","typeVersion":2,"position":[920,300]},
    {"parameters":{"operation":"read","sheetId":"={{$env.GSHEET_ID}}","range":"={{($env.GSHEET_INPUT_TAB || 'Input') + '!A' + $items('Normalize Input')[0].json.sheetRowId + ':Z' + $items('Normalize Input')[0].json.sheetRowId}}","options":{"valueRenderMode":"UNFORMATTED_VALUE"}},"id":"Read Row","name":"Read Sheet Row","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[720,420]},
    {"parameters":{"functionCode":"const row=$json||{};const cells=Object.values(row);const text=cells.filter(v=>v!=null&&String(v).trim()).join('. ');return [{json:{source_text:String(text).slice(0,18000)}}];"},"id":"Row->Text","name":"Sheet Row -> Text","type":"n8n-nodes-base.function","typeVersion":2,"position":[920,420]},
    {"parameters":{"mode":"wait","output":"input1"},"id":"Merge Source","name":"Merge Source Text","type":"n8n-nodes-base.merge","typeVersion":2,"position":[1140,260]},
    {"parameters":{"operation":"chat","options":{"responseFormat":"jsonObject","systemMessage":"You write tight, factual narration for 90–150 seconds. Return JSON only.","temperature":0.5},"messages":{"message":[{"text":"Produce JSON with: {narration, overlays: [6–10 short lines], yt_title, yt_description, yt_tags[] }.\n\nSource text: {{$json.source_text}}","type":"user"}]}},"id":"OpenAI","name":"OpenAI Draft","type":"n8n-nodes-base.openAi","typeVersion":4,"position":[1360,260]},
    {"parameters":{"functionCode":"const draft=$json;const words=String(draft.narration||'').split(/\\s+/).filter(Boolean).length;const seconds=Math.max(90,Math.min(150,Math.round(words/2.5)));return [{json:{draft,estDurationSec:seconds}}];"},"id":"Estimate","name":"Estimate Duration","type":"n8n-nodes-base.function","typeVersion":2,"position":[1580,260]},
    {"parameters":{"text":"={{$json.draft.narration}}","audioEncoding":"MP3","voiceName":"en-US-Neural2-C","speakingRate":1.03},"id":"TTS","name":"Google TTS -> MP3","type":"n8n-nodes-base.googleCloudTextToSpeech","typeVersion":1,"position":[1800,260]},
    {"parameters":{"functionCode":"const b64=$json.audioContent||$json.data||'';if(!b64) throw new Error('No audioContent from TTS');const buf=Buffer.from(b64,'base64');return [{json:{draft:$items('Estimate Duration')[0].json.draft,estDurationSec:$items('Estimate Duration')[0].json.estDurationSec},binary:{audio:{data:buf,fileName:'voice.mp3',mimeType:'audio/mpeg'}}}];"},"id":"B64->Bin","name":"Base64 -> Binary","type":"n8n-nodes-base.function","typeVersion":2,"position":[2020,260]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{($items('Estimate Duration')[0].json.draft.yt_title || 'voice') + '.mp3'}}","propertyName":"audio","options":{"parents":"={{$env.DRIVE_AUDIO_FOLDER || '/autopilot/audio/'}}"}},"id":"Upload Audio","name":"Drive Upload (audio)","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2240,260]},
    {"parameters":{"url":"=https://drive.google.com/uc?export=download&id={{$json.id}}","responseFormat":"file","options":{"timeout":120000}},"id":"Download Audio","name":"Download Audio (for probe)","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[2460,260]},
    {"parameters":{"functionCode":"function synchsafeToInt(b){return ((b[0]&0x7f)<<21)|((b[1]&0x7f)<<14)|((b[2]&0x7f)<<7)|(b[3]&0x7f);}\nfunction bitrateFromHeader(v,bi){const t={V1:[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320],V2:[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160]};return (v===3?t.V1[bi]:t.V2[bi])||0;}\nconst bin=$binary.data.data;if(!bin){return [{json:{probeFailed:true}}];}let off=0;if(bin[0]===0x49&&bin[1]===0x44&&bin[2]===0x33){const size=synchsafeToInt([bin[6],bin[7],bin[8],bin[9]]);off=10+size;}for(let i=off;i<Math.min(off+4096,bin.length-4);i++){if(bin[i]===0xFF && (bin[i+1]&0xE0)===0xE0){const verBits=(bin[i+1]>>3)&0x03;const brIdx=(bin[i+2]>>4)&0x0F;const ver=verBits===3?3:2;const kbps=bitrateFromHeader(ver,brIdx);if(kbps>0){const bytes=bin.length-off;const sec=Math.max(1,Math.round((bytes*8)/(kbps*1000)));return [{json:{durationSec:sec,method:'mp3-probe'}}];}}}return [{json:{probeFailed:true}}];"},"id":"Probe","name":"Probe MP3 Duration","type":"n8n-nodes-base.function","typeVersion":2,"position":[2680,260]},
    {"parameters":{"functionCode":"const fid=$items('Upload Audio')[0].json.id;const audioUrl=`https://drive.google.com/uc?export=download&id=${fid}`;const draft=$items('Estimate Duration')[0].json.draft;const est=$items('Estimate Duration')[0].json.estDurationSec;const prob=$items('Probe MP3 Duration')[0]?.json?.durationSec;const total=prob||est;const lines=(draft.overlays||[]).slice(0,10);const n=Math.max(6,Math.min(10,lines.length||6));const slot=Math.max(8,Math.round(total/n));let t=Math.max(0.5,Math.round(slot*0.5));const overlays=[];for(let i=0;i<n;i++){const remain=total-t;const len=Math.max(2,Math.min(slot,remain-0.5));overlays.push({text:String(lines[i]||'').slice(0,80),start:t,len});t+=slot;}return [{json:{audioUrl,overlays,total,yt_title:draft.yt_title,yt_description:draft.yt_description,yt_tags:draft.yt_tags,source_value:$items('Normalize Input')[0].json.source_value}}];"},"id":"Timings","name":"Build Audio URL + Timings","type":"n8n-nodes-base.function","typeVersion":2,"position":[2900,260]},
    {"parameters":{"functionCode":"const o=$json.overlays;const total=$json.total;const audioUrl=$json.audioUrl;function clip(t,s,l){return {asset:{type:'html',html:`<div style=\\\"font-family:Inter,Arial,sans-serif;font-size:48px;line-height:1.15;color:#E8EBFF;text-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:0 108px;text-align:center;max-width:70%;margin:0 auto;\\\">${String(t).replace(/\"/g,'&quot;')}</div>`},start:s,length:l,transition:{in:'fade',out:'fade'}};}const bg=[{asset:{type:'html',html:"<div style='width:100%;height:100%;background: radial-gradient(80% 80% at 50% 50%, #182032 0%, #0B0F19 100%);'></div>"},start:0,length:total,fit:'cover',transition:{in:'fade',out:'fade'}}];const text=o.map(x=>clip(x.text,x.start,x.len));const aud=[{asset:{type:'audio',src:audioUrl},start:0,length:total,volume:1.0}];return [{json:{timeline:{background:'#0B0F19',tracks:[{clips:bg},{clips:text},{clips:aud}]},output:{format:'mp4',resolution:'1080x1920',fps:30,repeat:false}}}];"},"id":"Build Payload","name":"Build Shotstack JSON","type":"n8n-nodes-base.function","typeVersion":2,"position":[3120,260]},
    {"parameters":{"method":"POST","url":"https://api.shotstack.io/v1/render","jsonParameters":true,"options":{"headers":{"x-api-key":"={{$env.SHOTSTACK_API_KEY}}","content-type":"application/json"},"timeout":180000},"bodyParametersJson":"={{$json}}"},"id":"Render","name":"Shotstack Render","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[3340,260]},
    {"parameters":{"functionCode":"const id=$json.response?.id || $json.id;return [{json:{render_id:id}}];"},"id":"Render ID","name":"Get Render ID","type":"n8n-nodes-base.function","typeVersion":2,"position":[3560,260]},
    {"parameters":{"functionCode":"const http=this.helpers.request;const id=$json.render_id;const apiKey=$env.SHOTSTACK_API_KEY;const wait=ms=>new Promise(r=>setTimeout(r,ms));async function poll(){for(let i=0;i<90;i++){const res=await http({method:'GET',url:`https://api.shotstack.io/v1/render/${id}`,headers:{'x-api-key':apiKey}});const st=res.response?.status||res.status;if(st==='done')return res;if(st==='failed')throw new Error('Render failed');await wait(10000);}throw new Error('Timeout after 15 minutes');}return poll().then(d=>[{json:d}]);"},"id":"Poll","name":"Poll Render (≤15m)","type":"n8n-nodes-base.function","typeVersion":2,"position":[3780,260]},
    {"parameters":{"url":"={{$json.response?.url || $json.url}}","responseFormat":"file","options":{"timeout":240000}},"id":"Download","name":"Download MP4","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[4000,260]},
    {"parameters":{"operation":"upload","binaryData":true,"fileName":"={{$items('Timings')[0].json.yt_title || 'video'}}.mp4","propertyName":"data","options":{"parents":"={{$env.DRIVE_RENDERS_FOLDER || '/autopilot/renders/'}}"}},"id":"Upload Video","name":"Drive Upload (video)","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[4220,260]},
    {"parameters":{"operation":"lookup","sheetId":"={{$env.GSHEET_ID}}","range":"Log!A:F","keyRow":1,"lookupColumn":"source","lookupValue":"={{$items('Normalize Input')[0].json.source_value}}","returnAllMatches":false},"id":"Lookup","name":"Lookup Existing (Log)","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[1360,520]},
    {"parameters":{"functionCode":"const exists=$items('Lookup Existing (Log)').length>0;return [{json:{exists}}];"},"id":"Check","name":"Check Existing","type":"n8n-nodes-base.function","typeVersion":2,"position":[4440,140]},
    {"parameters":{"conditions":{"boolean":[{"value1":"={{$json.exists}}"}]}},"id":"If Exists","name":"If Existing","type":"n8n-nodes-base.if","typeVersion":2,"position":[4660,140]},
    {"parameters":{"operation":"update","sheetId":"={{$env.GSHEET_ID}}","range":"Log!A:F","keyRow":1,"options":{"useHeaderRow":true},"value":"={{ { timestamp: new Date().toISOString(), source: $items('Normalize Input')[0].json.source_value, render_id: $items('Render ID')[0].json.render_id, mp4_url: $items('Poll')[0].json.response.url, youtube_url: $items('Lookup Existing (Log)')[0].json.youtube_url || '', duration_sec: $items('Timings')[0].json.total } }}","key":"={{$items('Normalize Input')[0].json.source_value}}","keyColumn":"source"},"id":"Update Row","name":"Update Sheet Row","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[4880,80]},
    {"parameters":{"operation":"upload","binaryData":true,"videoOperation":"upload","binaryProperty":"data","additionalFields":{"title":"={{$items('Timings')[0].json.yt_title}}","description":"={{$items('Timings')[0].json.yt_description}}","privacyStatus":"={{$env.YOUTUBE_PRIVACY_STATUS || 'unlisted'}}","categoryId":"27","tags":"={{($items('Timings')[0].json.yt_tags || []).join(',')}}"}},"id":"YouTube","name":"YouTube Upload","type":"n8n-nodes-base.youtube","typeVersion":2,"position":[4880,240]},
    {"parameters":{"functionCode":"function ts(sec){const ms=Math.max(0,Math.floor(sec*1000));const h=String(Math.floor(ms/3600000)).padStart(2,'0');const m=String(Math.floor((ms%3600000)/60000)).padStart(2,'0');const s=String(Math.floor((ms%60000)/1000)).padStart(2,'0');const ms3=String(ms%1000).padStart(3,'0');return `${h}:${m}:${s},${ms3}`;}const draft=$items('OpenAI Draft')[0].json;const timing=$items('Timings')[0].json;const text=String(draft.narration||'');const words=text.split(/\\s+/).filter(Boolean);const seg=Math.min(6,Math.max(1,timing.overlays.length));const per=Math.ceil(words.length/seg);let srt='';let idx=1;for(let i=0;i<seg;i++){const start=timing.overlays[i].start;const len=timing.overlays[i].len;const end=start+len-0.25;const slice=words.slice(i*per,(i+1)*per).join(' ');if(!slice.trim()) continue;srt+=`${idx}\n${ts(start)} --> ${ts(end)}\n${slice.trim()}\n\n`;idx++;}const buf=Buffer.from(srt,'utf8');return [{json:{srt},binary:{captions:{data:buf,fileName:'captions.srt',mimeType:'application/x-subrip'}}}];"},"id":"Build SRT","name":"Build SRT","type":"n8n-nodes-base.function","typeVersion":2,"position":[5100,360]},
    {"parameters":{"method":"POST","url":"https://www.googleapis.com/upload/youtube/v3/captions?part=snippet&sync=true","options":{"bodyContentType":"form-data"}},"id":"Upload Captions","name":"YouTube Captions Upload (set OAuth)","type":"n8n-nodes-base.httpRequest","typeVersion":4,"position":[5320,360]},
    {"parameters":{"operation":"append","sheetId":"={{$env.GSHEET_ID}}","range":"Log!A:F","options":{"useHeaderRow":true,"valueInputMode":"RAW"},"keyRow":1,"value":"={{ { timestamp: new Date().toISOString(), source: $items('Normalize Input')[0].json.source_value, render_id: $items('Render ID')[0].json.render_id, mp4_url: $items('Poll')[0].json.response.url, youtube_url: $items('YouTube Upload')[0].json.id ? ('https://youtu.be/' + $items('YouTube Upload')[0].json.id) : '', duration_sec: $items('Timings')[0].json.total } }}"},"id":"Append","name":"Append Google Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":3,"position":[5540,240]}
  ],
  "connections": {
    "Webhook": {"main":[[{"node":"Normalize Input","type":"main","index":0}]]},
    "Normalize Input": {"main":[[{"node":"Has URL?","type":"main","index":0},{"node":"Has Doc?","type":"main","index":0},{"node":"Has Sheet Row?","type":"main","index":0},{"node":"Lookup Existing (Log)","type":"main","index":0}]]},
    "Has URL?": {"main":[[{"node":"Fetch HTML","type":"main","index":0}],[]]},
    "Fetch HTML": {"main":[[{"node":"Extract Main Text","type":"main","index":0}]]},
    "Extract Main Text": {"main":[[{"node":"Merge Source Text","type":"main","index":0}]]},
    "Has Doc?": {"main":[[],[{"node":"Drive Export Doc (txt)","type":"main","index":0}]]},
    "Drive Export Doc (txt)": {"main":[[{"node":"Doc -> Text","type":"main","index":0}]]},
    "Doc -> Text": {"main":[[{"node":"Merge Source Text","type":"main","index":0}]]},
    "Has Sheet Row?": {"main":[[],[{"node":"Read Sheet Row","type":"main","index":0}]]},
    "Read Sheet Row": {"main":[[{"node":"Sheet Row -> Text","type":"main","index":0}]]},
    "Sheet Row -> Text": {"main":[[{"node":"Merge Source Text","type":"main","index":0}]]},
    "Merge Source Text": {"main":[[{"node":"OpenAI Draft","type":"main","index":0}]]},
    "OpenAI Draft": {"main":[[{"node":"Estimate Duration","type":"main","index":0}]]},
    "Estimate Duration": {"main":[[{"node":"Google TTS -> MP3","type":"main","index":0}]]},
    "Google TTS -> MP3": {"main":[[{"node":"Base64 -> Binary","type":"main","index":0}]]},
    "Base64 -> Binary": {"main":[[{"node":"Drive Upload (audio)","type":"main","index":0}]]},
    "Drive Upload (audio)": {"main":[[{"node":"Download Audio (for probe)","type":"main","index":0}]]},
    "Download Audio (for probe)": {"main":[[{"node":"Probe MP3 Duration","type":"main","index":0}]]},
    "Probe MP3 Duration": {"main":[[{"node":"Build Audio URL + Timings","type":"main","index":0}]]},
    "Build Audio URL + Timings": {"main":[[{"node":"Build Shotstack JSON","type":"main","index":0}]]},
    "Build Shotstack JSON": {"main":[[{"node":"Shotstack Render","type":"main","index":0}]]},
    "Shotstack Render": {"main":[[{"node":"Get Render ID","type":"main","index":0}]]},
    "Get Render ID": {"main":[[{"node":"Poll Render (≤15m)","type":"main","index":0}]]},
    "Poll Render (≤15m)": {"main":[[{"node":"Download MP4","type":"main","index":0}]]},
    "Download MP4": {"main":[[{"node":"Drive Upload (video)","type":"main","index":0},{"node":"Check Existing","type":"main","index":0}]]},
    "Check Existing": {"main":[[{"node":"If Existing","type":"main","index":0}]]},
    "If Existing": {"main":[[{"node":"Update Sheet Row","type":"main","index":0}],[{"node":"YouTube Upload","type":"main","index":0}]]},
    "YouTube Upload": {"main":[[{"node":"Build SRT","type":"main","index":0},{"node":"Append Google Sheet","type":"main","index":0}]]},
    "Build SRT": {"main":[[{"node":"YouTube Captions Upload (set OAuth)","type":"main","index":0}]]}
  }
}

