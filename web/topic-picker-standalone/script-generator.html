<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Script Generator - MSS Studio</title>
  <link rel="stylesheet" href="studio.css">
  <script src="version.js" defer></script>
</head>
<body>
  <div id="loadingBar" class="loading-bar"></div>
  <div class="card" style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
    <h1 style="margin:0;">Script Generator <span id="appVersion" style="font-size:14px; color:#64748b; font-weight:400;">v-</span></h1>
    <div style="display:flex; gap:10px; flex-wrap:wrap; position:relative;">
      <button class="btn" onclick="window.location.href='index.html'">Topics</button>
      <button class="btn" onclick="window.location.href='avatar-manager.html'">Avatars</button>
      <button class="btn" onclick="window.location.href='logo-manager.html'">Logos</button>
      <button class="btn" onclick="window.location.href='meme-library.html'">Memes</button>
      <button class="btn" onclick="window.location.href='intro-outro.html'">Intro/Outro</button>
      <button class="btn" onclick="window.location.href='viewer.html'">Viewer</button>
      <button class="btn" style="background:#3b82f6; border-color:#3b82f6;" onclick="window.location.href='studio.html'">Studio</button>
      <div class="dropdown" id="oldMenusContainer" style="position:relative;display:none;">
        <button class="btn" id="oldMenusBtn">Old Menus</button>
        <div class="dropdown-content" id="oldMenus" style="display:none; position:absolute; top:110%; left:0; background:#0B0F19; border:1px solid #334; border-radius:8px; min-width:180px; z-index:20; box-shadow:0 6px 18px rgba(0,0,0,0.4);">
          <a href="script-generator.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Script Generator</a>
          <a href="thumbnail-manager.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Thumbnails</a>
          <a href="video-composer.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Composer</a>
          <a href="post-process.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Post-Process</a>
          <a href="preview.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Preview</a>
        </div>
      </div>
    </div>
  </div>

<script>(function(){ const btn=document.getElementById("oldMenusBtn"); const menu=document.getElementById("oldMenus"); const $oldMenusContainer = document.getElementById('oldMenusContainer'); if(btn&&menu&&$oldMenusContainer){ btn.addEventListener("click",(e)=>{ e.stopPropagation(); menu.style.display=(menu.style.display==="block"?"none":"block");}); document.addEventListener("click",()=>{ menu.style.display="none";}); menu.addEventListener("click",(e)=>e.stopPropagation()); document.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key.toLowerCase()==='o'){ e.preventDefault(); $oldMenusContainer.style.display = ($oldMenusContainer.style.display==='none'||!$oldMenusContainer.style.display)?'block':'none'; } }); }})();</script>

  <div class="card">
    <h1>Topic Picker</h1>
    <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button class="btn" id="liteLoadLast">Load Last Topic</button>
      <a class="btn" href="index.html?return=script-generator.html" id="openFullPicker">Open Full Topic Picker</a>
      <span id="liteStatus" class="status info" style="display:none;"></span>
    </div>
    <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div>
        <label>Title</label>
        <input id="liteTitle" placeholder="video Title" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;" />
      </div>
      <div>
        <label>Angle / Hook</label>
        <input id="liteHook" placeholder="Hook / Angle" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;" />
      </div>
      <div style="grid-column: 1 / span 2;">
        <label>Keywords (comma or space separated)</label>
        <input id="liteKeywords" placeholder="ai, 2025, automation, future of work" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;" />
      </div>
    </div>
  </div>
  <script>
    (function(){
      function renderTokens(keywords){
        try {
          const cont = document.getElementById('topicTokens');
          if (!cont) return;
          cont.innerHTML = '';
          (keywords||[]).forEach(kw => {
            const b = document.createElement('span');
            b.textContent = kw;
            b.style.padding='4px 8px'; b.style.border='1px solid #334'; b.style.borderRadius='6px'; b.style.cursor='pointer'; b.style.fontSize='12px';
            cont.appendChild(b);
          });
        } catch {}
      }

      function tryLoad(){
        try {
          const raw = localStorage.getItem('editingTopic');
          if (!raw) return false;
          const t = JSON.parse(raw);
          if (!t) return false;

          const title = t.yt_title || t.title || '';
          const hook = t.angle || '';
          const keywords = t.keywords || [];

          // Inline Picker fields
          const liteTitle = document.getElementById('liteTitle');
          const liteHook = document.getElementById('liteHook');
          const liteKw = document.getElementById('liteKeywords');
          if (liteTitle) liteTitle.value = title;
          if (liteHook) liteHook.value = hook;
          if (liteKw) liteKw.value = keywords.join(', ');

          renderTokens(keywords);

          const s = document.getElementById('liteStatus');
          if (s) { s.textContent = 'Loaded topic from picker'; s.className='status ok'; s.style.display='block'; }

          return true;
        } catch(e) {
          console.error('Error loading topic:', e);
          return false;
        }
      }

      // Aggressive retry strategy - keep trying until it works or we give up
      let attempts = 0;
      const maxAttempts = 20;

      function retryLoad() {
        attempts++;
        if (tryLoad()) {
          return;
        }
        if (attempts < maxAttempts) {
          setTimeout(retryLoad, 200);
        }
      }

      // Start trying immediately
      retryLoad();

      // Also try when page is fully loaded
      window.addEventListener('load', tryLoad);

      // And when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryLoad);
      }

      const btn = document.getElementById('liteLoadLast');
      if (btn) btn.addEventListener('click', tryLoad);
    })();
  </script>

  <div class="card" style="margin-top:16px;">
    <h1>ðŸŽ¬ AI Script Generator</h1>
    <div class="row" style="background:rgba(59,130,246,0.1); border:1px solid var(--accent-blue); border-radius:6px; padding:12px;">
      <div style="font-size:13px; color:var(--text-muted); margin-bottom:8px;">
        Generate a complete video script based on your topic. Uses your title, hook, and keywords.
      </div>
    </div>
    <div class="row">
      <label>Script Length</label>
      <select id="scriptLength" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;">
        <option value="short">Short (30-60 seconds)</option>
        <option value="medium" selected>Medium (2-3 minutes)</option>
        <option value="long">Long (5-8 minutes)</option>
      </select>
    </div>
    <div class="row">
      <label>Script Style</label>
      <select id="scriptStyle" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;">
        <option value="informative" selected>Informative (Educational)</option>
        <option value="entertaining">Entertaining (Engaging)</option>
        <option value="dramatic">Dramatic (Storytelling)</option>
        <option value="casual">Casual (Conversational)</option>
        <option value="professional">Professional (News-style)</option>
      </select>
    </div>
    <div class="controls">
      <button class="btn" id="generateScript" style="background:#8b5cf6; border-color:#8b5cf6;">âœ¨ Generate Script</button>
      <button class="btn" id="copyScript" style="display:none;">ðŸ“‹ Copy Script</button>
    </div>
    <div id="scriptStatus" class="status" style="display:none;"></div>
    <div class="row" id="scriptOutputRow" style="display:none;">
      <label>Generated Script</label>
      <textarea id="scriptOutput" style="width:100%; min-height:300px; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF; font-family:monospace; line-height:1.6;"></textarea>
      <div style="margin-top:8px; display:flex; gap:12px; color:var(--text-muted); font-size:12px;">
        <span id="scriptWordCount">Words: 0</span>
        <span id="scriptDuration">Est. Duration: 0s</span>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    function liteStatus(msg, kind='info') {
      const el = document.getElementById('liteStatus');
      el.style.display = 'inline-block';
      el.className = 'status ' + (kind || 'info');
      el.textContent = msg;
    }

    function parseKeywords(str) {
      if (!str) return [];
      const raw = str.split(/[\s,]+/).map(s => s.trim()).filter(Boolean);
      // de-dup while preserving order
      const seen = new Set(); const out = [];
      for (const w of raw) { if (!seen.has(w.toLowerCase())) { seen.add(w.toLowerCase()); out.push(w); } }
      return out.slice(0, 50);
    }

    // Fetch and display Version from API
    (function loadVersion(){
      fetch(`${API_BASE}/health`).then(r => r.json()).then(j => {
        const el = document.getElementById('appVersion');
        if (el && j && j.Version) el.textContent = 'v-' + j.Version;
      }).catch(()=>{
        const el = document.getElementById('appVersion');
        if (el) el.textContent = 'v-5.5.1';
      });
    })();

    // Toast Notification System
    function showToast(message, type = 'info', duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span>${message}</span>
        <span class="toast-close">âœ•</span>
      `;

      document.body.appendChild(toast);

      const close = () => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      };

      toast.querySelector('.toast-close').addEventListener('click', close);

      if (duration > 0) {
        setTimeout(close, duration);
      }

      return toast;
    }

    // Override toast to stack without overlap
    if (typeof showToast === 'function' && !window.__toastStackPatched) {
      const __origShowToast = showToast;
      window.showToast = function(message, type = 'info', duration = 4000) {
        let container = document.getElementById('toastContainer');
        if (!container) {
          container = document.createElement('div');
          container.id = 'toastContainer';
          Object.assign(container.style, {
            position: 'fixed', top: '80px', right: '24px', display: 'flex',
            flexDirection: 'column', alignItems: 'flex-end', gap: '8px', zIndex: '10000'
          });
          document.body.appendChild(container);
        }
        const toast = __origShowToast(message, type, duration);
        try { document.body.removeChild(toast); } catch {}
        Object.assign(toast.style, { position: 'relative', top: 'auto', right: 'auto', margin: '0' });
        container.appendChild(toast);
        return toast;
      };
      window.__toastStackPatched = true;
    }

    function applyTopicToUI(topic) {
      try {
        localStorage.setItem('editingTopic', JSON.stringify(topic));
      } catch {}
      const title = topic.title || topic.yt_title || '';
      const hook = topic.angle || topic.hook || '';
      const kw = topic.keywords || topic.yt_tags || [];
      const uniq = Array.from(new Set([...(kw||[])]));
      // Populate Inline Picker fields
      const lTitle = document.getElementById('liteTitle'); if (lTitle) lTitle.value = title;
      const lHook = document.getElementById('liteHook'); if (lHook) lHook.value = hook;
      const lKw = document.getElementById('liteKeywords'); if (lKw) lKw.value = uniq.join(', ');
      // Persist to backend (best-effort)
      fetch(`${API_BASE}/set-selected-topic`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(topic)
      }).catch(()=>{});
      liteStatus('Topic applied.', 'ok');
    }

    // Wire Inline Picker controls
    document.getElementById('liteLoadLast').addEventListener('click', async () => {
      liteStatus('Loading last topic...', 'info');
      try {
        const r = await fetch(`${API_BASE}/get-selected-topic`);
        const j = await r.json();
        if (!j.success) throw new Error(j.error || 'Not found');
        applyTopicToUI(j.topic || {});
      } catch (e) {
        liteStatus('Error: ' + e.message, 'err');
      }
    });

    // Load topic keywords/tags from localStorage or API fallback
    (function loadTopicMeta() {
      try {
        const saved = localStorage.getItem('editingTopic');
        if (saved) {
          const topic = JSON.parse(saved);
          applyTopicToUI(topic);
        }
      } catch {}
      // Fallback: ask API for last selected topic
      fetch(`${API_BASE}/get-selected-topic`).then(r => r.json()).then(d => {
        if (d && d.success && d.topic) {
          const t = d.topic;
          applyTopicToUI(t);
        }
      }).catch(()=>{});
    })();

    // Analytics Tracking
    function trackEvent(eventType, data = {}) {
      const stats = JSON.parse(localStorage.getItem('mss_stats') || '{}');
      if (!stats.events) stats.events = [];

      stats.events.push({
        type: eventType,
        timestamp: Date.now(),
        ...data
      });

      // Keep only last 100 events
      if (stats.events.length > 100) {
        stats.events = stats.events.slice(-100);
      }

      // Update counters
      if (!stats.counters) stats.counters = {};
      stats.counters[eventType] = (stats.counters[eventType] || 0) + 1;
      stats.counters.total = (stats.counters.total || 0) + 1;
      stats.lastActivity = Date.now();

      localStorage.setItem('mss_stats', JSON.stringify(stats));
    }

    // AI Script Generator
    document.getElementById('generateScript')?.addEventListener('click', async () => {
      const title = document.getElementById('liteTitle')?.value || '';
      const hook = document.getElementById('liteHook')?.value || '';
      const keywords = document.getElementById('liteKeywords')?.value || '';
      const length = document.getElementById('scriptLength')?.value || 'medium';
      const style = document.getElementById('scriptStyle')?.value || 'informative';

      if (!title && !hook) {
        showToast('Please enter a title or hook first', 'error', 3000);
        return;
      }

      const scriptStatus = document.getElementById('scriptStatus');
      const generateBtn = document.getElementById('generateScript');
      const loadingBar = document.getElementById('loadingBar');

      scriptStatus.style.display = 'block';
      scriptStatus.className = 'status info';
      scriptStatus.textContent = 'Generating script with AI...';
      generateBtn.disabled = true;
      if (loadingBar) loadingBar.style.display = 'block';

      try {
        const lengthMap = {
          'short': '30-60 seconds, around 100-150 words',
          'medium': '2-3 minutes, around 300-450 words',
          'long': '5-8 minutes, around 750-1200 words'
        };

        const styleMap = {
          'informative': 'educational and informative, teaching the audience something new',
          'entertaining': 'entertaining and engaging, keeping viewers hooked with energy and personality',
          'dramatic': 'dramatic storytelling style, building tension and narrative arc',
          'casual': 'casual and conversational, like talking to a friend',
          'professional': 'professional news-style, authoritative and credible'
        };

        const prompt = `You are a professional YouTube script writer. Create a compelling video script for the following video:

Title: ${title}
Hook/Angle: ${hook}
Keywords: ${keywords}

Script Requirements:
- Length: ${lengthMap[length]}
- Style: ${styleMap[style]}
- Include a strong opening hook (first 5 seconds)
- Clear structure with introduction, main content, and conclusion
- Include natural pauses and transitions
- End with a clear call-to-action
- Write for spoken word (conversational, not academic)
- Use "you" to directly address the viewer

Format the script with clear sections like:
[HOOK - 0:00-0:05]
[INTRO - 0:05-0:20]
[MAIN CONTENT]
[CONCLUSION]
[CTA]

Make it engaging and optimized for viewer retention.`;

        const res = await fetch(`${API_BASE}/generate-script`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: prompt,
            title: title,
            hook: hook,
            description: keywords,
            length: length,
            style: style
          })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();

        if (!data.success || !data.script) {
          throw new Error(data.error || 'Failed to generate script');
        }

        // Display the script
        const scriptOutput = document.getElementById('scriptOutput');
        const scriptOutputRow = document.getElementById('scriptOutputRow');
        const copyBtn = document.getElementById('copyScript');

        scriptOutput.value = data.script;
        scriptOutputRow.style.display = 'block';
        copyBtn.style.display = 'inline-block';

        // Update stats
        const words = data.script.split(/\s+/).length;
        const duration = Math.round(words / 2.5); // ~150 words per minute = 2.5 words per second
        document.getElementById('scriptWordCount').textContent = `Words: ${words}`;
        document.getElementById('scriptDuration').textContent = `Est. Duration: ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;

        scriptStatus.className = 'status ok';
        scriptStatus.textContent = 'âœ… Script generated successfully!';
        showToast('ðŸŽ¬ Script generated!', 'success', 3000);

        // Track event
        trackEvent('script_generated', { length, style, words });

      } catch (e) {
        console.error('Script generation error:', e);
        scriptStatus.className = 'status err';
        scriptStatus.textContent = `Error: ${e.message}`;
        showToast(`âŒ Script generation failed: ${e.message}`, 'error', 5000);
      } finally {
        generateBtn.disabled = false;
        if (loadingBar) loadingBar.style.display = 'none';
      }
    });

    // Copy script button
    document.getElementById('copyScript')?.addEventListener('click', () => {
      const scriptOutput = document.getElementById('scriptOutput');
      scriptOutput.select();
      document.execCommand('copy');
      showToast('ðŸ“‹ Script copied to clipboard', 'success', 2000);
    });

    // Update word count on edit
    document.getElementById('scriptOutput')?.addEventListener('input', (e) => {
      const words = e.target.value.split(/\s+/).filter(w => w.length > 0).length;
      const duration = Math.round(words / 2.5);
      document.getElementById('scriptWordCount').textContent = `Words: ${words}`;
      document.getElementById('scriptDuration').textContent = `Est. Duration: ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
    });
  </script>
</body>
</html>
