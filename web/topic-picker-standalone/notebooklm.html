<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MSS Studio</title>
  <link rel="stylesheet" href="studio.css">
  <script src="version.js" defer></script>
</head>
<body>
  <div id="loadingBar" class="loading-bar"></div>
  <div class="card" style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
    <h1 style="margin:0;">MSS Studio <span id="appVersion" style="font-size:14px; color:#64748b; font-weight:400;">v-</span></h1>
    <div style="display:flex; gap:10px; flex-wrap:wrap; position:relative;">
      <button class="btn" onclick="window.location.href='index.html'">Topics</button>
      <button class="btn" onclick="window.location.href='avatar-manager.html'">Avatars</button>
      <button class="btn" onclick="window.location.href='logo-manager.html'">Logos</button>
      <button class="btn" onclick="window.location.href='meme-library.html'">Memes</button>
      <button class="btn" onclick="window.location.href='intro-outro.html'">Intro/Outro</button>
      <button class="btn" onclick="window.location.href='viewer.html'">Viewer</button>
      <div class="dropdown" style="position:relative;">
        <button class="btn" id="oldMenusBtn">Old Menus</button>
        <div class="dropdown-content" id="oldMenus" style="display:none; position:absolute; top:110%; left:0; background:#0B0F19; border:1px solid #334; border-radius:8px; min-width:180px; z-index:20; box-shadow:0 6px 18px rgba(0,0,0,0.4);">
          <a href="script-generator.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Script Generator</a>
          <a href="thumbnail-manager.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Thumbnails</a>
          <a href="video-composer.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Composer</a>
          <a href="post-process.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Post-Process</a>
          <a href="preview.html" style="display:block; padding:8px 12px; color:#E8EBFF; text-decoration:none;">Preview</a>
        </div>
      </div>
    </div>
  </div>

<script>(function(){ const btn=document.getElementById("oldMenusBtn"); const menu=document.getElementById("oldMenus"); if(btn&&menu){ btn.addEventListener("click",(e)=>{ e.stopPropagation(); menu.style.display=(menu.style.display==="block"?"none":"block");}); document.addEventListener("click",()=>{ menu.style.display="none";}); menu.addEventListener("click",(e)=>e.stopPropagation()); }})();</script>

  <div class="card">
    <h1>Topic Picker</h1>
    <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button class="btn" id="liteLoadLast">Load Last Topic</button>
      <a class="btn" href="index.html?return=notebooklm.html" id="openFullPicker">Topic Picker</a>
      <span id="liteStatus" class="status info" style="display:none;"></span>
    </div>
    <div class="row" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div>
        <label>Title</label>
        <input id="liteTitle" placeholder="video Title" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;" />
      </div>
      <div>
        <label>Angle / Hook</label>
        <input id="liteHook" placeholder="Hook / Angle" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;" />
      </div>
      <div style="grid-column: 1 / span 2;">
        <label>Keywords (comma or space separated)</label>
        <input id="liteKeywords" placeholder="ai, 2025, automation, future of work" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;" />
      </div>
    </div>
  </div>
  <script>
    (function(){
      function renderTokens(keywords){
        try {
          const cont = document.getElementById('topicTokens');
          if (!cont) return;
          cont.innerHTML = '';
          (keywords||[]).forEach(kw => {
            const b = document.createElement('span');
            b.textContent = kw;
            b.style.padding='4px 8px'; b.style.border='1px solid #334'; b.style.borderRadius='6px'; b.style.cursor='pointer'; b.style.fontSize='12px';
            cont.appendChild(b);
          });
        } catch {}
      }

      function tryLoad(){
        try {
          const raw = localStorage.getItem('editingTopic');
          if (!raw) return false;
          const t = JSON.parse(raw);
          if (!t) return false;

          const title = t.yt_title || t.title || '';
          const hook = t.angle || '';
          const keywords = t.keywords || [];

          // Inline Picker fields
          const liteTitle = document.getElementById('liteTitle');
          const liteHook = document.getElementById('liteHook');
          const liteKw = document.getElementById('liteKeywords');
          if (liteTitle) liteTitle.value = title;
          if (liteHook) liteHook.value = hook;
          if (liteKw) liteKw.value = keywords.join(', ');

          renderTokens(keywords);

          const s = document.getElementById('liteStatus');
          if (s) { s.textContent = 'Loaded topic from picker'; s.className='status ok'; s.style.display='block'; }

          return true;
        } catch(e) {
          console.error('Error loading topic:', e);
          return false;
        }
      }

      // Aggressive retry strategy - keep trying until it works or we give up
      let attempts = 0;
      const maxAttempts = 20;

      function retryLoad() {
        attempts++;
        if (tryLoad()) {
          return;
        }
        if (attempts < maxAttempts) {
          setTimeout(retryLoad, 200);
        }
      }

      // Start trying immediately
      retryLoad();

      // Also try when page is fully loaded
      window.addEventListener('load', tryLoad);

      // And when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', tryLoad);
      }

      const btn = document.getElementById('liteLoadLast');
      if (btn) btn.addEventListener('click', tryLoad);
    })();
  </script>

  <div class="card">
    <h1>Video w/Audio Loader</h1>
    <div class="row">
      <label for="mainFile">NotebookLM video (required):</label>
      <input type="file" id="mainFile" accept="video/*">
    </div>
    <div class="controls">
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="toggleAvatar" checked>
        Include avatar (lower-right)
      </label>
      <div id="avatarSelectWrap" style="display:flex; align-items:center; gap:6px;">
        <span style="font-size:13px; color:#94a3b8;">Avatar:</span>
        <select id="avatarSelect" style="padding:6px 10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;"></select>
        <img id="activeAvatarImg" alt="Active Avatar" style="width:48px; height:48px; border-radius:8px; object-fit:cover; border:1px solid #334; background:#0B0F19; display:none; vertical-align:middle;"/>
      </div>
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="avatarAnimated" checked>
        Animated avatar (D-ID/FFmpeg)
      </label>
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="skipDID" checked>
        Skip D-ID (use local animation)
      </label>
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="toggleLogo" checked>
        Include logo
      </label>
      <div id="logoSelectWrap" style="display:flex; align-items:center; gap:6px;">
        <span style="font-size:13px; color:#94a3b8;">Logo:</span>
        <select id="logoSelect" style="padding:6px 10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;"></select>
        <img id="activeLogoImg" alt="Active Logo" style="width:48px; height:48px; border-radius:8px; object-fit:contain; border:1px solid #334; background:#0B0F19; display:none; vertical-align:middle;"/>
      </div>
      <div id="logoPositionWrap" style="display:flex; align-items:center; gap:6px;">
        <span style="font-size:13px; color:#94a3b8;">Position:</span>
        <select id="logoPos" style="padding:6px 10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;">
          <option value="bottom-left">Bottom-Left</option>
          <option value="bottom-right">Bottom-Right</option>
          <option value="top-left">Top-Left</option>
          <option value="top-right">Top-Right</option>
          <option value="center">Center</option>
        </select>
      </div>
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="toggleIntroOutro">
        Include intro/outro
      </label>
    </div>
    <div class="row">
      <button class="btn" id="approveBtn" disabled>Approve & Process</button>
    </div>
    <div id="status" class="status"></div>
    <div class="row">
      <video id="preview" controls style="display:none;"></video>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h1>ðŸŽ¬ AI Script Generator</h1>
    <div class="row" style="background:rgba(59,130,246,0.1); border:1px solid var(--accent-blue); border-radius:6px; padding:12px;">
      <div style="font-size:13px; color:var(--text-muted); margin-bottom:8px;">
        Generate a complete video script based on your topic. Uses your title, hook, and keywords.
      </div>
    </div>
    <div class="row">
      <label>Script Length</label>
      <select id="scriptLength" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;">
        <option value="short">Short (30-60 seconds)</option>
        <option value="medium" selected>Medium (2-3 minutes)</option>
        <option value="long">Long (5-8 minutes)</option>
      </select>
    </div>
    <div class="row">
      <label>Script Style</label>
      <select id="scriptStyle" style="width:100%; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF;">
        <option value="informative" selected>Informative (Educational)</option>
        <option value="entertaining">Entertaining (Engaging)</option>
        <option value="dramatic">Dramatic (Storytelling)</option>
        <option value="casual">Casual (Conversational)</option>
        <option value="professional">Professional (News-style)</option>
      </select>
    </div>
    <div class="controls">
      <button class="btn" id="generateScript" style="background:#8b5cf6; border-color:#8b5cf6;">âœ¨ Generate Script</button>
      <button class="btn" id="copyScript" style="display:none;">ðŸ“‹ Copy Script</button>
    </div>
    <div id="scriptStatus" class="status" style="display:none;"></div>
    <div class="row" id="scriptOutputRow" style="display:none;">
      <label>Generated Script</label>
      <textarea id="scriptOutput" style="width:100%; min-height:300px; padding:10px; border-radius:6px; border:1px solid #334; background:#0B0F19; color:#E8EBFF; font-family:monospace; line-height:1.6;"></textarea>
      <div style="margin-top:8px; display:flex; gap:12px; color:var(--text-muted); font-size:12px;">
        <span id="scriptWordCount">Words: 0</span>
        <span id="scriptDuration">Est. Duration: 0s</span>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://127.0.0.1:5000';
    const DEFAULT_PROMPT = `Create a vibrant, eye-catching YouTube thumbnail for a video titled: {{title}}

Style: Bold, high-contrast, professional
Elements: Large readable text, dramatic v-isuals, bright colors
Emotion: Exciting, curiosity-inducing, click-worthy
Format: 1280x720 pixels, 16:9 aspect ratio

Make it stand out in search results and suggested videos.`;

    function liteStatus(msg, kind='info') {
      const el = document.getElementById('liteStatus');
      el.style.display = 'inline-block';
      el.className = 'status ' + (kind || 'info');
      el.textContent = msg;
    }

    function parseKeywords(str) {
      if (!str) return [];
      const raw = str.split(/[\s,]+/).map(s => s.trim()).filter(Boolean);
      // de-dup while preserv-ing order
      const seen = new Set(); const out = [];
      for (const w of raw) { if (!seen.has(w.toLowerCase())) { seen.add(w.toLowerCase()); out.push(w); } }
      return out.slice(0, 50);
    }


    // Fetch and display Version from API
    (function loadVersion(){
      fetch(`${API_BASE}/health`).then(r => r.json()).then(j => {
        const el = document.getElementById('appVersion');
        if (el && j && j.Version) el.textContent = 'v-' + j.Version;
      }).catch(()=>{
        const el = document.getElementById('appVersion');
        if (el) el.textContent = 'v-2.3.1';
      });
    })();

    // Persistence of logo position and toggles
    (function initHeader(){
      const posEl = document.getElementById('logoPos');
      // restore saved position
      const savedPos = localStorage.getItem('logo_position');
      if (savedPos) posEl.value = savedPos;
      posEl.addEventListener('change', ()=> localStorage.setItem('logo_position', posEl.value));
      // Persist toggles
      const persist = (id)=>{ const el = document.getElementById(id); const k = 'persist_'+id; const sv = localStorage.getItem(k); if(sv!==null) el.checked = (sv==='true'); el.addEventListener('change', ()=> localStorage.setItem(k, el.checked)); };
      persist('toggleAvatar');
      persist('avatarAnimated');
      persist('skipDID');
      persist('toggleLogo');
      persist('toggleIntroOutro');
    })();


    function applyTopicToUI(topic) {
      try {
        localStorage.setItem('editingTopic', JSON.stringify(topic));
      } catch {}
      const title = topic.title || topic.yt_title || '';
      const hook = topic.angle || topic.hook || '';
      const kw = topic.keywords || topic.yt_tags || [];
      const uniq = Array.from(new Set([...(kw||[])]));
        // Populate Inline Picker fields
        const lTitle = document.getElementById('liteTitle'); if (lTitle) lTitle.value = title;
        const lHook = document.getElementById('liteHook'); if (lHook) lHook.value = hook;
        const lKw = document.getElementById('liteKeywords'); if (lKw) lKw.value = uniq.join(', ');
      // Render keyword chips
      const tokensEl = document.getElementById('topicTokens');
      if (tokensEl) {
        tokensEl.innerHTML = '';
        uniq.slice(0, 50).forEach(t => {
          const chip = document.createElement('span');
          chip.textContent = t;
          chip.style.cssText = 'background:#1e3a8a; border-radius:14px; padding:6px 10px; font-size:12px; cursor:pointer;';
          tokensEl.appendChild(chip);
        });
      }
      // Persist to backend (best-effort)
      fetch(`${API_BASE}/set-selected-topic`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(topic)
      }).catch(()=>{});
      liteStatus('Topic applied.', 'ok');
    }

    // Wire Inline Picker controls
    document.getElementById('liteLoadLast').addEventListener('click', async () => {
      liteStatus('Loading last topic...', 'info');
      try {
        const r = await fetch(`${API_BASE}/get-selected-topic`);
        const j = await r.json();
        if (!j.success) throw new Error(j.error || 'Not found');
        applyTopicToUI(j.topic || {});
      } catch (e) {
        liteStatus('Error: ' + e.message, 'err');
      }
    });


    const mainInput = document.getElementById('mainFile');
    const approveBtn = document.getElementById('approveBtn');
    const statusBox = document.getElementById('status');
    const preview = document.getElementById('preview');
    const toggleAvatar = document.getElementById('toggleAvatar');
    const avatarSelect = document.getElementById('avatarSelect');
    const avatarSelectWrap = document.getElementById('avatarSelectWrap');
    const toggleLogo = document.getElementById('toggleLogo');
    const toggleIntroOutro = document.getElementById('toggleIntroOutro');

    function setStatus(text, kind) {
      statusBox.style.display = 'block';
      statusBox.className = 'status ' + (kind || 'info');
      statusBox.textContent = text;
    }

    function clearStatus() { statusBox.style.display = 'none'; }

    // Toast Notification System
    function showToast(message, type = 'info', duration = 4000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span>${message}</span>
        <span class="toast-close">âœ•</span>
      `;

      document.body.appendChild(toast);

      const close = () => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      };

      toast.querySelector('.toast-close').addEventListener('click', close);

      if (duration > 0) {
        setTimeout(close, duration);
      }

      return toast;
    }

    // Enhanced error handling with retry
    async function fetchWithRetry(url, options = {}, retries = 2) {
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) {
            const text = await res.text().catch(() => '');
            throw new Error(`HTTP ${res.status}: ${text.slice(0, 100) || res.statusText}`);
          }
          return res;
        } catch (e) {
          if (i === retries) throw e;
          await new Promise(r => setTimeout(r, 1000 * (i + 1)));
          showToast(`Retrying... (${i + 1}/${retries})`, 'info', 2000);
        }
      }
    }


    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+S or Cmd+S to generate video
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        const approveBtn = document.getElementById('approveBtn');
        if (approveBtn && !approveBtn.disabled) {
          approveBtn.click();
          showToast('Generating video...', 'info', 2000);
        }
      }

      // Escape to cancel/hide loading bar
      if (e.key === 'Escape') {
        const loadingBar = document.getElementById('loadingBar');
        if (loadingBar && loadingBar.style.display === 'block') {
          loadingBar.style.display = 'none';
          showToast('Operation cancelled', 'info', 2000);
        }
      }
    });

    toggleAvatar.addEventListener('change', () => {
      avatarSelectWrap.style.display = toggleAvatar.checked ? 'flex' : 'none';
    });

    // Load avatars
    async function loadavatars() {
      try {
        const res = await fetch(`${API_BASE}/get-avatar-library`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        avatarSelect.innerHTML = '';
        const list = (data && data.avatars) ? data.avatars : [];
        if (list.length === 0) {
          avatarSelect.innerHTML = '<option value="">No avatars found</option>';
          return;
        }

        const activeAvatarImg = document.getElementById('activeAvatarImg');
        let activeAvatar = null;

        list.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = a.name || a.id;
          if (a.active) {
            opt.selected = true;
            activeAvatar = a;
          }
          avatarSelect.appendChild(opt);
        });

        // Display active avatar image
        if (activeAvatar && activeAvatarImg) {
          activeAvatarImg.src = activeAvatar.image_url;
          activeAvatarImg.style.display = 'inline-block';
          console.log('Active avatar loaded:', activeAvatar.name, activeAvatar.image_url);
        } else if (activeAvatarImg) {
          activeAvatarImg.style.display = 'none';
        }
      } catch (e) {
        console.error('Error loading avatars:', e);
        avatarSelect.innerHTML = '<option value="">Error loading avatars</option>';
        const activeAvatarImg = document.getElementById('activeAvatarImg');
        if (activeAvatarImg) activeAvatarImg.style.display = 'none';
      }
    }
    loadavatars();

    // Update avatar image when selection changes
    avatarSelect.addEventListener('change', async () => {
      const activeAvatarImg = document.getElementById('activeAvatarImg');
      if (!activeAvatarImg) return;

      const selectedId = avatarSelect.value;
      if (!selectedId) {
        activeAvatarImg.style.display = 'none';
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/get-avatar-library`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const list = (data && data.avatars) ? data.avatars : [];
        const selectedAvatar = list.find(a => a.id === selectedId);

        if (selectedAvatar && selectedAvatar.image_url) {
          activeAvatarImg.src = selectedAvatar.image_url;
          activeAvatarImg.style.display = 'inline-block';
          console.log('Avatar changed to:', selectedAvatar.name, selectedAvatar.image_url);
        } else {
          activeAvatarImg.style.display = 'none';
        }
      } catch (e) {
        console.error('Error loading avatar image:', e);
        activeAvatarImg.style.display = 'none';
      }
    });

    // Load logos dropdown
    const logoSelect = document.getElementById('logoSelect');
    async function loadLogos() {
      try {
        const res = await fetch(`${API_BASE}/get-logo-library`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        logoSelect.innerHTML = '';
        const list = (data && data.logos) ? data.logos : [];
        if (list.length === 0) {
          logoSelect.innerHTML = '<option value="">No logos found</option>';
          return;
        }

        const activeLogoImg = document.getElementById('activeLogoImg');
        let activeLogo = null;

        list.forEach(logo => {
          const opt = document.createElement('option');
          opt.value = logo.id;
          opt.textContent = logo.name || logo.filename || logo.id;
          if (logo.active) {
            opt.selected = true;
            activeLogo = logo;
          }
          logoSelect.appendChild(opt);
        });

        // Display active logo image
        if (activeLogo && activeLogoImg) {
          activeLogoImg.src = activeLogo.url;
          activeLogoImg.style.display = 'inline-block';
          console.log('Active logo loaded:', activeLogo.name, activeLogo.url);
        } else if (activeLogoImg) {
          activeLogoImg.style.display = 'none';
        }
      } catch (e) {
        console.error('Error loading logos:', e);
        logoSelect.innerHTML = '<option value="">Error loading logos</option>';
        const activeLogoImg = document.getElementById('activeLogoImg');
        if (activeLogoImg) activeLogoImg.style.display = 'none';
      }
    }
    loadLogos();

    // Update logo image when selection changes
    logoSelect.addEventListener('change', async () => {
      const activeLogoImg = document.getElementById('activeLogoImg');
      if (!activeLogoImg) return;

      const selectedId = logoSelect.value;
      if (!selectedId) {
        activeLogoImg.style.display = 'none';
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/get-logo-library`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const list = (data && data.logos) ? data.logos : [];
        const selectedLogo = list.find(logo => logo.id === selectedId);

        if (selectedLogo && selectedLogo.url) {
          activeLogoImg.src = selectedLogo.url;
          activeLogoImg.style.display = 'inline-block';
          console.log('Logo changed to:', selectedLogo.name, selectedLogo.url);
        } else {
          activeLogoImg.style.display = 'none';
        }
      } catch (e) {
        console.error('Error loading logo image:', e);
        activeLogoImg.style.display = 'none';
      }
    });

    // Load topic keywords/tags from localStorage or API fallback
    (function loadTopicMeta() {
      const tokensEl = document.getElementById('topicTokens');
      function renderTokens(arr){
        tokensEl.innerHTML = '';
        arr.slice(0, 50).forEach(t => {
          const chip = document.createElement('span');
          chip.textContent = t;
          chip.style.cssText = 'background:#1e3a8a; border-radius:14px; padding:6px 10px; font-size:12px; cursor:pointer;';
          tokensEl.appendChild(chip);
        });
      }

      try {
        let arr = [];
        const saved = localStorage.getItem('editingTopic');
        if (saved) {
          const topic = JSON.parse(saved);
          applyTopicToUI(topic);
          const kw = topic.keywords || [];
          const yt = topic.yt_tags || [];
          arr = [...new Set([...(kw||[]), ...(yt||[])])];
        }
        if (arr.length > 0) { renderTokens(arr); return; }
      } catch {}
      // Fallback: ask API for last selected topic
      fetch(`${API_BASE}/get-selected-topic`).then(r => r.json()).then(d => {
        if (d && d.success && d.topic) {
          const t = d.topic;
          applyTopicToUI(t);
          const kw = t.keywords || [];
          const yt = t.yt_tags || [];
          const arr = [...new Set([...(kw||[]), ...(yt||[])])];
          if (arr.length) renderTokens(arr);
        }
      }).catch(()=>{});
    })();


    mainInput.addEventListener('change', () => {
      const f = mainInput.files && mainInput.files[0];
      approveBtn.disabled = !f;
      if (f) {
        try {
          const url = URL.createObjectURL(f);
          preview.src = url; preview.style.display = 'block'; preview.load();
        } catch {}
      }
    });

    approveBtn.addEventListener('click', async () => {
      const f = mainInput.files && mainInput.files[0];
      if (!f) { alert('Pick a video'); return; }
      approveBtn.disabled = true;
      setStatus('Processingâ€¦', 'info');
      try {
        const fd = new FormData();
        fd.append('video', f);
        // 'use_did' indicates Include avatar; 'avatar_static' is inverse of the Animated checkbox
        fd.append('use_did', toggleAvatar.checked ? 'true' : 'false');
        const animated = document.getElementById('avatarAnimated').checked;
        const skipDID = document.getElementById('skipDID').checked;
        fd.append('avatar_static', animated ? 'false' : 'true');
        fd.append('skip_did', skipDID ? 'true' : 'false');
        fd.append('add_intro_outro', toggleIntroOutro.checked ? 'true' : 'false');
        if (toggleAvatar.checked && avatarSelect.value) {
          fd.append('avatar_id', avatarSelect.value);
        }
        // Pass include_logo flag so backend can skip overlay if off
        fd.append('include_logo', toggleLogo.checked ? 'true' : 'false');
        // Explicitly pass the active logo filename to guarantee correct file is used
        try {
          const lib = await fetch(`${API_BASE}/get-logo-library`).then(r => r.json());
          const active = (lib && Array.isArray(lib.logos)) ? lib.logos.find(l => l.active) : null;
          if (active && active.filename) {
            fd.append('logo_filename', active.filename);
          }
        } catch {}
        const resp = await fetch(`${API_BASE}/post-process-video`, { method: 'POST', body: fd });
        if (!resp.ok) {
          const t = await resp.text();
          throw new Error(`HTTP ${resp.status} ${resp.statusText}: ${t.slice(0,200)}`);
        }
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        setStatus('Done!', 'ok');
        const url = `${API_BASE}/out/${data.files.final_video}`;
        preview.src = url; preview.style.display = 'block'; preview.load();
      } catch (e) {
        console.error(e);
        setStatus(`Error: ${e.message}`, 'err');
        showToast(`Error: ${e.message}`, 'error', 6000);
      } finally { approveBtn.disabled = false; }
    });








    // Analytics Tracking
    function trackEvent(eventType, data = {}) {
      const stats = JSON.parse(localStorage.getItem('mss_stats') || '{}');
      if (!stats.events) stats.events = [];

      stats.events.push({
        type: eventType,
        timestamp: Date.now(),
        ...data
      });

      // Keep only last 100 events
      if (stats.events.length > 100) {
        stats.events = stats.events.slice(-100);
      }

      // Update counters
      if (!stats.counters) stats.counters = {};
      stats.counters[eventType] = (stats.counters[eventType] || 0) + 1;
      stats.counters.total = (stats.counters.total || 0) + 1;
      stats.lastActivity = Date.now();

      localStorage.setItem('mss_stats', JSON.stringify(stats));
    }

    // Show basic stats on console
    setTimeout(() => {
      const stats = JSON.parse(localStorage.getItem('mss_stats') || '{}');
      if (stats.counters) {
        console.log('ðŸ“Š MSS Analytics:', stats.counters);
        console.log(`Total actions: ${stats.counters.total || 0}`);
      }
    }, 2000);

    // AI Script Generator
    document.getElementById('generateScript')?.addEventListener('click', async () => {
      const title = document.getElementById('liteTitle')?.value || '';
      const hook = document.getElementById('liteHook')?.value || '';
      const keywords = document.getElementById('liteKeywords')?.value || '';
      const length = document.getElementById('scriptLength')?.value || 'medium';
      const style = document.getElementById('scriptStyle')?.value || 'informative';

      if (!title && !hook) {
        showToast('Please enter a title or hook first', 'error', 3000);
        return;
      }

      const scriptStatus = document.getElementById('scriptStatus');
      const generateBtn = document.getElementById('generateScript');
      const loadingBar = document.getElementById('loadingBar');

      scriptStatus.style.display = 'block';
      scriptStatus.className = 'status info';
      scriptStatus.textContent = 'Generating script with AI...';
      generateBtn.disabled = true;
      if (loadingBar) loadingBar.style.display = 'block';

      try {
        const lengthMap = {
          'short': '30-60 seconds, around 100-150 words',
          'medium': '2-3 minutes, around 300-450 words',
          'long': '5-8 minutes, around 750-1200 words'
        };

        const styleMap = {
          'informative': 'educational and informative, teaching the audience something new',
          'entertaining': 'entertaining and engaging, keeping viewers hooked with energy and personality',
          'dramatic': 'dramatic storytelling style, building tension and narrative arc',
          'casual': 'casual and conversational, like talking to a friend',
          'professional': 'professional news-style, authoritative and credible'
        };

        const prompt = `You are a professional YouTube script writer. Create a compelling video script for the following video:

Title: ${title}
Hook/Angle: ${hook}
Keywords: ${keywords}

Script Requirements:
- Length: ${lengthMap[length]}
- Style: ${styleMap[style]}
- Include a strong opening hook (first 5 seconds)
- Clear structure with introduction, main content, and conclusion
- Include natural pauses and transitions
- End with a clear call-to-action
- Write for spoken word (conversational, not academic)
- Use "you" to directly address the viewer

Format the script with clear sections like:
[HOOK - 0:00-0:05]
[INTRO - 0:05-0:20]
[MAIN CONTENT]
[CONCLUSION]
[CTA]

Make it engaging and optimized for viewer retention.`;

        const res = await fetch(`${API_BASE}/generate-script`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: prompt,
            title: title,
            hook: hook,
            description: keywords,
            length: length,
            style: style
          })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();

        if (!data.success || !data.script) {
          throw new Error(data.error || 'Failed to generate script');
        }

        // Display the script
        const scriptOutput = document.getElementById('scriptOutput');
        const scriptOutputRow = document.getElementById('scriptOutputRow');
        const copyBtn = document.getElementById('copyScript');

        scriptOutput.value = data.script;
        scriptOutputRow.style.display = 'block';
        copyBtn.style.display = 'inline-block';

        // Update stats
        const words = data.script.split(/\s+/).length;
        const duration = Math.round(words / 2.5); // ~150 words per minute = 2.5 words per second
        document.getElementById('scriptWordCount').textContent = `Words: ${words}`;
        document.getElementById('scriptDuration').textContent = `Est. Duration: ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;

        scriptStatus.className = 'status ok';
        scriptStatus.textContent = 'âœ… Script generated successfully!';
        showToast('ðŸŽ¬ Script generated!', 'success', 3000);

        // Track event
        trackEvent('script_generated', { length, style, words });

      } catch (e) {
        console.error('Script generation error:', e);
        scriptStatus.className = 'status err';
        scriptStatus.textContent = `Error: ${e.message}`;
        showToast(`âŒ Script generation failed: ${e.message}`, 'error', 5000);
      } finally {
        generateBtn.disabled = false;
        if (loadingBar) loadingBar.style.display = 'none';
      }
    });

    // Copy script button
    document.getElementById('copyScript')?.addEventListener('click', () => {
      const scriptOutput = document.getElementById('scriptOutput');
      scriptOutput.select();
      document.execCommand('copy');
      showToast('ðŸ“‹ Script copied to clipboard', 'success', 2000);
    });

    // Update word count on edit
    document.getElementById('scriptOutput')?.addEventListener('input', (e) => {
      const words = e.target.value.split(/\s+/).filter(w => w.length > 0).length;
      const duration = Math.round(words / 2.5);
      document.getElementById('scriptWordCount').textContent = `Words: ${words}`;
      document.getElementById('scriptDuration').textContent = `Est. Duration: ${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
    });

    // Welcome message with keyboard shortcuts
    setTimeout(() => {
      showToast('ðŸ’¡ Shortcuts: Ctrl+S (Generate Video), Esc (Cancel)', 'info', 6000);
    }, 1000);
  </script>
</body>
</html>













