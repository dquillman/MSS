<link rel="icon" href="favicon.jpg">
<script src="version.js" defer></script>
<style>
  @media (max-width: 768px) {
    .card {
      padding: 16px;
    }

    .card h1 {
      font-size: 24px;
    }

    .card>div[style*="display:flex"] {
      flex-direction: column;
      gap: 10px;
    }

    .btn {
      width: 100%;
      padding: 12px;
      font-size: 14px;
    }

    div[style*="grid-template-columns: 1fr 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }

  @media (max-width: 480px) {
    .card {
      padding: 12px;
    }

    .card h1 {
      font-size: 20px;
    }
  }
</style>
</head>

<body>

  <body>
    <!-- Theme Switcher Button -->
    <button class="theme-toggle-fixed" onclick="toggleTheme()" title="Switch Theme">
      <i class="ph ph-arrows-left-right"></i>
      <span>Switch Theme</span>
    </button>

    <!-- Premium Background -->
    <div class="bg-mesh"></div>

    <!-- Premium Sidebar -->
    <nav class="sidebar glass-panel">
      <div class="brand">
        <i class="ph-fill ph-video-camera" style="color: var(--primary);"></i>
        MSS Studio
      </div>
      <div style="display: flex; flex-direction: column; gap: 4px;">
        <a href="/dashboard" class="nav-item active"><i class="ph ph-squares-four"></i> Dashboard</a>
        <a href="studio.html" class="nav-item"><i class="ph ph-magic-wand"></i> Studio</a>
        <a href="/analytics-dashboard" class="nav-item"><i class="ph ph-chart-line-up"></i> Analytics</a>
        <a href="trends-calendar.html" class="nav-item"><i class="ph ph-calendar"></i> Trends</a>
        <a href="workflow.html" class="nav-item"><i class="ph ph-kanban"></i> Workflow</a>
      </div>
      <div style="margin-top: auto;">
        <a href="settings.html" class="nav-item"><i class="ph ph-gear"></i> Settings</a>
        <a href="#" onclick="logout()" class="nav-item" style="color: var(--accent);"><i class="ph ph-sign-out"></i>
          Logout</a>
      </div>
    </nav>

    <!-- Premium Header -->
    <header class="header glass-panel premium-header" style="border-top: none; border-left: none; border-right: none;">
      <div class="breadcrumbs">Home / <span>Dashboard</span></div>
      <div class="user-actions">
        <button class="icon-btn" onclick="window.location.href='settings.html'"><i class="ph ph-gear"></i></button>
        <div
          style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #ec4899);">
        </div>
      </div>
    </header>

    <!-- Main Content Wrapper -->
    <main class="main-content">
      <div class="content-scroll">

        <div id="loadingBar" class="loading-bar"></div>

        <!-- Header -->
        <div class="card classic-nav"
          style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
          <h1 style="margin:0;">Dashboard <span id="appVersion"
              style="font-size:14px; color:#64748b; font-weight:400;"></span></h1>
          <div style="display:flex; gap:10px; flex-wrap:wrap; flex:1; justify-content:flex-end;">
            <button class="btn" style="background:#22c55e; border-color:#22c55e; flex:1;"
              onclick="window.location.href='/workflow'">üìã Workflow</button>
            <button class="btn" style="background:#3b82f6; border-color:#3b82f6; flex:1;"
              onclick="window.location.href='/studio'">üé¨ Studio</button>
            <button class="btn" style="background:#8b5cf6; border-color:#8b5cf6; flex:1;"
              onclick="window.location.href='/trends-calendar'">üìä Trends</button>
            <button class="btn" style="flex:1;" onclick="window.location.href='/pricing'">üí∞ Pricing</button>
            <button class="btn" onclick="logout()" style="background:#ef4444; border-color:#ef4444; flex:1;">üö™
              Logout</button>
          </div>
        </div>

        <!-- Stats Cards -->
        <div
          style="max-width: 1000px; margin: 20px auto 0; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px;">
          <!-- Subscription Tier -->
          <div class="card"
            style="background:linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(17, 24, 39, 0.5)); border-color: #3b82f6; margin:0;">
            <h2 style="margin:0 0 10px 0; font-size:16px; color:#A8B3CF;">Current Plan</h2>
            <div style="font-size:32px; font-weight:900; color:#3b82f6; text-transform:capitalize;" id="planTier">Free
            </div>
            <div style="margin-top:8px; font-size:14px; color:#A8B3CF;" id="planLimit">3 videos/month</div>
            <button class="btn" onclick="window.location.href='/pricing'"
              style="margin-top:16px; background:#3b82f6; border-color:#3b82f6; width:100%;">Upgrade Plan</button>
          </div>

          <!-- Videos This Month -->
          <div class="card" style="margin:0;">
            <h2 style="margin:0 0 10px 0; font-size:16px; color:#A8B3CF;">Videos This Month</h2>
            <div style="font-size:32px; font-weight:900;" id="videosMonth">0</div>
            <div style="margin-top:8px; font-size:14px; color:#A8B3CF;" id="videoLimit">of 3 videos used</div>
            <div
              style="margin-top:12px; background:rgba(255,255,255,0.1); border-radius:10px; height:8px; overflow:hidden;">
              <div id="usageBar"
                style="height:100%; background:linear-gradient(90deg, #22c55e, #3b82f6); width:0%; transition:width 0.5s;">
              </div>
            </div>
          </div>

          <!-- Total Videos -->
          <div class="card" style="margin:0;">
            <h2 style="margin:0 0 10px 0; font-size:16px; color:#A8B3CF;">Total Videos Created</h2>
            <div style="font-size:32px; font-weight:900; color:#22c55e;" id="videosTotal">0</div>
            <div style="margin-top:8px; font-size:14px; color:#A8B3CF;">All time</div>
          </div>
        </div>

        <!-- Account Info -->
        <div class="card" style="margin-top:20px;">
          <h2 style="margin:0 0 20px 0;">Account Information</h2>
          <div style="display:grid; gap:16px;">
            <div>
              <div style="font-size:13px; color:#A8B3CF; margin-bottom:4px;">Email</div>
              <div style="font-size:15px; font-weight:600;" id="userEmailFull">loading...</div>
            </div>
            <div>
              <div style="font-size:13px; color:#A8B3CF; margin-bottom:4px;">Username</div>
              <div style="font-size:15px; font-weight:600;" id="username">loading...</div>
            </div>
            <div>
              <div style="font-size:13px; color:#A8B3CF; margin-bottom:4px;">Member Since</div>
              <div style="font-size:15px; font-weight:600;" id="memberSince">loading...</div>
            </div>
          </div>
        </div>

        <!-- Usage Limits -->
        <div class="card" style="margin-top:20px;">
          <h2 style="margin:0 0 20px 0;">Usage Limits</h2>
          <div id="limitsInfo"></div>
        </div>

        <!-- Subscription Management -->
        <div class="card" style="margin-top:20px;" id="subscriptionManagement">
          <h2 style="margin:0 0 20px 0;">Subscription Management</h2>
          <div id="subscriptionInfo">
            <div style="margin-bottom:20px;">
              <div style="font-size:13px; color:#A8B3CF; margin-bottom:4px;">Current Plan</div>
              <div style="font-size:24px; font-weight:700; text-transform:capitalize;" id="subPlanName">Loading...</div>
            </div>

            <div id="subscriptionActions" style="display:flex; gap:12px; flex-wrap:wrap;">
              <button class="btn" onclick="window.location.href='/pricing'"
                style="background:#3b82f6; border-color:#3b82f6;">
                üìà View All Plans
              </button>
              <button class="btn" id="manageSubBtn" style="background:#8b5cf6; border-color:#8b5cf6; display:none;">
                ‚öôÔ∏è Manage Subscription
              </button>
            </div>

            <div id="subDetails" style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1);">
            </div>
          </div>
        </div>

        <!-- Video Gallery -->
        <div class="card" style="margin-top:20px;">
          <h2 style="margin:0 0 20px 0;">My Videos</h2>
          <div id="videoGallery">
            <div style="text-align:center; padding:40px; color:#A8B3CF;">Loading videos...</div>
          </div>
        </div>

        <script>
          const API_BASE = window.location.origin;

          async function loadUserData() {
            const loadingBar = document.getElementById('loadingBar');
            if (loadingBar) loadingBar.style.display = 'block';

            try {
              // Get user info
              const userRes = await fetch(`${API_BASE}/api/me`, {
                credentials: 'include'
              });

              if (!userRes.ok) {
                // Not logged in, redirect to auth
                window.location.href = '/auth';
                return;
              }

              const userData = await userRes.json();
              if (!userData.success) {
                window.location.href = '/auth';
                return;
              }

              const user = userData.user;

              // Update UI
              document.getElementById('userEmailFull').textContent = user.email;
              document.getElementById('username').textContent = user.username || 'N/A';
              document.getElementById('planTier').textContent = user.subscription_tier || 'Free';
              document.getElementById('videosMonth').textContent = user.videos_this_month || 0;
              document.getElementById('videosTotal').textContent = user.total_videos || 0;

              // Get usage stats
              const usageRes = await fetch(`${API_BASE}/api/usage`, {
                credentials: 'include'
              });

              const usageData = await usageRes.json();
              if (usageData.success) {
                const usage = usageData.usage;

                // Update plan limit in Current Plan card
                document.getElementById('planLimit').textContent = `${usage.monthly_limit} videos/month`;

                // Update limits display
                const percentage = (usage.videos_this_month / usage.monthly_limit) * 100;
                const remaining = usage.videos_remaining;

                // Show limits info
                const limitsDiv = document.getElementById('limitsInfo');
                if (!usage.at_limit) {
                  limitsDiv.innerHTML = `
              <div style="margin-bottom:16px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                  <span style="font-weight:600;">${usage.videos_this_month} / ${usage.monthly_limit} videos used</span>
                  <span style="color:#A8B3CF;">${remaining} remaining</span>
                </div>
                <div style="background:rgba(255,255,255,0.1); border-radius:8px; height:8px; overflow:hidden;">
                  <div style="height:100%; width:${percentage}%; background:linear-gradient(90deg, ${percentage >= 90 ? '#ef4444' : percentage >= 70 ? '#f59e0b' : '#22c55e'}, ${percentage >= 90 ? '#dc2626' : percentage >= 70 ? '#d97706' : '#16a34a'}); transition:width 0.3s ease;"></div>
                </div>
              </div>
              <div style="padding:12px; background:rgba(34,197,94,0.1); border:1px solid #22c55e; border-radius:8px; color:#22c55e;">
                ‚úì You can create ${remaining} more video${remaining !== 1 ? 's' : ''} this month
              </div>
            `;
                } else {
                  limitsDiv.innerHTML = `
              <div style="margin-bottom:16px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                  <span style="font-weight:600;">${usage.videos_this_month} / ${usage.monthly_limit} videos used</span>
                  <span style="color:#ef4444;">Limit reached</span>
                </div>
                <div style="background:rgba(255,255,255,0.1); border-radius:8px; height:8px; overflow:hidden;">
                  <div style="height:100%; width:100%; background:linear-gradient(90deg, #ef4444, #dc2626);"></div>
                </div>
              </div>
              <div style="padding:12px; background:rgba(239,68,68,0.1); border:1px solid #ef4444; border-radius:8px; color:#ef4444; margin-bottom:12px;">
                ‚úó Monthly limit reached (${usage.monthly_limit} videos). Upgrade your plan for more videos.
              </div>
              <button class="btn" onclick="window.location.href='/pricing'" style="background:#3b82f6; border-color:#3b82f6;">Upgrade to Create More Videos</button>
            `;
                }

                // Format member since date
                if (user.created_at) {
                  const date = new Date(user.created_at);
                  document.getElementById('memberSince').textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  });
                }

                // Update subscription management section
                const subPlanName = document.getElementById('subPlanName');
                const subDetails = document.getElementById('subDetails');
                const tier = user.subscription_tier || 'free';

                subPlanName.textContent = tier.charAt(0).toUpperCase() + tier.slice(1);

                const planInfo = {
                  'free': { color: '#64748b', limit: '3 videos/month', price: 'Free' },
                  'starter': { color: '#3b82f6', limit: '10 videos/month', price: '$19/month' },
                  'pro': { color: '#8b5cf6', limit: '50 videos/month', price: '$49/month' },
                  'agency': { color: '#ec4899', limit: '200 videos/month', price: '$149/month' },
                  'lifetime': { color: '#f59e0b', limit: 'Unlimited videos', price: '$199 (one-time)' }
                };

                const info = planInfo[tier] || planInfo['free'];
                subPlanName.style.color = info.color;

                let detailsHTML = `
            <div style="display:grid; gap:12px;">
              <div>
                <div style="font-size:13px; color:#A8B3CF;">Plan Limit</div>
                <div style="font-size:15px; font-weight:600;">${info.limit}</div>
              </div>
              <div>
                <div style="font-size:13px; color:#A8B3CF;">Price</div>
                <div style="font-size:15px; font-weight:600;">${info.price}</div>
              </div>
          `;

                if (tier !== 'free') {
                  detailsHTML += `
              <div style="padding:12px; background:rgba(34,197,94,0.1); border:1px solid #22c55e; border-radius:8px; color:#22c55e;">
                ‚úì Premium features active
              </div>
            `;
                }

                detailsHTML += `</div>`;
                subDetails.innerHTML = detailsHTML;
              }

            } catch (error) {
              console.error('Error loading user data:', error);
              alert('Error loading dashboard. Please try again.');
            } finally {
              if (loadingBar) loadingBar.style.display = 'none';
            }
          }

          async function loadVideos() {
            const gallery = document.getElementById('videoGallery');

            try {
              const res = await fetch(`${API_BASE}/list-outputs?dir=out&limit=50`);
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              const data = await res.json();
              console.log('[Dashboard] Video data received:', data);

              let videos = Array.isArray(data.files) ? data.files : [];
              console.log('[Dashboard] Total files:', videos.length);

              // Filter to only show video files (mp4, mov, etc)
              videos = videos.filter(v => v.ext && /\.(mp4|mov|avi|mkv)$/i.test(v.ext));
              console.log('[Dashboard] Video files after filter:', videos.length);

              // Sort by modified time (newest first)
              videos.sort((a, b) => {
                const timeA = a.mtime || 0;
                const timeB = b.mtime || 0;
                return timeB - timeA;
              });

              // Take only the 10 most recent
              videos = videos.slice(0, 10);

              if (videos.length === 0) {
                gallery.innerHTML = '<div style="text-align:center; padding:40px; color:#A8B3CF;">No videos yet. Create your first video in the Studio!</div>';
                return;
              }

              const videosHTML = videos.map(video => {
                const date = video.mtime ? new Date(video.mtime * 1000).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric'
                }) : 'Unknown date';

                const sizeMB = video.size ? (video.size / (1024 * 1024)).toFixed(1) : '0.0';
                const videoUrl = `${API_BASE}/out/${video.path}`;

                return `
            <div style="display:flex; gap:12px; align-items:start; padding:12px; border:1px solid rgba(255,255,255,0.1); border-radius:8px; margin-bottom:10px;">
              <video src="${videoUrl}" style="width:160px; height:90px; object-fit:cover; border-radius:6px; background:#000;"></video>
              <div style="flex:1;">
                <div style="font-weight:600; margin-bottom:4px;">${video.path}</div>
                <div style="font-size:13px; color:#A8B3CF; margin-bottom:8px;">${date} ‚Ä¢ ${sizeMB} MB</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <a href="${videoUrl}" target="_blank" class="btn" style="background:#3b82f6; border-color:#3b82f6; padding:6px 12px; font-size:13px;">View</a>
                  <a href="${videoUrl}" download="${video.path}" class="btn" style="background:#22c55e; border-color:#22c55e; padding:6px 12px; font-size:13px;">Download</a>
                  <button class="btn" onclick="deleteVideo('${video.path}')" style="background:#ef4444; border-color:#ef4444; padding:6px 12px; font-size:13px;">Delete</button>
                </div>
              </div>
            </div>
          `;
              }).join('');

              gallery.innerHTML = videosHTML;

            } catch (error) {
              console.error('Error loading videos:', error);
              gallery.innerHTML = `<div style="text-align:center; padding:40px; color:#ef4444;">Error loading videos: ${error.message}</div>`;
            }
          }

          async function deleteVideo(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) return;

            try {
              const res = await fetch(`${API_BASE}/delete-output`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ path: filename, dir: 'out' })
              });

              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }

              const data = await res.json();

              if (data.success) {
                alert('Video deleted successfully!');
                loadVideos(); // Refresh the gallery
              } else {
                throw new Error(data.error || 'Failed to delete video');
              }
            } catch (error) {
              console.error('Error deleting video:', error);
              alert(`Error deleting video: ${error.message}`);
            }
          }

          async function logout() {
            if (!confirm('Are you sure you want to logout?')) return;

            try {
              const res = await fetch(`${API_BASE}/api/logout`, {
                method: 'POST',
                credentials: 'include'
              });

              if (res.ok) {
                window.location.href = '/auth?logout=true';
              } else {
                alert('Error logging out. Please try again.');
              }
            } catch (error) {
              console.error('Error logging out:', error);
              alert('Error logging out. Please try again.');
            }
          }

          // Load data on page load
          loadUserData();
          loadVideos();
        </script>
        <script>
          // Theme Switcher Logic
          function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('premium-mode')) {
              body.classList.remove('premium-mode');
              localStorage.setItem('mss_theme', 'classic');
            } else {
              body.classList.add('premium-mode');
              localStorage.setItem('mss_theme', 'premium');
            }
          }

          // Load saved theme
          (function () {
            const savedTheme = localStorage.getItem('mss_theme');
            if (savedTheme === 'premium') {
              document.body.classList.add('premium-mode');
            }
          })();
        </script>
  </body>
  </div> <!-- End content-scroll -->
  </main> <!-- End main-content -->

  </html>