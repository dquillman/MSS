<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Preview - MSS</title>
  <style>
    body {
      font-family: Inter, Arial, sans-serif;
      background: #0B0F19;
      color: #E8EBFF;
      margin: 0;
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }
    h2 { color: #E8EBFF; margin-bottom: 10px; }
    .subtitle { color: #A8B3CF; margin-bottom: 30px; font-size: 14px; }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .panel {
      background: #121826;
      border: 1px solid #2a3550;
      border-radius: 10px;
      padding: 20px;
    }

    .panel h3 {
      margin-top: 0;
      color: #3b82f6;
      font-size: 16px;
      border-bottom: 1px solid #2a3550;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .video-container {
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    video {
      width: 100%;
      height: auto;
      display: block;
    }

    .video-label {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }

    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .thumbnail-item {
      background: #0B0F19;
      border: 2px solid #2a3550;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .thumbnail-item:hover {
      border-color: #3b82f6;
      transform: scale(1.02);
    }

    .thumbnail-item.selected {
      border-color: #22c55e;
      background: #14532d;
    }

    .thumbnail-item img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      display: block;
      margin-bottom: 8px;
    }

    .thumbnail-label {
      text-align: center;
      font-size: 12px;
      color: #94a3b8;
      font-weight: 600;
    }

    .thumbnail-item.selected .thumbnail-label {
      color: #22c55e;
    }

    .metadata {
      background: #0f1419;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .metadata-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #1e293b;
    }

    .metadata-item:last-child {
      border-bottom: none;
    }

    .metadata-label {
      color: #64748b;
      font-size: 13px;
    }

    .metadata-value {
      color: #E8EBFF;
      font-size: 13px;
      font-weight: 600;
    }

    .script-preview {
      background: #0f1419;
      border-radius: 6px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.6;
      color: #cbd5e1;
    }

    button {
      padding: 12px 24px;
      border-radius: 6px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
    }

    button:hover { background: #1d4ed8; }

    .button-secondary {
      background: #334;
    }

    .button-secondary:hover {
      background: #445;
    }

    .button-success {
      background: #22c55e;
    }

    .button-success:hover {
      background: #16a34a;
    }

    .button-danger {
      background: #dc2626;
    }

    .button-danger:hover {
      background: #b91c1c;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-top: 20px;
      background: #1e293b;
      border-left: 4px solid #3b82f6;
    }

    .status.error {
      background: #7f1d1d;
      border-left-color: #dc2626;
    }

    .status.success {
      background: #14532d;
      border-left-color: #22c55e;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      background: #1e3a8a;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 6px;
      margin-bottom: 6px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    .comparison-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
      }
      .comparison-view {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="version.js" defer></script>
</head>
<body>
  <script>
    (function(){
      const group = document.querySelector("div[style*='gap: 10px']");
      if (group && !group.querySelector('[data-nav-studio]')) {
        const studio = document.createElement('button');
        studio.setAttribute('data-nav-studio','1');
        studio.textContent = 'Studio';
        studio.style.padding = '8px 16px'; studio.style.margin = '0';
        studio.onclick = () => { window.location.href = 'studio.html'; };
        group.prepend(studio);
        const viewer = document.createElement('button');
        viewer.textContent = 'Viewer';
        viewer.style.padding = '8px 16px'; viewer.style.margin = '0';
        viewer.onclick = () => { window.location.href = 'viewer.html'; };
        group.prepend(viewer);
      }
    })();
  </script>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h2 style="margin: 0;">üé¨ Video Preview & Quality Check <span style="font-size:14px; color:#64748b; font-weight:400;">v3.0.0</span></h2>
    <div style="display: flex; gap: 10px;">
      <button onclick="window.location.href='studio.html'" style="padding: 8px 16px; margin: 0;">Studio</button>
      <button onclick="window.location.href='intro-outro.html'" style="padding: 8px 16px; margin: 0;">üé¨ Intro/Outro</button>
      <button onclick="window.location.href='index.html'" style="padding: 8px 16px; margin: 0;">‚Üê Back to Topics</button>
    </div>
  </div>
  <p class="subtitle">Review your generated video and thumbnails before publishing</p>

  <div id="loading" class="loading">
    <h3>üìÇ Loading video files...</h3>
    <p>Please wait while we fetch your generated content</p>
  </div>

  <div id="content" style="display:none;">
    <!-- Video Comparison -->
    <div class="panel full-width">
      <h3>üì∫ Video Comparison</h3>
      <div class="comparison-view">
        <div>
          <div class="video-container">
            <div class="video-label">üì± SHORTS (1080√ó1920)</div>
            <video id="videoShorts" controls>
              <source id="shortsSource" type="video/mp4">
              Your browser does not support video playback.
            </video>
          </div>
          <div class="metadata">
            <div class="metadata-item">
              <span class="metadata-label">Format:</span>
              <span class="metadata-value">Vertical (9:16)</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Resolution:</span>
              <span class="metadata-value">1080√ó1920</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Duration:</span>
              <span class="metadata-value" id="shortsDuration">--</span>
            </div>
          </div>
        </div>

        <div>
          <div class="video-container">
            <div class="video-label">üñ•Ô∏è WIDE (1920√ó1080)</div>
            <video id="videoWide" controls>
              <source id="wideSource" type="video/mp4">
              Your browser does not support video playback.
            </video>
          </div>
          <div class="metadata">
            <div class="metadata-item">
              <span class="metadata-label">Format:</span>
              <span class="metadata-value">Horizontal (16:9)</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Resolution:</span>
              <span class="metadata-value">1920√ó1080</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Duration:</span>
              <span class="metadata-value" id="wideDuration">--</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Thumbnails -->
    <div class="panel full-width">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">üñºÔ∏è Thumbnail Options (Click to Select)</h3>
        <button onclick="regenerateDalleThumbnail()" class="button-secondary" style="margin: 0; padding: 8px 16px;">üé® Regenerate DALL-E</button>
      </div>
      <div class="thumbnail-grid" id="thumbnailGrid">
        <!-- Thumbnails will be loaded here -->
      </div>
      <div id="selectedThumb" style="margin-top:15px; color:#94a3b8; font-size:13px;">
        No thumbnail selected
      </div>
    </div>

    <div class="container">
      <!-- Script & Metadata -->
      <div class="panel">
        <h3>üìù Script & Metadata</h3>

        <div class="metadata" style="margin-bottom:15px;">
          <div class="metadata-item">
            <span class="metadata-label">Title:</span>
            <span class="metadata-value" id="videoTitle">--</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Word Count:</span>
            <span class="metadata-value" id="wordCount">--</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Keywords:</span>
            <div id="keywords"></div>
          </div>
        </div>

        <h4 style="color:#94a3b8; font-size:13px; margin-bottom:10px;">NARRATION:</h4>
        <div class="script-preview" id="narration">
          Loading script...
        </div>
      </div>

      <!-- Overlays -->
      <div class="panel">
        <h3>üí¨ Text Overlays</h3>
        <div id="overlays" class="script-preview">
          Loading overlays...
        </div>
      </div>
    </div>

    <!-- Sources Panel -->
    <div class="panel full-width">
      <h3>üìö Sources Used</h3>
      <div id="sources" style="color: #94a3b8; font-size: 14px;">
        Loading sources...
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="button-group">
      <button onclick="window.location.href='index.html'" class="button-secondary">‚Üê Back to Topics</button>
      <button onclick="regenerateVideo()" class="button-secondary">üîÑ Regenerate</button>
      <button onclick="downloadFiles()">‚òÅÔ∏è Upload to Drive</button>
      <button onclick="approveForPublish()" class="button-success">‚úÖ Approve & Publish</button>
    </div>

    <div id="status"></div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentData = null;
    let selectedThumbnail = null;

    // Load video data on page load
    async function loadPreview() {
      try {
        const response = await fetch(`${API_BASE}/get-latest-output`);

        if (!response.ok) {
          throw new Error('No video found. Please generate a video first.');
        }

        currentData = await response.json();

        // Hide loading, show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // Load videos
        if (currentData.files.shorts) {
          document.getElementById('shortsSource').src = `${API_BASE}/out/${currentData.files.shorts}`;
          document.getElementById('videoShorts').load();
        }

        if (currentData.files.wide) {
          document.getElementById('wideSource').src = `${API_BASE}/out/${currentData.files.wide}`;
          document.getElementById('videoWide').load();
        }

        // Load script data
        if (currentData.script) {
          document.getElementById('videoTitle').textContent = currentData.script.title || '--';
          document.getElementById('narration').textContent = currentData.script.narration || 'No narration found';
          document.getElementById('wordCount').textContent = (currentData.script.narration || '').split(' ').length;

          // Keywords
          const keywordsDiv = document.getElementById('keywords');
          (currentData.script.keywords || []).forEach(kw => {
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = kw;
            keywordsDiv.appendChild(badge);
          });

          // Overlays
          const overlaysDiv = document.getElementById('overlays');
          overlaysDiv.innerHTML = (currentData.script.overlays || [])
            .map((o, i) => `<div style="margin-bottom:10px;"><strong>${i+1}.</strong> ${o}</div>`)
            .join('');

          // Sources
          const sourcesDiv = document.getElementById('sources');
          const sources = currentData.script.sources || [];
          if (sources.length > 0) {
            sourcesDiv.innerHTML = `
              <div style="margin-bottom: 10px; font-weight: 600; color: #E8EBFF;">
                Total Sources: ${sources.length}
              </div>
              <ul style="list-style: none; padding: 0; margin: 0;">
                ${sources.map((source, i) => `
                  <li style="margin-bottom: 12px; padding: 10px; background: #0B0F19; border-radius: 6px; border-left: 3px solid #3b82f6;">
                    <div style="font-weight: 600; color: #E8EBFF; margin-bottom: 4px;">${i + 1}. ${source.title || 'Unknown Source'}</div>
                    ${source.url ? `<div style="font-size: 12px; color: #64748b; word-break: break-all;">${source.url}</div>` : ''}
                    ${source.description ? `<div style="margin-top: 4px; font-size: 13px; color: #94a3b8;">${source.description}</div>` : ''}
                  </li>
                `).join('')}
              </ul>
            `;
          } else {
            sourcesDiv.innerHTML = '<div style="color: #64748b;">No sources found for this video.</div>';
          }
        }

        // Load thumbnails
        loadThumbnails();

        // Set video durations when loaded
        document.getElementById('videoShorts').addEventListener('loadedmetadata', function() {
          document.getElementById('shortsDuration').textContent = formatDuration(this.duration);
        });

        document.getElementById('videoWide').addEventListener('loadedmetadata', function() {
          document.getElementById('wideDuration').textContent = formatDuration(this.duration);
        });

      } catch (error) {
        document.getElementById('loading').innerHTML = `
          <h3 style="color:#dc2626;">‚ùå Error Loading Preview</h3>
          <p>${error.message}</p>
          <button onclick="window.location.href='index.html'" class="button-secondary">‚Üê Back to Topics</button>
        `;
      }
    }

    function loadThumbnails() {
      const grid = document.getElementById('thumbnailGrid');
      grid.innerHTML = '';

      const thumbnails = [
        ...(currentData.files.thumbnail_files || []).map(f => ({name: f, label: f.replace('thumb_variant_', 'Variant ').replace('.jpg', '')})),
        currentData.files.ai_thumbnail ? {name: currentData.files.ai_thumbnail, label: 'AI Generated (DALL-E)'} : null
      ].filter(Boolean);

      thumbnails.forEach((thumb, idx) => {
        const item = document.createElement('div');
        item.className = 'thumbnail-item';
        item.onclick = () => selectThumbnail(idx, thumb.name);

        const img = document.createElement('img');
        img.src = `${API_BASE}/out/${thumb.name}`;
        img.alt = thumb.label;

        const label = document.createElement('div');
        label.className = 'thumbnail-label';
        label.textContent = thumb.label;

        item.appendChild(img);
        item.appendChild(label);
        grid.appendChild(item);

        // Auto-select first thumbnail
        if (idx === 0) {
          selectThumbnail(0, thumb.name);
        }
      });
    }

    function selectThumbnail(idx, name) {
      // Remove previous selection
      document.querySelectorAll('.thumbnail-item').forEach(item => {
        item.classList.remove('selected');
      });

      // Select new
      document.querySelectorAll('.thumbnail-item')[idx].classList.add('selected');
      selectedThumbnail = name;

      document.getElementById('selectedThumb').innerHTML = `
        ‚úÖ Selected: <strong>${name}</strong>
      `;
    }

    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function regenerateVideo() {
      if (confirm('Regenerate this video? This will create a new version.')) {
        window.location.href = 'edit-topic.html';
      }
    }

    async function downloadFiles() {
      if (!currentData) {
        alert('No video data loaded!');
        return;
      }

      if (!confirm('Upload all video files and thumbnails to Google Drive?')) {
        return;
      }

      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '<div class="status">‚òÅÔ∏è Uploading files to Google Drive...</div>';

      try {
        const response = await fetch(`${API_BASE}/upload-all-to-drive`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            files: {
              shorts: currentData.files.shorts,
              wide: currentData.files.wide,
              thumbnails: [...(currentData.files.thumbnail_files || []), currentData.files.ai_thumbnail].filter(Boolean),
              selected_thumbnail: selectedThumbnail
            }
          })
        });

        const result = await response.json();

        if (result.success) {
          if (result.background) {
            statusDiv.innerHTML = `<div class="status success">‚úÖ Upload started!<br><br>Files are being uploaded to Google Drive in the background.<br>Check the server console for progress.<br><br>You'll hear a bell sound when complete. üîî</div>`;
          } else {
            statusDiv.innerHTML = `<div class="status success">‚úÖ Files uploaded to Google Drive!<br><br>Uploaded ${result.uploaded_count} files<br><a href="${result.folder_url}" target="_blank" style="color: #3b82f6;">Open Drive Folder</a></div>`;
          }
        } else {
          statusDiv.innerHTML = `<div class="status error">‚ùå Upload failed: ${result.error}</div>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    }

    async function approveForPublish() {
      if (!selectedThumbnail) {
        alert('Please select a thumbnail first!');
        return;
      }

      const message = `Ready to archive and publish!\n\nShorts: ${currentData.files.shorts}\nWide: ${currentData.files.wide}\nThumbnail: ${selectedThumbnail}\n\nThis will create an archive folder with all files.`;

      if (!confirm(message)) return;

      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '<div class="status">üì¶ Archiving video files...</div>';

      try {
        const response = await fetch(`${API_BASE}/archive-video`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            topic_name: currentData.script?.title || 'video',
            thumbnail: selectedThumbnail
          })
        });

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = `<div class="status success">‚úÖ ${result.message}<br><br>Archive folder: <strong>${result.archive_folder}</strong><br>Files archived: ${result.archived_files.length}</div>`;
        } else {
          statusDiv.innerHTML = `<div class="status error">‚ùå Archive failed: ${result.error}</div>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    }

    async function regenerateDalleThumbnail() {
      if (!currentData || !currentData.script) {
        alert('No video data loaded!');
        return;
      }

      if (!confirm('Regenerate the DALL-E thumbnail? This will create a new AI-generated image.')) {
        return;
      }

      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = '<div class="status">üé® Generating new DALL-E thumbnail...</div>';

      try {
        const response = await fetch(`${API_BASE}/regenerate-dalle-thumbnail`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: currentData.script.title,
            description: currentData.script.description
          })
        });

        if (!response.ok) {
          throw new Error('Failed to regenerate thumbnail');
        }

        const result = await response.json();

        if (result.success) {
          statusDiv.innerHTML = '<div class="status success">‚úÖ New DALL-E thumbnail generated!</div>';
          // Reload thumbnails
          loadThumbnails();
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
      }
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadPreview);
  </script>
</body>
</html>

