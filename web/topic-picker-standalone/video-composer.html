<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Composer - MSS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verds-serif;
            background: linear-gradient(135deg, #0B0F19 0%, #1a2332 100%);
            color: #E8EBFF;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 {
            margin: 0;
            font-size: 2rem;
        }

        .version {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 400;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 16px;
            background: #334;
            border: 1px solid #334;
            color: #E8EBFF;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: #445;
        }

        .subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .video-card.required {
            border-color: #FFD700;
        }

        .video-card h3 {
            color: #FFD700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-preview {
            width: 100%;
            max-height: 300px;
            background: #000;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .placeholder {
            width: 100%;
            height: 200px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed #445;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
            margin-bottom: 15px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            z-index: 10;
            cursor: pointer;
        }

        .file-input-label {
            background: #2563eb;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            text-align: center;
            transition: all 0.3s;
            font-weight: 600;
        }

        .file-input-label:hover {
            background: #1d4ed8;
        }

        .file-name {
            margin-top: 10px;
            color: #94a3b8;
            font-size: 0.85rem;
            text-align: center;
        }

        .merge-section {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .merge-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #0B0F19;
            border: none;
            padding: 20px 60px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .merge-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .merge-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .status-message.success {
            background: rgba(52, 211, 153, 0.2);
            border: 1px solid #34d399;
            color: #34d399;
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .status-message.loading {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            color: #3b82f6;
        }

        .result-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 30px;
            display: none;
            text-align: center;
        }

        .result-video {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            display: block;
            border-radius: 8px;
        }

        .download-btn {
            background: #34d399;
            color: white;
            padding: 15px 40px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .download-btn:hover {
            background: #2dd38b;
            transform: translateY(-2px);
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
        }

        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .info-box li {
            margin-bottom: 5px;
            color: #94a3b8;
        }
    </style>
  <script src="version.js" defer></script>
</head>
<body>
  <script>
    (function(){
      const group = document.querySelector("div[style*='gap: 10px']");
      if (group && !group.querySelector('[data-nav-studio]')) {
        const studio = document.createElement('button');
        studio.setAttribute('data-nav-studio','1');
        studio.textContent = 'Studio';
        studio.style.padding = '8px 16px'; studio.style.margin = '0';
        studio.onclick = () => { window.location.href = 'studio.html'; };
        group.prepend(studio);
        const viewer = document.createElement('button');
        viewer.textContent = 'Viewer';
        viewer.style.padding = '8px 16px'; viewer.style.margin = '0';
        viewer.onclick = () => { window.location.href = 'viewer.html'; };
        group.prepend(viewer);
      }
    })();
  </script>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1> Video Composer <span class="version">v3.0.0</span></h1>
            <div class="nav-buttons">
                <button onclick="window.location.href='studio.html'" class="nav-btn" data-nav-studio="1">Studio</button>
                <button onclick="window.location.href='index.html'" class="nav-btn"> Topic Picker</button>
                <button onclick="window.location.href='avatar-manager.html'" class="nav-btn"> Avatars</button>
                <button onclick="window.location.href='intro-outro.html'" class="nav-btn"> Intro/Outro</button>
                <button onclick="window.location.href='post-process.html'" class="nav-btn"> Post-Process</button>
                <button onclick="window.location.href='preview.html'" class="nav-btn"> Preview</button>
            </div>
        </div>

        <p class="subtitle">Visual video composition: Preview and merge intro + main video + outro</p>

        <!-- Info Box -->
        <div class="info-box">
            <strong> How it works:</strong>
            <ul>
                <li>Upload your main video (required)</li>
                <li>Optionally upload custom intro/outro (or use defaults)</li>
                <li>Preview all three videos</li>
                <li>Click "Merge Videos" to create final video with intro + content + outro</li>
            </ul>
        </div>

        <!-- Video Grid -->
        <div class="video-grid">
            <!-- Intro Card -->
            <div class="video-card">
                <h3> Intro (3 seconds)</h3>
                <div class="placeholder" id="introPlaceholder">
                    Default intro will be used<br>
                    "MANY SOURCES SAY"
                </div>
                <video class="video-preview" id="introPreview" controls style="display: none;"></video>
                <div class="file-input-wrapper">
                    <label class="file-input-label">
                         Upload Custom Intro (Optional)
                        <input type="file" id="introFile" accept="video/*">
                    </label>
                </div>
                <div class="file-name" id="introFileName"></div>
            </div>

            <!-- Main Video Card -->
            <div class="video-card required">
                <h3> Main Video (Required)</h3>
                <div class="placeholder" id="mainPlaceholder">
                    Upload your main video content
                </div>
                <video class="video-preview" id="mainPreview" controls style="display: none;"></video>
                <div class="file-input-wrapper">
                    <label class="file-input-label">
                         Upload Main Video
                        <input type="file" id="mainFile" accept="video/*" required>
                    </label>
                </div>
                <div class="file-name" id="mainFileName"></div>
            </div>

                <button type="button" class="nav-btn" id="mainBrowseBtn">Browse</button>
            <!-- Outro Card -->
            <div class="video-card">
                <h3> Outro (3 seconds)</h3>
                <div class="placeholder" id="outroPlaceholder">
                    Default outro will be used<br>
                    "THANKS FOR WATCHING"
                </div>
                <video class="video-preview" id="outroPreview" controls style="display: none;"></video>
                <div class="file-input-wrapper">
                    <label class="file-input-label">
                         Upload Custom Outro (Optional)
                        <input type="file" id="outroFile" accept="video/*">
                    </label>
                </div>
                <div class="file-name" id="outroFileName"></div>
            </div>
        </div>

        <!-- Avatar Option -->
        <div style="background: rgba(255, 215, 0, 0.05); border: 1px solid #FFD700; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px;"> Talking Avatar (Optional)</h3>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 1.1rem; margin-bottom: 15px;">
                <input type="checkbox" id="addAvatarCheckbox" style="width: 24px; height: 24px; cursor: pointer;">
                <span>Add D-ID talking avatar to video (uses credits)</span>
            </label>

            <div id="avatarGenderOptions" style="margin-left: 34px; display: none;">
                <p style="color: #E8EBFF; font-size: 1rem; margin-bottom: 10px; font-weight: 500;">Select Avatar:</p>
                <select id="avatarSelect" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #94a3b8; background: #1a2332; color: #E8EBFF; font-size: 1rem;">
                    <option value="">Loading avatars...</option>
                </select>
            </div>

            <p style="color: #94a3b8; font-size: 0.9rem; margin-top: 10px; margin-left: 34px;">
                Avatar will be generated from the audio in your main video and overlaid on the final merged video
            </p>
        </div>

        <!-- Merge Section -->
        <div class="merge-section">
            <h2> Ready to Merge?</h2>
            <p style="color: #94a3b8; margin-top: 10px;">This will create: Intro + Main Video + Outro</p>
            <button class="merge-btn" id="mergeBtn" disabled>
                Merge Videos                Merge Videos
            </button>
            <div class="status-message" id="statusMessage"></div>
        </div>

        <!-- Result Section -->
        <div class="result-section" id="resultSection">
            <h2> Video Merged Successfully!</h2>
            <video class="result-video" id="resultVideo" controls></video>
            <a href="#" class="download-btn" id="downloadBtn" download> Download Final Video</a>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';

        // Load avatars from library
        async function loadAvatars() {
            try {
                const response = await fetch(`${API_BASE}/get-avatar-library`);
                const data = await response.json();

                if (data.success && data.avatars) {
                    const select = document.getElementById('avatarSelect');
                    select.innerHTML = '';

                    // Group avatars by gender
                    const maleAvatars = data.avatars.filter(a => a.gender === 'male');
                    const femaleAvatars = data.avatars.filter(a => a.gender === 'female');

                    // Add male avatars
                    if (maleAvatars.length > 0) {
                        const maleGroup = document.createElement('optgroup');
                        maleGroup.label = 'Male Avatars';
                        maleAvatars.forEach(avatar => {
                            const option = document.createElement('option');
                            option.value = avatar.id;
                            option.textContent = avatar.name;
                            option.dataset.gender = 'male';
                            maleGroup.appendChild(option);
                        });
                        select.appendChild(maleGroup);
                    }

                    // Add female avatars
                    if (femaleAvatars.length > 0) {
                        const femaleGroup = document.createElement('optgroup');
                        femaleGroup.label = 'Female Avatars';
                        femaleAvatars.forEach(avatar => {
                            const option = document.createElement('option');
                            option.value = avatar.id;
                            option.textContent = avatar.name;
                            option.dataset.gender = 'female';
                            femaleGroup.appendChild(option);
                        });
                        select.appendChild(femaleGroup);
                    }

                    // Select first option by default
                    if (select.options.length > 0) {
                        select.selectedIndex = 0;
                    }
                }
            } catch (error) {
                console.error('Failed to load avatars:', error);
                document.getElementById('avatarSelect').innerHTML = '<option value="">Failed to load avatars</option>';
            }
        }

        // Load avatars when page loads
        window.addEventListener('DOMContentLoaded', loadAvatars);
        // Sanitize any garbled UI strings at runtime
        function sanitizeUI() {
            try {
                const headerTitle = document.querySelector('.header h1');
                if (headerTitle) headerTitle.innerHTML = 'Video Composer <span class="version">v3.0.0</span>';
                const navs = document.querySelectorAll('.nav-buttons .nav-btn');
                const navTexts = ['Topic Picker','Avatars','Intro/Outro','Post-Process','Preview'];
                navs.forEach((btn, i) => { if (navTexts[i]) btn.textContent = navTexts[i]; });
                const infoStrong = document.querySelector('.info-box strong');
                if (infoStrong) infoStrong.textContent = 'How it works:';
                const h3s = document.querySelectorAll('.video-card h3');
                const h3Texts = ['Intro (3 seconds)','Main Video (Required)','Outro (3 seconds)'];
                h3s.forEach((h,i)=>{ if(h3Texts[i]) h.textContent = h3Texts[i]; });
                const labels = document.querySelectorAll('.video-card .file-input-label');
                const labelTexts = ['Upload Custom Intro (Optional)','Upload Main Video','Upload Custom Outro (Optional)'];
                labels.forEach((l,i)=>{ if(labelTexts[i]) l.textContent = labelTexts[i]; });
                const mergeHeader = document.querySelector('.merge-section h2');
                if (mergeHeader) mergeHeader.textContent = 'Ready to Merge?';
                const mergeBtn = document.getElementById('mergeBtn');
                if (mergeBtn) mergeBtn.textContent = 'Merge Videos';
                const resultH2 = document.querySelector('.result-section h2');
                if (resultH2) resultH2.textContent = 'Video Merged Successfully!';
                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) downloadBtn.textContent = 'Download Final Video';
            } catch(e) { console.warn('sanitizeUI failed', e); }
        }
        window.addEventListener('DOMContentLoaded', sanitizeUI);

        // File upload handlers
        function setupFileInput(inputId, previewId, placeholderId, fileNameId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);
            const fileName = document.getElementById(fileNameId);

            // Ensure clicking the label reliably opens the dialog (single path)
            try {
                const wrapper = input.closest('.file-input-wrapper');
                const label = wrapper ? wrapper.querySelector('.file-input-label') : null;
                if (label) {
                    label.addEventListener('click', function(ev) {
                        ev.preventDefault();
                        ev.stopPropagation();
                        input.click();
                    });
                }
            } catch {}

            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    fileName.textContent = file.name;

                    // Show video preview
                    const url = URL.createObjectURL(file);
                    preview.src = url;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';

                    // Enable merge button if main video is uploaded
                    checkMergeReady();
                }
            });
        }

        setupFileInput('introFile', 'introPreview', 'introPlaceholder', 'introFileName');
        setupFileInput('mainFile', 'mainPreview', 'mainPlaceholder', 'mainFileName');
        setupFileInput('outroFile', 'outroPreview', 'outroPlaceholder', 'outroFileName');
        // Removed broken auto-upload fallback to avoid JS parse errors
        // Browse button triggers for file inputs
        try { document.getElementById('mainBrowseBtn').addEventListener('click', () => document.getElementById('mainFile').click()); } catch {}


        // Show/hide avatar gender options based on checkbox
        document.getElementById('addAvatarCheckbox').addEventListener('change', function(e) {
            const genderOptions = document.getElementById('avatarGenderOptions');
            if (e.target.checked) {
                genderOptions.style.display = 'block';
            } else {
                genderOptions.style.display = 'none';
            }
        });

        function checkMergeReady() {
            const mainFile = document.getElementById('mainFile').files[0];
            const mergeBtn = document.getElementById('mergeBtn');

            if (mainFile) {
                mergeBtn.disabled = false;
            } else {
                mergeBtn.disabled = true;
            }
        }

        // Merge videos
        document.getElementById('mergeBtn').addEventListener('click', async function() {
            const statusMessage = document.getElementById('statusMessage');
            const mergeBtn = document.getElementById('mergeBtn');
            const resultSection = document.getElementById('resultSection');

            // Get files
            const mainFile = document.getElementById('mainFile').files[0];
            const introFile = document.getElementById('introFile').files[0];
            const outroFile = document.getElementById('outroFile').files[0];

            if (!mainFile) {
                alert('Please upload a main video');
                return;
            }

            // Disable button
            mergeBtn.disabled = true;
            mergeBtn.textContent = ' Merging...';

            // Show status
            statusMessage.style.display = 'block';
            statusMessage.className = 'status-message loading';
            statusMessage.textContent = 'Uploading videos and merging... This may take a few minutes...';

            // Hide previous results
            resultSection.style.display = 'none';

            try {
                // Create FormData
                const formData = new FormData();
                formData.append('video', mainFile);

                if (introFile) {
                    formData.append('intro_video', introFile);
                }

                if (outroFile) {
                    formData.append('outro_video', outroFile);
                }

                // Check if user wants talking avatar
                const addAvatar = document.getElementById('addAvatarCheckbox').checked;
                formData.append('use_did', addAvatar ? 'true' : 'false');
                formData.append('add_intro_outro', 'true');

                // Add avatar ID selection if avatar is enabled
                if (addAvatar) {
                    const avatarSelect = document.getElementById('avatarSelect');
                    const selectedAvatarId = avatarSelect.value;
                    const selectedOption = avatarSelect.options[avatarSelect.selectedIndex];
                    const avatarName = selectedOption ? selectedOption.textContent : 'avatar';

                    formData.append('avatar_id', selectedAvatarId);
                    statusMessage.textContent = `Generating talking avatar (${avatarName}) with D-ID... This may take 2-3 minutes...`;
                }

                // Send request
                const response = await fetch(`${API_BASE}/post-process-video`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Success!
                    statusMessage.className = 'status-message success';
                    statusMessage.textContent = 'Videos merged successfully!';

                    // Show result
                    resultSection.style.display = 'block';
                    const videoUrl = `${API_BASE}/out/${result.files.final_video}`;
                    document.getElementById('resultVideo').src = videoUrl;
                    document.getElementById('downloadBtn').href = videoUrl;

                    // Reset button
                    mergeBtn.disabled = false;
                    mergeBtn.textContent = ' Merge Another Video';
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }

            } catch (error) {
                console.error('Error:', error);
                statusMessage.className = 'status-message error';
                statusMessage.textContent = `Error: ${error.message}`;                statusMessage.textContent = `Error: ${error.message}`;

                mergeBtn.disabled = false;
                mergeBtn.textContent = \x27Merge Videos\x27;                mergeBtn.textContent = \x27Merge Videos\x27;
            }
        });
    </script>
</body>
</html>











