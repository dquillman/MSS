<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Dashboard - MSS Studio</title>
  <link rel="stylesheet" href="studio.css">
  <script src="version.js" defer></script>
  <style>
    .stat-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(17, 24, 39, 0.5));
      border: 1px solid #3b82f6;
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .stat-label {
      font-size: 12px;
      color: #A8B3CF;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #E8EBFF;
    }

    .stat-trend {
      font-size: 13px;
      margin-top: 4px;
    }

    .trend-up {
      color: #22c55e;
    }

    .trend-down {
      color: #ef4444;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .video-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .video-table th {
      background: #1a202c;
      padding: 12px;
      text-align: left;
      color: #A8B3CF;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #2a3550;
    }

    .video-table td {
      padding: 12px;
      border-bottom: 1px solid #2a3550;
      color: #E8EBFF;
    }

    .video-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .engagement-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .engagement-high {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .engagement-medium {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .engagement-low {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .chart-container {
      background: #1a202c;
      border: 1px solid #2a3550;
      border-radius: 10px;
      padding: 20px;
      margin-top: 24px;
      min-height: 300px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #A8B3CF;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .filter-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-bar select {
      padding: 8px 12px;
      background: #0f1419;
      border: 1px solid #2a3550;
      border-radius: 6px;
      color: #E8EBFF;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="loadingBar" class="loading-bar"></div>

  <!-- Header -->
  <div class="card" style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
    <h1 style="margin:0;">Performance Analytics</h1>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="window.location.href='workflow.html'">📋 Workflow</button>
      <button class="btn btn-primary" onclick="window.location.href='/dashboard'">Dashboard</button>
      <button class="btn btn-primary" onclick="window.location.href='studio.html'">Studio</button>
      <button class="btn btn-primary" onclick="window.location.href='channel-manager.html'">Channels</button>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="card">
    <div class="filter-bar">
      <label style="color:#A8B3CF; font-weight:600;">Time Period:</label>
      <select id="timePeriod" onchange="loadDashboard()">
        <option value="7">Last 7 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="90">Last 90 Days</option>
        <option value="365">Last Year</option>
      </select>
      <div style="flex:1; text-align:center; font-size:20px;">
        <span style="font-weight:600; color:#A8B3CF;">Channel: </span>
        <span id="channelName" style="font-weight:900; color:#3b82f6; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);">Loading...</span>
      </div>
      <button class="btn btn-success" onclick="loadDashboard()">Refresh</button>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="card">
    <h2 style="margin-top:0;">Overview</h2>
    <div class="stats-grid" id="statsGrid">
      <div style="text-align:center; padding:40px; color:#A8B3CF; grid-column:1/-1;">Loading analytics...</div>
    </div>
  </div>

  <!-- Best Performing Video -->
  <div class="card" id="bestVideoCard" style="display:none;">
    <h2 style="margin-top:0;">Top Performer</h2>
    <div id="bestVideoContent"></div>
  </div>

  <!-- Recent Videos Table -->
  <div class="card">
    <h2 style="margin-top:0;">Recent Videos</h2>
    <div id="videosTableContainer">
      <div style="text-align:center; padding:40px; color:#A8B3CF;">Loading videos...</div>
    </div>
  </div>

  <!-- Mock Performance Chart -->
  <div class="card">
    <h2 style="margin-top:0;">Views Over Time</h2>
    <div class="chart-container" id="chartContainer">
      <div style="text-align:center; padding:60px; color:#A8B3CF;">
        Chart visualization coming soon<br>
        <span style="font-size:14px;">Integrate with Chart.js or D3.js for visualizations</span>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    // Load channel name
    async function loadChannelName() {
      try {
        const res = await fetch(`${API_BASE}/api/channels/list`, {
          credentials: 'include'
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();
        console.log('[Channel Name] API response:', data);

        if (data.success && data.channels && data.channels.length > 0) {
          // Find the default channel or use the first one
          const defaultChannel = data.channels.find(ch => ch.is_default) || data.channels[0];
          console.log('[Channel Name] Selected channel:', defaultChannel);
          document.getElementById('channelName').textContent = defaultChannel.channel_name || defaultChannel.channel_id || 'Unknown Channel';
        } else {
          console.log('[Channel Name] No channels found');
          document.getElementById('channelName').textContent = 'No channel connected';
        }
      } catch (error) {
        console.error('[Channel Name] Error:', error);
        document.getElementById('channelName').textContent = 'Channel info unavailable';
      }
    }

    // Load dashboard data
    async function loadDashboard() {
      const days = document.getElementById('timePeriod').value;
      const statsGrid = document.getElementById('statsGrid');
      const bestVideoCard = document.getElementById('bestVideoCard');
      const bestVideoContent = document.getElementById('bestVideoContent');

      // Show loading
      statsGrid.innerHTML = '<div style="text-align:center; padding:40px; color:#A8B3CF; grid-column:1/-1;">Loading analytics...</div>';

      try {
        const res = await fetch(`${API_BASE}/api/analytics/dashboard?days=${days}`, {
          credentials: 'include'
        });

        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load analytics');
        }

        const stats = data.stats;

        // Render stats grid
        statsGrid.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Videos</div>
            <div class="stat-value">${stats.total_videos}</div>
            <div class="stat-trend">${stats.published_videos} published</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Views</div>
            <div class="stat-value">${formatNumber(stats.total_views)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Likes</div>
            <div class="stat-value">${formatNumber(stats.total_likes)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Comments</div>
            <div class="stat-value">${formatNumber(stats.total_comments)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Engagement</div>
            <div class="stat-value">${stats.avg_engagement_rate}%</div>
          </div>
        `;

        // Show best video if available
        if (stats.best_video && stats.best_video.title !== 'N/A') {
          bestVideoCard.style.display = 'block';
          bestVideoContent.innerHTML = `
            <div style="background:linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(17, 24, 39, 0.5)); border:1px solid #22c55e; border-radius:10px; padding:20px;">
              <div style="font-size:18px; font-weight:700; color:#E8EBFF; margin-bottom:8px;">${stats.best_video.title}</div>
              <div style="display:flex; gap:20px; margin-top:12px;">
                <div>
                  <div style="font-size:11px; color:#A8B3CF; text-transform:uppercase;">Views</div>
                  <div style="font-size:24px; font-weight:700; color:#22c55e;">${formatNumber(stats.best_video.views)}</div>
                </div>
                <div>
                  <div style="font-size:11px; color:#A8B3CF; text-transform:uppercase;">Engagement</div>
                  <div style="font-size:24px; font-weight:700; color:#22c55e;">${stats.best_video.engagement_rate}%</div>
                </div>
              </div>
            </div>
          `;
        } else {
          bestVideoCard.style.display = 'none';
        }

      } catch (error) {
        console.error('Error loading dashboard:', error);
        statsGrid.innerHTML = `<div style="text-align:center; padding:40px; color:#ef4444; grid-column:1/-1;">Error: ${error.message}</div>`;
      }

      // Load videos table
      loadVideosTable();
    }

    // Load videos table
    async function loadVideosTable() {
      const container = document.getElementById('videosTableContainer');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:#A8B3CF;">Loading videos...</div>';

      try {
        const res = await fetch(`${API_BASE}/api/analytics/videos?limit=20`, {
          credentials: 'include'
        });

        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load videos');
        }

        const videos = data.videos || [];

        if (videos.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">🎥</div>
              <div>No videos yet</div>
              <div style="font-size:14px; margin-top:8px;">Videos you create will appear here with performance metrics</div>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <table class="video-table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Platform</th>
                <th>Created</th>
                <th>Views</th>
                <th>Likes</th>
                <th>Comments</th>
                <th>Engagement</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${videos.map(video => `
                <tr>
                  <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${video.title || 'Untitled'}</td>
                  <td style="text-transform:capitalize;">${video.platform || 'youtube'}</td>
                  <td>${formatDate(video.created_at)}</td>
                  <td>${formatNumber(video.views || 0)}</td>
                  <td>${formatNumber(video.likes || 0)}</td>
                  <td>${formatNumber(video.comments || 0)}</td>
                  <td>${getEngagementBadge(video.engagement_rate)}</td>
                  <td>${getStatusBadge(video.status)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

      } catch (error) {
        console.error('Error loading videos:', error);
        container.innerHTML = `<div style="text-align:center; padding:40px; color:#ef4444;">Error: ${error.message}</div>`;
      }
    }

    // Helper functions
    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getEngagementBadge(rate) {
      if (!rate || rate === 0) return '<span class="engagement-badge engagement-low">0%</span>';
      const r = parseFloat(rate);
      if (r >= 5) return `<span class="engagement-badge engagement-high">${r.toFixed(1)}%</span>`;
      if (r >= 2) return `<span class="engagement-badge engagement-medium">${r.toFixed(1)}%</span>`;
      return `<span class="engagement-badge engagement-low">${r.toFixed(1)}%</span>`;
    }

    function getStatusBadge(status) {
      const statusColors = {
        'created': '#64748b',
        'published': '#22c55e',
        'processing': '#3b82f6',
        'failed': '#ef4444'
      };
      const color = statusColors[status] || '#64748b';
      return `<span style="padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; background:${color}20; color:${color};">${status || 'unknown'}</span>`;
    }

    // Demo function to add sample data
    async function addDemoData() {
      if (!confirm('Add demo analytics data? This will create sample video records.')) return;

      const demoVideos = [
        { title: 'AI Tools 2025: Complete Guide', views: 12500, likes: 450, comments: 89 },
        { title: 'Best Side Hustles to Start Today', views: 8900, likes: 320, comments: 67 },
        { title: 'Travel Tips for Europe on a Budget', views: 5600, likes: 198, comments: 45 },
        { title: 'Fitness Transformation in 30 Days', views: 3200, likes: 145, comments: 32 }
      ];

      for (const video of demoVideos) {
        try {
          // Track video creation
          const trackRes = await fetch(`${API_BASE}/api/analytics/track-video`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              title: video.title,
              description: `Demo video: ${video.title}`,
              filename: `demo_${Date.now()}.mp4`,
              topic_data: {}
            })
          });

          const trackData = await trackRes.json();

          if (trackData.success) {
            // Add metrics
            await fetch(`${API_BASE}/api/analytics/update-metrics`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                video_id: trackData.video_id,
                metrics: {
                  views: video.views,
                  likes: video.likes,
                  comments: video.comments,
                  shares: Math.floor(video.likes * 0.1)
                },
                platform: 'youtube'
              })
            });
          }
        } catch (e) {
          console.error('Error adding demo data:', e);
        }
      }

      alert('Demo data added! Refreshing dashboard...');
      loadDashboard();
    }

    // Sync YouTube metrics
    async function syncYouTubeMetrics() {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Syncing...';

      try {
        const res = await fetch(`${API_BASE}/api/youtube/sync-metrics`, {
          method: 'POST',
          credentials: 'include'
        });

        // Check for authentication errors before parsing JSON
        if (res.status === 401 || res.status === 403) {
          alert('❌ Authentication required\n\nPlease log in to sync YouTube metrics.');
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        // Check response status before parsing
        if (!res.ok) {
          // For 400 errors, try to get error message
          let errorMessage = `HTTP ${res.status}: Sync failed`;
          try {
            const errorData = await res.json();
            errorMessage = errorData.error || errorMessage;
          } catch {
            // If JSON parsing fails, use status text
            errorMessage = res.statusText || errorMessage;
          }
          
          // Check if it's a "not connected" error
          if (res.status === 400 && (errorMessage.toLowerCase().includes('not connected') || errorMessage.toLowerCase().includes('credentials'))) {
            alert('❌ YouTube not connected\n\nPlease connect your YouTube account first in the Channel Manager.');
          } else {
            throw new Error(errorMessage);
          }
          btn.disabled = false;
          btn.textContent = originalText;
          return;
        }

        const data = await res.json();

        if (!data.success) {
          throw new Error(data.error || 'Sync failed');
        }

        alert(`✓ YouTube Sync Complete!\n\n${data.message}\n\nTotal Videos: ${data.total}\nNew Videos: ${data.synced}\nUpdated: ${data.updated}`);
        loadDashboard(); // Refresh dashboard
      } catch (error) {
        // Don't log handled errors (not connected, auth errors)
        if (!error.message.includes('not connected') && !error.message.includes('Authentication required')) {
          console.error('YouTube sync error:', error);
        }
        
        if (error.message.includes('not connected') || error.message.includes('credentials')) {
          // Already handled above
        } else {
          alert(`❌ Sync failed: ${error.message}`);
        }
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // Add buttons to header (for testing and sync)
    window.addEventListener('DOMContentLoaded', () => {
      const header = document.querySelector('.card');
      const btnDiv = header.querySelector('div:last-child');

      // YouTube Sync button
      const syncBtn = document.createElement('button');
      syncBtn.className = 'btn';
      syncBtn.textContent = 'Sync from YouTube';
      syncBtn.style.background = '#FF0000';
      syncBtn.style.borderColor = '#FF0000';
      syncBtn.onclick = syncYouTubeMetrics;
      btnDiv.insertBefore(syncBtn, btnDiv.firstChild);
    });

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadChannelName();
      loadDashboard();
    });
  </script>
</body>
</html>
