<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avatar Manager - MSS</title>
  <style>
    body {
      font-family: Inter, Arial, sans-serif;
      background: #0B0F19;
      color: #E8EBFF;
      margin: 0;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    h2 { color: #E8EBFF; margin-bottom: 10px; }
    .subtitle { color: #A8B3CF; margin-bottom: 30px; font-size: 14px; }

    .panel {
      background: #121826;
      border: 1px solid #2a3550;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .panel h3 {
      margin-top: 0;
      color: #3b82f6;
      font-size: 16px;
      border-bottom: 1px solid #2a3550;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .card {
      background: #0f1419;
      border: 3px solid #2a3550;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
    }

    .card.selected {
      border-color: #34d399;
      background: rgba(52, 211, 153, 0.05);
      box-shadow: 0 0 20px rgba(52, 211, 153, 0.3);
    }

    .card-title {
      font-weight: 600;
      font-size: 14px;
      color: #E8EBFF;
      margin-bottom: 10px;
    }

    .card-preview {
      background: #000;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 10px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #64748b;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .card-preview img {
      max-width: 100%;
      max-height: 180px;
      object-fit: contain;
    }

    .card-info {
      color: #94a3b8;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .card-actions button {
      flex: 1;
      padding: 6px;
      font-size: 12px;
    }

    button {
      padding: 12px 24px;
      border-radius: 6px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover { background: #1d4ed8; }

    .button-secondary {
      background: #334;
    }

    .button-secondary:hover {
      background: #445;
    }

    .button-success {
      background: #22c55e;
    }

    .button-success:hover {
      background: #16a34a;
    }

    .button-danger {
      background: #dc2626;
    }

    .button-danger:hover {
      background: #b91c1c;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: #94a3b8;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      background: #0f1419;
      border: 1px solid #2a3550;
      border-radius: 6px;
      color: #E8EBFF;
      font-size: 14px;
      font-family: Inter, Arial, sans-serif;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      background: #1e293b;
      border-left: 4px solid #3b82f6;
    }

    .status.error {
      background: #7f1d1d;
      border-left-color: #dc2626;
    }

    .status.success {
      background: #14532d;
      border-left-color: #22c55e;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      background: #1e3a8a;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
      color: #E8EBFF;
    }

    .badge.active {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #34d399;
      color: #0B0F19;
      padding: 6px 14px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      margin-left: 0;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #121826;
      border: 1px solid #2a3550;
      border-radius: 10px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 18px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 20px;
    }

    .help-text {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 8px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 400;
    }

    .radio-group input[type="radio"] {
      width: auto;
      cursor: pointer;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="version.js" defer></script>
</head>
<body>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h2 style="margin: 0;">üë§ Avatar Manager <span style="font-size:14px; color:#64748b; font-weight:400;">v3.0.0</span></h2>
    <div style="display:flex; gap:10px;">
      <button onclick="window.location.href='studio.html'" class="button-secondary">Studio</button>
      <button onclick="window.location.href='index.html'" class="button-secondary">‚Üê Back to Topics</button>
    </div>
  </div>
  <p class="subtitle">Manage video avatars. Create custom avatars and select which one appears in your videos.</p>

  <!-- Avatars Section -->
  <div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;">üé≠ Avatars</h3>
      <button onclick="openAddModal()" style="padding: 8px 16px; margin: 0;">+ Add Avatar</button>
    </div>

    <div class="grid" id="avatarGrid">
      <!-- Avatars will be loaded here -->
    </div>
  </div>

  <div id="status"></div>

  <!-- Add/Edit Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Add Avatar</div>

      <div class="form-group">
        <label for="avatarName">Name</label>
        <input type="text" id="avatarName" placeholder="e.g., News Anchor Sarah">
      </div>

      <div class="form-group">
        <label>Avatar Type</label>
        <div class="radio-group">
          <label>
            <input type="radio" name="avatarType" value="image" checked onchange="toggleAvatarType()">
            Static Image
          </label>
          <label>
            <input type="radio" name="avatarType" value="video" onchange="toggleAvatarType()">
            Video/Animated
          </label>
        </div>
        <div class="help-text">Choose between a static image or animated video avatar</div>
      </div>

      <div class="form-group" id="imageUrlGroup">
        <label for="avatarImageUrl">Image URL</label>
        <div style="display: flex; gap: 10px; margin-bottom: 8px;">
          <input type="text" id="avatarImageUrl" placeholder="https://example.com/avatar.png" style="flex: 1;" oninput="previewImageUrl()">
          <button type="button" onclick="document.getElementById('imageFileInput').click()" class="button-secondary" style="padding: 10px 16px; margin: 0;">üìÅ Upload</button>
        </div>
        <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="uploadImageFile(this)">
        <div class="help-text">Direct URL to avatar image (PNG, JPG, etc.) or upload a local file</div>
        <div id="imageUploadStatus" style="font-size: 12px; margin-top: 4px;"></div>

        <!-- Image Preview -->
        <div id="imagePreviewContainer" style="display: none; margin-top: 10px; padding: 10px; background: #000; border-radius: 6px; text-align: center;">
          <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">Preview:</div>
          <img id="imagePreview" style="max-width: 100%; max-height: 200px; border-radius: 4px;" />
          <div id="imagePreviewError" style="color: #dc2626; font-size: 12px; margin-top: 8px; display: none;"></div>
        </div>
      </div>

      <div class="form-group" id="videoUrlGroup" style="display: none;">
        <label for="avatarVideoUrl">Video URL</label>
        <div style="display: flex; gap: 10px; margin-bottom: 8px;">
          <input type="text" id="avatarVideoUrl" placeholder="https://example.com/avatar.mp4" style="flex: 1;">
          <button type="button" onclick="document.getElementById('videoFileInput').click()" class="button-secondary" style="padding: 10px 16px; margin: 0;">üìÅ Upload</button>
        </div>
        <input type="file" id="videoFileInput" accept="video/*" style="display: none;" onchange="uploadVideoFile(this)">
        <div class="help-text">Direct URL to avatar video (MP4, transparent background recommended) or upload a local file</div>
        <div id="videoUploadStatus" style="font-size: 12px; margin-top: 4px;"></div>
      </div>

      <div class="form-group">
        <label for="avatarPosition">Position</label>
        <select id="avatarPosition">
          <option value="bottom-right">Bottom Right</option>
          <option value="bottom-left">Bottom Left</option>
          <option value="top-right">Top Right</option>
          <option value="top-left">Top Left</option>
          <option value="center">Center</option>
        </select>
        <div class="help-text">Where the avatar appears on screen</div>
      </div>

      <div class="form-group">
        <label for="avatarScale">Scale (%)</label>
        <input type="number" id="avatarScale" value="25" min="10" max="100" step="5">
        <div class="help-text">Size of avatar relative to video (10-100%)</div>
      </div>

      <div class="form-group">
        <label for="avatarOpacity">Opacity (%)</label>
        <input type="number" id="avatarOpacity" value="100" min="50" max="100" step="5">
        <div class="help-text">Transparency level (50-100%)</div>
      </div>

      <div class="form-group">
        <label for="avatarGender">Gender</label>
        <select id="avatarGender">
          <option value="female">Female</option>
          <option value="male">Male</option>
        </select>
        <div class="help-text">Avatar gender (for automatic voice matching)</div>
      </div>

      <div class="form-group">
        <label for="avatarVoice">Voice/Accent</label>
        <select id="avatarVoice">
          <option value="en-US-Neural2-F">US Female (Neural)</option>
          <option value="en-US-Neural2-J">US Male (Neural)</option>
          <option value="en-GB-Neural2-A">British Female (Neural)</option>
          <option value="en-GB-Neural2-B">British Male (Neural)</option>
          <option value="en-AU-Neural2-A">Australian Female (Neural)</option>
          <option value="en-AU-Neural2-B">Australian Male (Neural)</option>
          <option value="en-IN-Neural2-A">Indian Female (Neural)</option>
          <option value="en-IN-Neural2-B">Indian Male (Neural)</option>
          <option value="en-US-Studio-O">US Female Studio (Expressive)</option>
          <option value="en-US-Studio-Q">US Male Studio (Expressive)</option>
          <option value="en-US-News-K">US Female (News)</option>
          <option value="en-US-News-L">US Male (News)</option>
        </select>
        <div class="help-text">TTS voice for video narration when this avatar is active</div>
      </div>

      <div class="button-group">
        <button onclick="closeModal()" class="button-secondary">Cancel</button>
        <button onclick="testAvatarPreview()" style="background: #7c3aed;">üé¨ Test Preview</button>
        <button onclick="saveAvatar()" class="button-success">Save</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000';
    let currentEditId = null;

    function toggleAvatarType() {
      const type = document.querySelector('input[name="avatarType"]:checked').value;
      document.getElementById('imageUrlGroup').style.display = type === 'image' ? 'block' : 'none';
      document.getElementById('videoUrlGroup').style.display = type === 'video' ? 'block' : 'none';
    }

    // Load avatars on page load
    async function loadAvatars() {
      try {
        const response = await fetch(`${API_BASE}/get-avatar-library`);
        const data = await response.json();

        if (data.success) {
          renderAvatars(data.avatars || []);
        }
      } catch (error) {
        console.error('Error loading avatars:', error);
        showStatus('Failed to load avatar library', 'error');
      }
    }

    function renderAvatars(avatars) {
      const grid = document.getElementById('avatarGrid');

      if (avatars.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#64748b; padding:40px;">No avatars yet. Click "+ Add Avatar" to create one.</div>';
        return;
      }

      grid.innerHTML = avatars.map((avatar) => `
        <div class="card ${avatar.active ? 'selected' : ''}" onclick="toggleActive('${avatar.id}')">
          ${avatar.active ? '<span class="badge active">ACTIVE</span>' : ''}
          <div class="card-title">${avatar.name}</div>
          <div class="card-preview">
            ${avatar.type === 'image' && avatar.image_url ? `<img src="${avatar.image_url}" alt="${avatar.name}">` :
              avatar.type === 'video' ? 'üé¨ Video Avatar' : 'No preview'}
          </div>
          <div class="card-info">
            Type: ${avatar.type === 'image' ? 'Image' : 'Video'} | Position: ${avatar.position} | Scale: ${avatar.scale}%<br>
            Voice: ${avatar.voice ? avatar.voice.replace('en-', '').replace('Neural2-', '').replace('Studio-', '') : 'Default'}
          </div>
          <div class="card-actions">
            <button onclick="event.stopPropagation(); editAvatar('${avatar.id}')" class="button-secondary">Edit</button>
            <button onclick="event.stopPropagation(); deleteAvatar('${avatar.id}')" class="button-danger">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function openAddModal() {
      currentEditId = null;
      document.getElementById('modalTitle').textContent = 'Add Avatar';
      document.getElementById('avatarName').value = '';
      document.querySelector('input[name="avatarType"][value="image"]').checked = true;
      document.getElementById('avatarImageUrl').value = '';
      document.getElementById('avatarVideoUrl').value = '';
      document.getElementById('avatarPosition').value = 'bottom-right';
      document.getElementById('avatarScale').value = '25';
      document.getElementById('avatarOpacity').value = '100';
      document.getElementById('avatarGender').value = 'female';
      document.getElementById('avatarVoice').value = 'en-US-Neural2-F';
      toggleAvatarType();
      document.getElementById('addModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('addModal').classList.remove('show');
    }

    function testAvatarPreview() {
      const type = document.querySelector('input[name="avatarType"]:checked').value;
      const imageUrl = document.getElementById('avatarImageUrl').value.trim();
      const videoUrl = document.getElementById('avatarVideoUrl').value.trim();
      const position = document.getElementById('avatarPosition').value;
      const scale = parseInt(document.getElementById('avatarScale').value);
      const opacity = parseInt(document.getElementById('avatarOpacity').value);

      const url = type === 'image' ? imageUrl : videoUrl;

      if (!url) {
        showStatus('Please enter or upload an image/video URL first', 'error');
        return;
      }

      // Create a test preview window
      const previewHtml = `
<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #0B0F19;
      color: #E8EBFF;
      font-family: Arial, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h2 { color: #3b82f6; }
    .preview-frame {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: linear-gradient(135deg, #0B0F19 0%, #1a2332 100%);
      border: 2px solid #2a3550;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .avatar {
      position: absolute;
      ${position === 'bottom-right' ? 'bottom: 5%; right: 5%;' : ''}
      ${position === 'bottom-left' ? 'bottom: 5%; left: 5%;' : ''}
      ${position === 'top-right' ? 'top: 5%; right: 5%;' : ''}
      ${position === 'top-left' ? 'top: 5%; left: 5%;' : ''}
      ${position === 'center' ? 'top: 50%; left: 50%; transform: translate(-50%, -50%);' : ''}
      opacity: ${opacity / 100};
      width: ${scale}%;
      max-width: ${scale}%;
    }
    .avatar img, .avatar video {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }
    .info {
      background: #121826;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé¨ Avatar Test Preview</h2>
    <div class="preview-frame">
      <div class="avatar">
        ${type === 'image' ? `<img src="${url}" onerror="this.parentElement.innerHTML='<div style=\\'color:#dc2626;padding:20px;\\'>‚ùå Failed to load image</div>'" />` :
          `<video src="${url}" autoplay loop muted onerror="this.parentElement.innerHTML='<div style=\\'color:#dc2626;padding:20px;\\'>‚ùå Failed to load video</div>'"></video>`}
      </div>
    </div>
    <div class="info">
      <div class="info-row"><strong>Type:</strong> <span>${type === 'image' ? 'Static Image' : 'Video'}</span></div>
      <div class="info-row"><strong>Position:</strong> <span>${position}</span></div>
      <div class="info-row"><strong>Scale:</strong> <span>${scale}%</span></div>
      <div class="info-row"><strong>Opacity:</strong> <span>${opacity}%</span></div>
      <div class="info-row"><strong>URL:</strong> <span style="word-break: break-all; font-size: 12px;">${url}</span></div>
    </div>
    <p style="color: #94a3b8; margin-top: 20px;">
      ‚ÑπÔ∏è This preview shows how your avatar will appear in videos. If the image/video doesn't load, check the URL or try uploading again.
    </p>
  </div>
</body>
</html>
      `;

      const previewWindow = window.open('', 'AvatarPreview', 'width=1200,height=800');
      previewWindow.document.write(previewHtml);
      previewWindow.document.close();
    }

    async function saveAvatar() {
      const name = document.getElementById('avatarName').value.trim();
      const type = document.querySelector('input[name="avatarType"]:checked').value;
      const imageUrl = document.getElementById('avatarImageUrl').value.trim();
      const videoUrl = document.getElementById('avatarVideoUrl').value.trim();
      const position = document.getElementById('avatarPosition').value;
      const scale = parseInt(document.getElementById('avatarScale').value);
      const opacity = parseInt(document.getElementById('avatarOpacity').value);
      const gender = document.getElementById('avatarGender').value;
      const voice = document.getElementById('avatarVoice').value;

      if (!name) {
        showStatus('Please enter a name', 'error');
        return;
      }

      if (type === 'image' && !imageUrl) {
        showStatus('Please enter an image URL', 'error');
        return;
      }

      if (type === 'video' && !videoUrl) {
        showStatus('Please enter a video URL', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/save-avatar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: currentEditId,
            name: name,
            type: type,
            image_url: imageUrl,
            video_url: videoUrl,
            position: position,
            scale: scale,
            opacity: opacity,
            gender: gender,
            voice: voice
          })
        });

        const result = await response.json();

        if (result.success) {
          showStatus('Avatar saved successfully!', 'success');
          closeModal();
          loadAvatars();
        } else {
          showStatus(result.error || 'Failed to save', 'error');
        }
      } catch (error) {
        showStatus('Error saving avatar: ' + error.message, 'error');
      }
    }

    async function toggleActive(id) {
      try {
        const response = await fetch(`${API_BASE}/set-active-avatar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });

        const result = await response.json();

        if (result.success) {
          loadAvatars();
        }
      } catch (error) {
        showStatus('Error setting active avatar: ' + error.message, 'error');
      }
    }

    async function editAvatar(id) {
      try {
        const response = await fetch(`${API_BASE}/get-avatar-library`);
        const data = await response.json();

        if (!data.success) {
          showStatus('Failed to load library', 'error');
          return;
        }

        const avatar = data.avatars.find(x => x.id === id);

        if (!avatar) {
          showStatus('Avatar not found', 'error');
          return;
        }

        // Populate modal with existing data
        currentEditId = id;
        document.getElementById('modalTitle').textContent = 'Edit Avatar';
        document.getElementById('avatarName').value = avatar.name;
        document.querySelector(`input[name="avatarType"][value="${avatar.type}"]`).checked = true;
        document.getElementById('avatarImageUrl').value = avatar.image_url || '';
        document.getElementById('avatarVideoUrl').value = avatar.video_url || '';
        document.getElementById('avatarPosition').value = avatar.position;
        document.getElementById('avatarScale').value = avatar.scale;
        document.getElementById('avatarOpacity').value = avatar.opacity;
        document.getElementById('avatarGender').value = avatar.gender || 'female';
        document.getElementById('avatarVoice').value = avatar.voice || 'en-US-Neural2-F';
        toggleAvatarType();
        document.getElementById('addModal').classList.add('show');
      } catch (error) {
        showStatus('Error loading avatar: ' + error.message, 'error');
      }
    }

    async function deleteAvatar(id) {
      if (!confirm('Delete this avatar?')) return;

      try {
        const response = await fetch(`${API_BASE}/delete-avatar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });

        const result = await response.json();

        if (result.success) {
          showStatus('Avatar deleted!', 'success');
          loadAvatars();
        } else {
          showStatus(result.error || 'Failed to delete', 'error');
        }
      } catch (error) {
        showStatus('Error deleting avatar: ' + error.message, 'error');
      }
    }

    function showStatus(message, type = 'success') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      setTimeout(() => { statusDiv.innerHTML = ''; }, 5000);
    }

    // Preview image URL
    function previewImageUrl() {
      const url = document.getElementById('avatarImageUrl').value.trim();
      const previewContainer = document.getElementById('imagePreviewContainer');
      const previewImg = document.getElementById('imagePreview');
      const previewError = document.getElementById('imagePreviewError');

      if (!url) {
        previewContainer.style.display = 'none';
        return;
      }

      previewContainer.style.display = 'block';
      previewError.style.display = 'none';
      previewImg.style.display = 'none';

      // Test if image loads
      const testImg = new Image();
      testImg.onload = function() {
        previewImg.src = url;
        previewImg.style.display = 'block';
        previewError.style.display = 'none';
      };
      testImg.onerror = function() {
        previewError.textContent = '‚ö†Ô∏è Unable to load image. Check the URL or upload a new file.';
        previewError.style.display = 'block';
        previewImg.style.display = 'none';
      };
      testImg.src = url;
    }

    // File upload functions
    async function uploadImageFile(input) {
      if (!input.files || input.files.length === 0) return;

      const file = input.files[0];
      const statusDiv = document.getElementById('imageUploadStatus');

      // Validate file type
      if (!file.type.startsWith('image/')) {
        statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå Please select an image file</span>';
        return;
      }

      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå File too large (max 10MB)</span>';
        return;
      }

      try {
        statusDiv.innerHTML = '<span style="color: #3b82f6;">‚è≥ Uploading to Google Drive...</span>';

        const formData = new FormData();
        formData.append('file', file);

        console.log('Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);

        const response = await fetch(`${API_BASE}/upload-avatar-file`, {
          method: 'POST',
          body: formData
        });

        console.log('Upload response status:', response.status);
        const result = await response.json();
        console.log('Upload result:', result);

        if (result.success) {
          document.getElementById('avatarImageUrl').value = result.url;
          statusDiv.innerHTML = '<span style="color: #22c55e;">‚úì Upload successful!</span>';
          previewImageUrl(); // Auto-preview the uploaded image
          setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
        } else {
          statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå Upload failed: ${result.error}</span>`;
          console.error('Upload failed:', result.error);
        }
      } catch (error) {
        statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå Upload error: ${error.message}</span>`;
        console.error('Upload error:', error);
      }
    }

    async function uploadVideoFile(input) {
      if (!input.files || input.files.length === 0) return;

      const file = input.files[0];
      const statusDiv = document.getElementById('videoUploadStatus');

      // Validate file type
      if (!file.type.startsWith('video/')) {
        statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå Please select a video file</span>';
        return;
      }

      // Validate file size (max 50MB)
      if (file.size > 50 * 1024 * 1024) {
        statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå File too large (max 50MB)</span>';
        return;
      }

      try {
        statusDiv.innerHTML = '<span style="color: #3b82f6;">‚è≥ Uploading to Google Drive...</span>';

        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`${API_BASE}/upload-avatar-file`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          document.getElementById('avatarVideoUrl').value = result.url;
          statusDiv.innerHTML = '<span style="color: #22c55e;">‚úì Upload successful!</span>';
          setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
        } else {
          statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå Upload failed: ${result.error}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå Upload error: ${error.message}</span>`;
      }
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadAvatars);
  </script>
</body>
</html>


