<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Intro/Outro Manager - MSS</title>
  <style>
    /* Neon activity bar */
    #ioActivityBar { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 3000; display: none; }
    #ioActivityBar .track { width: 100%; height: 100%; background: linear-gradient(90deg,#22c55e,#3b82f6,#22c55e); background-size: 300% 100%; animation: ioSlide 1.2s linear infinite, ioGlow 1.6s ease-in-out infinite alternate; box-shadow: 0 0 12px rgba(59,130,246,.6); }
    @keyframes ioSlide { 0% { background-position: 0 0; } 100% { background-position: 300% 0; } }
    @keyframes ioGlow { from { box-shadow: 0 0 8px rgba(34,197,94,.7); } to { box-shadow: 0 0 16px rgba(59,130,246,.8); } }
    #ioActivityMsg { position: fixed; top: 6px; right: 12px; color: #94a3b8; font-size: 12px; z-index: 3001; display: none; }
  </style>
  <style>
    body {
      font-family: Inter, Arial, sans-serif;
      background: #0B0F19;
      color: #E8EBFF;
      margin: 0;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    h2 { color: #E8EBFF; margin-bottom: 10px; }
    .subtitle { color: #A8B3CF; margin-bottom: 30px; font-size: 14px; }

    .panel {
      background: #121826;
      border: 1px solid #2a3550;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .panel h3 {
      margin-top: 0;
      color: #3b82f6;
      font-size: 16px;
      border-bottom: 1px solid #2a3550;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .card {
      background: #0f1419;
      border: 2px solid #2a3550;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .card:hover {
      border-color: #3b82f6;
      transform: translateY(-2px);
    }

    .card.selected {
      border-color: #22c55e;
      background: #14532d;
    }

    .card-title {
      font-weight: 600;
      font-size: 14px;
      color: #E8EBFF;
      margin-bottom: 10px;
    }

    .card.selected .card-title {
      color: #22c55e;
    }

    .card-preview {
      background: #000;
      border-radius: 4px;
      padding: 20px;
      margin-bottom: 10px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #64748b;
      text-align: center;
    }

    .card-duration {
      color: #64748b;
      font-size: 12px;
      margin-bottom: 8px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .card-actions button {
      flex: 1;
      padding: 6px;
      font-size: 12px;
    }

    button {
      padding: 12px 24px;
      border-radius: 6px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover { background: #1d4ed8; }

    .button-secondary {
      background: #334;
    }

    .button-secondary:hover {
      background: #445;
    }

    .button-success {
      background: #22c55e;
    }

    .button-success:hover {
      background: #16a34a;
    }

    .button-danger {
      background: #dc2626;
    }

    .button-danger:hover {
      background: #b91c1c;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: #94a3b8;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      background: #0f1419;
      border: 1px solid #2a3550;
      border-radius: 6px;
      color: #E8EBFF;
      font-size: 14px;
      font-family: Inter, Arial, sans-serif;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      background: #1e293b;
      border-left: 4px solid #3b82f6;
    }

    .status.error {
      background: #7f1d1d;
      border-left-color: #dc2626;
    }

    .status.success {
      background: #14532d;
      border-left-color: #22c55e;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      background: #1e3a8a;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge.active {
      background: #22c55e;
      color: #000;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #121826;
      border: 1px solid #2a3550;
      border-radius: 10px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 18px;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 20px;
    }

    .preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .preview-modal.show {
      display: flex;
    }

    .preview-container {
      background: #121826;
      border: 1px solid #2a3550;
      border-radius: 10px;
      padding: 30px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .preview-frame {
      width: 100%;
      height: 500px;
      background: #000;
      border-radius: 8px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .preview-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 8px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 400;
    }

    .radio-group input[type="radio"] {
      width: auto;
      cursor: pointer;
    }

    .help-text {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="version.js" defer></script>
</head>
<body>
<div id="ioActivityBar"><div class="track"></div></div>
<div id="ioActivityMsg"></div>
  <script>
    (function(){
      const group = document.querySelector("div[style*='gap: 10px']");
      if (group && !group.querySelector('[data-nav-studio]')) {
        const studio = document.createElement('button');
        studio.setAttribute('data-nav-studio','1');
        studio.textContent = 'Studio';
        studio.style.padding = '8px 16px'; studio.style.margin = '0';
        studio.onclick = () => { window.location.href = 'studio.html'; };
        group.prepend(studio);
        const viewer = document.createElement('button');
        viewer.textContent = 'Viewer';
        viewer.style.padding = '8px 16px'; viewer.style.margin = '0';
        viewer.onclick = () => { window.location.href = 'viewer.html'; };
        group.prepend(viewer);
      }
    })();
</script>

<!-- Quick action: convert active intro/outro to standard video -->
<div id="convertActiveBar" style="position:fixed; right:20px; bottom:20px; z-index:2000;">
  <button type=\"button\" id=\"convertActiveBtn\" style="padding:10px 14px; background:#22c55e; border:1px solid #22c55e; border-radius:8px; color:#0B0F19; font-weight:700; cursor:pointer;">Convert Active to Standard</button>
  <span id="convertActiveStatus" style="margin-left:10px; color:#94a3b8;"></span>
</div>
<script>
  (function(){
    const btn = document.getElementById('convertActiveBtn');
    const status = document.getElementById('convertActiveStatus');
    btn?.addEventListener('click', async () => {
      status.textContent = ' Converting...';
      try {
        const r = await fetch(`${location.origin}/convert-active-intro-outro`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ set_active: true })
        });
        const j = await r.json();
        if (j.success) {
          status.textContent = '  Converted';
          setTimeout(()=>location.reload(), 800);
        } else {
          status.textContent = '  ' + (j.error || 'Failed');
        }
      } catch (e) {
        status.textContent = '  ' + e.message;
      }
    });
  })();
</script>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h2 style="margin: 0;">Intro/Outro Manager <span style="font-size:14px; color:#64748b; font-weight:400;">v5.5.4</span></h2>
    <button onclick="window.location.href='studio.html'" style="background:#3b82f6; border-color:#3b82f6; padding: 8px 16px; margin: 0;" data-nav-studio="1">Studio</button>
  </div>
  <p class="subtitle">Manage your video intros and outros. Click on a card to select it as active (the active intro/outro will be used in your videos).</p>

  <!-- Intros Section -->
  <div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;">Intros</h3>
      <div style="display: flex; gap: 8px;">
        <button onclick="document.getElementById('introFilePickerInput').click()" style="padding: 8px 16px; margin: 0;"> Upload Intro</button>
        <button onclick="openAddModal('intro')" class="button-secondary" style="padding: 8px 16px; margin: 0;"> Create Custom</button>
      </div>
    </div>

    <input type="file" id="introFilePickerInput" accept="video/mp4,video/quicktime" style="display: none;" onchange="handleQuickUpload('intro', this)">

    <div class="grid" id="introGrid">
      <!-- Intros will be loaded here -->
    </div>
  </div>

  <!-- Outros Section -->
  <div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;"> Outros</h3>
      <div style="display: flex; gap: 8px;">
        <button onclick="document.getElementById('outroFilePickerInput').click()" style="padding: 8px 16px; margin: 0;"> Upload Outro</button>
        <button onclick="openAddModal('outro')" class="button-secondary" style="padding: 8px 16px; margin: 0;"> Create Custom</button>
      </div>
    </div>

    <input type="file" id="outroFilePickerInput" accept="video/mp4,video/quicktime" style="display: none;" onchange="handleQuickUpload('outro', this)">

    <div class="grid" id="outroGrid">
      <!-- Outros will be loaded here -->
    </div>
  </div>

  <div id="status"></div>

  <!-- Preview Modal -->
  <div id="previewModal" class="preview-modal">
    <div class="preview-container">
      <div class="modal-header" id="previewTitle">Preview</div>

      <div class="preview-frame" id="previewFrame">
        <!-- HTML content will be injected here -->
      </div>

      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
        <button onclick="playPreview()" class="button-success" style="flex: 1;"> Play</button>
        <button onclick="stopPreview()" class="button-danger" style="flex: 1;"> Stop</button>
        <div id="previewTimer" style="color: #94a3b8; font-size: 14px; min-width: 60px; text-align: center;">0.0s</div>
      </div>

      <div id="audioStatus" style="color: #94a3b8; font-size: 13px; margin-bottom: 15px; text-align: center;">
        <!-- Audio status will be shown here -->
      </div>

      <button onclick="closePreview()" class="button-secondary" style="width: 100%;">Close</button>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">Add Intro</div>

      <div class="form-group">
        <label for="itemName">Name</label>
        <input type="text" id="itemName" placeholder="e.g., Default Brand Intro">
      </div>

      <div class="form-group">
        <label>Type</label>
        <div class="radio-group">
          <label>
            <input type="radio" name="introOutroType" value="html" checked onchange="toggleIntroOutroType()">
            HTML Animation
          </label>
          <label>
            <input type="radio" name="introOutroType" value="video" onchange="toggleIntroOutroType()">
            Video File
          </label>
        </div>
        <div class="help-text">Choose between HTML-based animation or uploaded video file</div>
      </div>

      <!-- HTML-based fields -->
      <div id="htmlFields">
        <div class="form-group">
          <label for="itemDuration">Duration (seconds)</label>
          <input type="number" id="itemDuration" value="3" min="1" max="10" step="0.5">
        </div>

        <div class="form-group">
          <label for="itemHtml">HTML Content</label>
          <textarea id="itemHtml" placeholder="Enter HTML for your intro/outro..."></textarea>
        </div>

        <div class="form-group">
          <label for="itemAudio">Audio Text (optional - will be converted to speech)</label>
          <textarea id="itemAudio" placeholder="e.g., Welcome to Many Sources Say..."></textarea>
          <div style="font-size:12px; color:#94a3b8; margin-top:4px;">Leave empty for silent intro/outro. Text will be converted to speech using Google TTS.</div>
        </div>
      </div>

      <!-- Video file upload field -->
      <div id="videoFields" style="display: none;">
        <div class="form-group">
          <label>Video File</label>
          <div style="display: flex; gap: 10px; margin-bottom: 8px;">
            <input type="text" id="videoUrl" placeholder="Video will appear here after upload" readonly style="flex: 1;">
            <button type="button" onclick="document.getElementById('videoFileInput').click()" style="padding: 10px 16px; margin: 0;"> Upload Video</button>
          </div>
          <input type="file" id="videoFileInput" accept="video/mp4,video/quicktime" style="display: none;" onchange="uploadVideoFile(this)">
          <div class="help-text">Upload MP4 or MOV video file (max 50MB, recommended 3-5 seconds)</div>
          <div id="videoUploadStatus" style="font-size: 12px; margin-top: 4px;"></div>

          <!-- Video Preview -->
          <div id="videoPreviewContainer" style="display: none; margin-top: 10px; padding: 10px; background: #000; border-radius: 6px; text-align: center;">
            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">Preview:</div>
            <video id="videoPreview" controls style="max-width: 100%; max-height: 300px; border-radius: 4px;"></video>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button onclick="closeModal()" class="button-secondary">Cancel</button>
        <button onclick="saveItem()" class="button-success">Save</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentType = 'intro'; // 'intro' or 'outro'
    let currentEditId = null;

    // Load intros and outros on page load
    async function loadItems() {
      try {
        const response = await fetch(`${API_BASE}/get-intro-outro-library`);
        const data = await response.json();

        if (data.success) {
          renderIntros(data.intros || []);
          renderOutros(data.outros || []);
        }
      } catch (error) {
        console.error('Error loading items:', error);
        showStatus('Failed to load intro/outro library', 'error');
      }
    }

    function renderIntros(intros) {
      const grid = document.getElementById('introGrid');

      if (intros.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#64748b; padding:40px;">No intros yet. Click "+ Add Intro" to create one.</div>';
        return;
      }

      grid.innerHTML = intros.map((intro, idx) => `
        <div class="card ${intro.active ? 'selected' : ''}" onclick="toggleActive('intro', '${intro.id}')">
          <div class="card-title">
            ${intro.name}
            ${intro.active ? '<span class="badge active">ACTIVE</span>' : ''}
            ${intro.videoUrl ? ' <span class="badge" style="background:#7c3aed;">VIDEO</span>' : ''}
          </div>
          <div class="card-duration">Duration: ${intro.duration}s</div>
          <div class="card-preview">
            ${intro.videoUrl ? `<video src="${intro.videoUrl}" style="width:100%;max-height:120px;border-radius:4px;"></video>` :
              intro.html ? 'HTML Animation' : 'No content'}
          </div>
          <div class="card-actions">
            <button onclick="event.stopPropagation(); previewItem('intro', '${intro.id}')" style="background: #7c3aed;"> Preview</button>
            <button onclick="event.stopPropagation(); editItem('intro', '${intro.id}')" class="button-secondary">Edit</button>
            <button onclick="event.stopPropagation(); deleteItem('intro', '${intro.id}')" class="button-danger">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function renderOutros(outros) {
      const grid = document.getElementById('outroGrid');

      if (outros.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#64748b; padding:40px;">No outros yet. Click "+ Add Outro" to create one.</div>';
        return;
      }

      grid.innerHTML = outros.map((outro, idx) => `
        <div class="card ${outro.active ? 'selected' : ''}" onclick="toggleActive('outro', '${outro.id}')">
          <div class="card-title">
            ${outro.name}
            ${outro.active ? '<span class="badge active">ACTIVE</span>' : ''}
            ${outro.videoUrl ? ' <span class="badge" style="background:#7c3aed;">VIDEO</span>' : ''}
          </div>
          <div class="card-duration">Duration: ${outro.duration}s</div>
          <div class="card-preview">
            ${outro.videoUrl ? `<video src="${outro.videoUrl}" style="width:100%;max-height:120px;border-radius:4px;"></video>` :
              outro.html ? 'HTML Animation' : 'No content'}
          </div>
          <div class="card-actions">
            <button onclick="event.stopPropagation(); previewItem('outro', '${outro.id}')" style="background: #7c3aed;"> Preview</button>
            <button onclick="event.stopPropagation(); editItem('outro', '${outro.id}')" class="button-secondary">Edit</button>
            <button onclick="event.stopPropagation(); deleteItem('outro', '${outro.id}')" class="button-danger">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function toggleIntroOutroType() {
      const type = document.querySelector('input[name="introOutroType"]:checked').value;
      document.getElementById('htmlFields').style.display = type === 'html' ? 'block' : 'none';
      document.getElementById('videoFields').style.display = type === 'video' ? 'block' : 'none';
    }

    async function handleQuickUpload(type, input) {
      if (!input.files || input.files.length === 0) return;

      const file = input.files[0];

      // Validate file type
      if (!file.type.startsWith('video/')) {
        showStatus('Please select a video file', 'error');
        input.value = ''; // Reset input
        return;
      }

      // Validate file size (max 50MB)
      if (file.size > 50 * 1024 * 1024) {
        showStatus('File too large (max 50MB)', 'error');
        input.value = ''; // Reset input
        return;
      }

      try {
        showStatus(` Uploading ${type}... This may take a moment...`, 'info');

        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`${API_BASE}/upload-intro-outro-file`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          // Create a temporary video element to get duration
          const video = document.createElement('video');
          video.src = result.url;

          video.addEventListener('loadedmetadata', async () => {
            const duration = video.duration || 3;

            // Auto-save with default name
            const name = `${type.charAt(0).toUpperCase() + type.slice(1)} - ${file.name}`;

            const saveResponse = await fetch(`${API_BASE}/save-intro-outro`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                type: type,
                name: name,
                duration: duration,
                html: '',
                audio: '',
                videoUrl: result.url,
                itemType: 'video'
              })
            });

            const saveResult = await saveResponse.json();

            if (saveResult.success) {
              showStatus(` ${type.charAt(0).toUpperCase() + type.slice(1)} uploaded and saved successfully!`, 'success');
              loadItems();
            } else {
              showStatus(saveResult.error || 'Failed to save', 'error');
            }

            // Reset input
            input.value = '';
          });
        } else {
          showStatus(`Upload failed: ${result.error}`, 'error');
          input.value = '';
        }
      } catch (error) {
        showStatus(`Upload error: ${error.message}`, 'error');
        input.value = '';
      }
    }

    async function uploadVideoFile(input) {
      if (!input.files || input.files.length === 0) return;

      const file = input.files[0];
      const statusDiv = document.getElementById('videoUploadStatus');

      // Validate file type
      if (!file.type.startsWith('video/')) {
        statusDiv.innerHTML = '<span style="color: #dc2626;"> Please select a video file</span>';
        return;
      }

      // Validate file size (max 50MB)
      if (file.size > 50 * 1024 * 1024) {
        statusDiv.innerHTML = '<span style="color: #dc2626;"> File too large (max 50MB)</span>';
        return;
      }

      try {
        statusDiv.innerHTML = '<span style="color: #3b82f6;"> Uploading to Google Drive...</span>';

        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`${API_BASE}/upload-intro-outro-file`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          document.getElementById('videoUrl').value = result.url;
          statusDiv.innerHTML = '<span style="color: #22c55e;"> Upload successful!</span>';

          // Show video preview
          const previewContainer = document.getElementById('videoPreviewContainer');
          const previewVideo = document.getElementById('videoPreview');
          previewVideo.src = result.url;
          previewContainer.style.display = 'block';

          setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
        } else {
          statusDiv.innerHTML = `<span style="color: #dc2626;"> Upload failed: ${result.error}</span>`;
        }
      } catch (error) {
        statusDiv.innerHTML = `<span style="color: #dc2626;"> Upload error: ${error.message}</span>`;
      }
    }

    function openAddModal(type) {
      currentType = type;
      currentEditId = null;
      document.getElementById('modalTitle').textContent = `Add ${type === 'intro' ? 'Intro' : 'Outro'}`;
      document.getElementById('itemName').value = '';
      document.querySelector('input[name="introOutroType"][value="html"]').checked = true;
      document.getElementById('itemDuration').value = '3';
      document.getElementById('itemHtml').value = getDefaultHtml(type);
      document.getElementById('itemAudio').value = type === 'intro' ? 'Welcome to Many Sources Say' : 'Thanks for watching Many Sources Say';
      document.getElementById('videoUrl').value = '';
      document.getElementById('videoPreviewContainer').style.display = 'none';
      toggleIntroOutroType();
      document.getElementById('addModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('addModal').classList.remove('show');
    }

    function getDefaultHtml(type) {
      if (type === 'intro') {
        return `<div style='width:100%;height:100%;background:linear-gradient(135deg, #0B0F19 0%, #1a2332 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;'>
  <div style='font-family:Inter,Arial,sans-serif;font-size:96px;font-weight:900;color:#FFD700;text-shadow:0 6px 20px rgba(255,215,0,.5);margin-bottom:20px;'>MANY SOURCES SAY</div>
  <div style='font-family:Inter,Arial,sans-serif;font-size:32px;font-weight:400;color:#94a3b8;font-style:italic;'>Because one source is NEVER enough</div>
</div>`;
      } else {
        return `<div style='width:100%;height:100%;background:linear-gradient(135deg, #0B0F19 0%, #1a2332 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;'>
  <div style='font-family:Inter,Arial,sans-serif;font-size:72px;font-weight:900;color:#FFD700;text-shadow:0 6px 20px rgba(255,215,0,.5);margin-bottom:30px;'>THANKS FOR WATCHING!</div>
  <div style='font-family:Inter,Arial,sans-serif;font-size:48px;font-weight:700;color:#E8EBFF;margin-bottom:15px;'>MANY SOURCES SAY</div>
  <div style='font-family:Inter,Arial,sans-serif;font-size:28px;font-weight:400;color:#94a3b8;'>Subscribe for more insights</div>
</div>`;
      }
    }

    async function saveItem() {
      const name = document.getElementById('itemName').value.trim();
      const itemType = document.querySelector('input[name="introOutroType"]:checked').value;

      if (!name) {
        showStatus('Please enter a name', 'error');
        return;
      }

      let duration, html, audio, videoUrl;

      if (itemType === 'html') {
        duration = parseFloat(document.getElementById('itemDuration').value);
        html = document.getElementById('itemHtml').value.trim();
        audio = document.getElementById('itemAudio').value.trim();

        if (!html) {
          showStatus('Please enter HTML content', 'error');
          return;
        }
      } else {
        // Video file type
        videoUrl = document.getElementById('videoUrl').value.trim();

        if (!videoUrl) {
          showStatus('Please upload a video file', 'error');
          return;
        }

        // Get video duration from the preview element
        const videoPreview = document.getElementById('videoPreview');
        duration = videoPreview.duration || 3;
      }

      try {
        const response = await fetch(`${API_BASE}/save-intro-outro`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: currentType,
            id: currentEditId,
            name: name,
            duration: duration,
            html: html || '',
            audio: audio || '',
            videoUrl: videoUrl || '',
            itemType: itemType
          })
        });

        const result = await response.json();

        if (result.success) {
          showStatus(`${currentType === 'intro' ? 'Intro' : 'Outro'} saved successfully!`, 'success');
          closeModal();
          loadItems();
        } else {
          showStatus(result.error || 'Failed to save', 'error');
        }
      } catch (error) {
        showStatus('Error saving item: ' + error.message, 'error');
      }
    }

    async function toggleActive(type, id) {
      try {
        const response = await fetch(`${API_BASE}/set-active-intro-outro`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, id })
        });

        const result = await response.json();

        if (result.success) {
          loadItems();
        }
      } catch (error) {
        showStatus('Error setting active item: ' + error.message, 'error');
      }
    }

    async function editItem(type, id) {
      try {
        const response = await fetch(`${API_BASE}/get-intro-outro-library`);
        const data = await response.json();

        if (!data.success) {
          showStatus('Failed to load library', 'error');
          return;
        }

        // Find the item to edit
        const items = type === 'intro' ? data.intros : data.outros;
        const item = items.find(x => x.id === id);

        if (!item) {
          showStatus('Item not found', 'error');
          return;
        }

        // Populate modal with existing data
        currentType = type;
        currentEditId = id;
        document.getElementById('modalTitle').textContent = `Edit ${type === 'intro' ? 'Intro' : 'Outro'}`;
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemDuration').value = item.duration;
        document.getElementById('itemHtml').value = item.html;
        document.getElementById('itemAudio').value = item.audio || '';
        document.getElementById('addModal').classList.add('show');
      } catch (error) {
        showStatus('Error loading item: ' + error.message, 'error');
      }
    }

    async function deleteItem(type, id) {
      if (!confirm(`Delete this ${type}?`)) return;

      try {
        const response = await fetch(`${API_BASE}/delete-intro-outro`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, id })
        });

        const result = await response.json();

        if (result.success) {
          showStatus(`${type === 'intro' ? 'Intro' : 'Outro'} deleted!`, 'success');
          loadItems();
        } else {
          showStatus(result.error || 'Failed to delete', 'error');
        }
      } catch (error) {
        showStatus('Error deleting item: ' + error.message, 'error');
      }
    }

    function showStatus(message, type = 'success') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      setTimeout(() => { statusDiv.innerHTML = ''; }, 5000);
    }

    // Preview functionality
    let previewData = null;
    let previewTimer = null;
    let previewAudio = null;
    let previewStartTime = 0;

    async function previewItem(type, id) {
      try {
        const response = await fetch(`${API_BASE}/get-intro-outro-library`);
        const data = await response.json();

        if (!data.success) {
          showStatus('Failed to load library', 'error');
          return;
        }

        const items = type === 'intro' ? data.intros : data.outros;
        const item = items.find(x => x.id === id);

        if (!item) {
          showStatus('Item not found', 'error');
          return;
        }

        previewData = item;
        document.getElementById('previewTitle').textContent = `Preview: ${item.name}`;
        document.getElementById('previewFrame').innerHTML = item.html;
        document.getElementById('previewTimer').textContent = '0.0s';
        document.getElementById('audioStatus').textContent = item.audio ? ` Audio: "${item.audio.substring(0, 50)}..."` : ' No audio';
        document.getElementById('previewModal').classList.add('show');

      } catch (error) {
        showStatus('Error loading preview: ' + error.message, 'error');
      }
    }

    function closePreview() {
      stopPreview();
      document.getElementById('previewModal').classList.remove('show');
      previewData = null;
    }

    async function playPreview() {
      if (!previewData) return;

      // Stop any existing preview
      stopPreview();

      // Start timer
      previewStartTime = Date.now();
      const duration = previewData.duration * 1000; // Convert to ms

      previewTimer = setInterval(() => {
        const elapsed = (Date.now() - previewStartTime) / 1000;
        document.getElementById('previewTimer').textContent = elapsed.toFixed(1) + 's';

        if (elapsed >= previewData.duration) {
          stopPreview();
        }
      }, 100);

      // Play audio if available
      if (previewData.audio) {
        try {
          // Generate TTS audio preview
          document.getElementById('audioStatus').textContent = ' Generating audio preview...';

          const response = await fetch(`${API_BASE}/preview-tts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: previewData.audio })
          });

          const result = await response.json();

          if (result.success && result.audio_url) {
            previewAudio = new Audio(result.audio_url);
            previewAudio.play();
            document.getElementById('audioStatus').textContent = ` Playing audio...`;
          } else {
            document.getElementById('audioStatus').textContent = '  Audio generation failed';
          }
        } catch (error) {
          console.error('Audio preview error:', error);
          document.getElementById('audioStatus').textContent = '  Audio preview error';
        }
      }
    }

    function stopPreview() {
      if (previewTimer) {
        clearInterval(previewTimer);
        previewTimer = null;
      }

      if (previewAudio) {
        previewAudio.pause();
        previewAudio = null;
      }

      document.getElementById('previewTimer').textContent = '0.0s';

      if (previewData && previewData.audio) {
        document.getElementById('audioStatus').textContent = ` Audio: "${previewData.audio.substring(0, 50)}..."`;
      }
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadItems);
  </script>
</body>
</html>


